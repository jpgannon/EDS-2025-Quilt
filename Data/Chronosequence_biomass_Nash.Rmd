---
title: "Downednotdead_2.7.23"
author: "Joe Nash"
date: "2023-02-08"
output: html_document
---

###Install and load packages
```{r}
requiredPackages = c('knitr','tidyr', "lme4", "lmerTest", "afex", "dplyr", "tidyverse", "stargazer", "car", "extrafont", 'ggplot2', 'grid', 'ggpattern', 'vegan', 'ggrepel', 'nortest', 'kSamples')
for(p in requiredPackages){
  if(!require(p,character.only = TRUE)) install.packages(p)
  library(p,character.only = TRUE)
}
```

###R Packages citations
```{r}
citation("knitr")
citation("dplyr")
citation("ggplot2")
citation("nlme")
citation("tidyr")
citation("vegan")
citation("lmerTest")
citation("nortest")
```


###Load CWD data
```{r}
coarse<- read.csv("chronosequence_cwd.csv")
###Re-name columns
colnames(coarse) <-c("year", "stand", "age", "cluster", "az", "spp", "dc", "diamint", "diaml", "diams", "avgdiam", "length") 
###Make factors
coarse$spp <- as.factor(coarse$spp)
```

###CWD volume calculations
```{r}
###Square Diameters
coarse$diamintsq <- coarse$diamint^2
coarse$diamlsq <- coarse$diaml^2
coarse$diamssq <- coarse$diams^2
###Calculate DBH class
coarse$dbhclass.int <- 2*round((coarse$diamint)/2)
coarse$dbhclass.large <- 2*round((coarse$diaml)/2)
###Calculate volume (m3) per piece of CWD
coarse$piecevol <- ((pi/8)*(coarse$diamssq + coarse$diamlsq)*(coarse$length))/10000
###Replace NaN with O
coarse$piecevol[is.nan(coarse$piecevol)] <- 0
###Volume of each piece/piece length
coarse$piecevl <- coarse$piecevol/coarse$length
###Replace NaN with O
coarse$piecevl[is.nan(coarse$piecevl)] <- 0
###Separate into years
twenty <- coarse[coarse$year == "2020",] 
ohfour <- coarse[coarse$year == "2004",]
###Transect lengths (m)
cwdtrans <- 20
###CWD Volume calculations
###Subset old growth stands
twenty.og <- twenty[which(twenty$stand == "Bowl"| twenty$stand == "Pond"),]
###Sum vol for each transect of each cluster at OG stands
twentyvoltran.og <- twenty.og %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclust.og <- twentyvoltran.og %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each stand
twentyvolstand.og <- twentyvolclust.og %>%
  group_by(stand, age, year) %>%
  summarise(avgstandvol = sum(avgclustvol)/4)
###Subset "normal" stands
twenty.normies <- twenty[which(twenty$stand == "H2"| twenty$stand == "H3"| twenty$stand == "H4"| twenty$stand == "H5"| 
                                 twenty$stand == "H6"| twenty$stand == "M3"| twenty$stand == "M4"| twenty$stand == "M5"|twenty$stand == "M6"| twenty$stand == "T30"|twenty$stand == "HB101"),]
ohfour.normies <- ohfour[which(ohfour$stand == "C2"|ohfour$stand == "H2"| ohfour$stand == "H3"| ohfour$stand == "H4"| ohfour$stand == "H5"| 
                                 ohfour$stand == "H6"| ohfour$stand == "M3"| ohfour$stand == "M4"| ohfour$stand == "M5"|ohfour$stand == "M6"|ohfour$stand == "T30"| ohfour$stand == "HB101"),]
###Sum vol for each transect of each cluster at each "normal" stand
###2020
twentyvoltran.normies <- twenty.normies %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclust.normies <- twentyvoltran.normies %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each stand
twentyvolstand.normies <- twentyvolclust.normies %>%
    group_by(stand, age, year) %>%
  summarise(avgstandvol = sum(avgclustvol)/3)


###2004
ohfourvoltran.normies <- ohfour.normies %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
ohfourvolclust.normies <- ohfourvoltran.normies %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each "normal" stand
ohfourvolstand.normies <- ohfourvolclust.normies %>%
  group_by(stand, age, year) %>%
  summarise(avgstandvol = mean(avgclustvol))

###Odd balls = CC2, H1, T20 
###CC2: AB, BC, CD, DA, EF, GH
twenty.cc2 <- twenty[which(twenty$stand == "CC2"),]
ohfour.cc2.h1 <- ohfour[which(ohfour$stand == "CC2"|ohfour$stand == "H1"),]
###Sum vol for each transect of each "cluster" at CC2
###2020
twentyvoltran.cc2 <- twenty.cc2 %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclust.cc2 <- twentyvoltran.cc2 %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for CC2
twentyvolstand.cc2 <- twentyvolclust.cc2 %>%
  group_by(stand, age, year) %>%
  summarise(avgstandvol = sum(avgclustvol)/6)
###2004
ohfourvoltran.cc2.h1 <- ohfour.cc2.h1 %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
ohfourvolclust.cc2.h1 <- ohfourvoltran.cc2.h1 %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for CC2
ohfourvolstand.cc2.h1 <- ohfourvolclust.cc2.h1 %>%
  group_by(stand, age, year) %>%
  summarise(avgstandvol = sum(avgclustvol)/6)
###T20: AB, BC, CD, CE, DA, DF, GH, GI
twenty.t20 <- twenty[which(twenty$stand == "T20"),]
ohfour.t20 <- ohfour[which(ohfour$stand == "T20"),]
###Sum vol for each transect of each cluster at T20
###2020
twentyvoltran.t20 <- twenty.t20 %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclust.t20 <- twentyvoltran.t20 %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for T20
twentyvolstand.t20 <- twentyvolclust.t20 %>%
  group_by(stand, age, year) %>%
  summarise(avgstandvol = sum(avgclustvol)/8)
###2004
ohfourvoltran.t20 <- ohfour.t20 %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
ohfourvolclust.t20 <- ohfourvoltran.t20 %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for T20
ohfourvolstand.t20 <- ohfourvolclust.t20 %>%
  group_by(stand, age, year) %>%
  summarise(avgstandvol = sum(avgclustvol)/8)
###Combine all stands again
###2020
twentyvolstand <- rbind(twentyvolstand.normies, twentyvolstand.cc2, twentyvolstand.t20, twentyvolstand.og)
###2004
ohfourvolstand <- rbind(ohfourvolstand.normies, ohfourvolstand.cc2.h1, ohfourvolstand.t20)
avgvol0420<- union(twentyvolstand, ohfourvolstand)
###Removing OG stands
avgvol0420_noog <- avgvol0420[-which(avgvol0420$stand == "Bowl"| avgvol0420$stand == "Pond"),]
avgvol0420_noog$stand <- factor(avgvol0420_noog$stand, levels = c("CC2", "C2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3"))

###Calculate SE of CWD volume (m3/ha) in each stand
###OG
###2020
twentyvol_se.og <- twentyvoltran.og %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranvol)/sqrt(12))
###Normies
###2020
twentyvol_se.normies <- twentyvoltran.normies %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranvol)/sqrt(9))
###2004
ohfourvol_se.normies <- ohfourvoltran.normies %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranvol)/sqrt(9))
###CC2
###2020
twentyvol_se.cc2 <- twentyvoltran.cc2 %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranvol)/sqrt(6))
###2004
ohfourvol_se.cc2.h1 <- ohfourvoltran.cc2.h1 %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranvol)/sqrt(6))
###T20
###2020
twentyvol_se.t20 <- twentyvoltran.t20 %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranvol)/sqrt(8))
###2004
ohfourvol_se.t20 <- ohfourvoltran.t20 %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranvol)/sqrt(8))
###Combine all stands
###2020
twentyvol_se <- rbind(twentyvol_se.og, twentyvol_se.normies, twentyvol_se.cc2, twentyvol_se.t20)
###2004
ohfourvol_se <- rbind(ohfourvol_se.normies, ohfourvol_se.cc2.h1, ohfourvol_se.t20)
###Combine both years
volse <- rbind(twentyvol_se, ohfourvol_se)
###Combine CWD vol and SE
cwd_vol_se <- left_join(avgvol0420,volse, by = c("stand", "age", "year"))
colnames(cwd_vol_se) <- c("stand", "age", "year", "cwdvol", "cwdse")
cwd_vol_se$stand <- factor(cwd_vol_se$stand, levels = c("CC2", "C2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))
###Combine CWD vol and SE -- No OG stands
cwd_vol_se_noog <- left_join(avgvol0420_noog,volse, by = c("stand", "age", "year"))
cwd_vol_se_noog$stand <- factor(cwd_vol_se_noog$stand, levels = c("CC2", "C2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3"))
colnames(cwd_vol_se_noog) <- c("stand", "age", "year", "cwdvol", "cwdse")
cwd_vol_se_noog$age <- as.numeric(cwd_vol_se_noog$age)
```

###CWD volume data with species and decay class
##Volume calculations with species 
```{r}
###Sum vol for each transect of each cluster at OG stands
twentyvoltransppdc.og <- twenty.og %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclustsppdc.og <- twentyvoltransppdc.og %>%
  group_by(stand, age, year, cluster, spp, dc) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each stand
twentyvolstandsppdc.og <- twentyvolclustsppdc.og %>%
  group_by(stand, age, year, spp, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/4)
###Sum vol for each transect of each cluster at each "normal" stand
###2020
twentyvoltransppdc.normies <- twenty.normies %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclustsppdc.normies <- twentyvoltransppdc.normies %>%
  group_by(stand, age, year, cluster, spp, dc) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each stand
twentyvolstandsppdc.normies <- twentyvolclustsppdc.normies %>%
  group_by(stand, age, year, spp, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/3)

###2004
ohfourvoltransppdc.normies <- ohfour.normies %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
ohfourvolclustsppdc.normies <- ohfourvoltransppdc.normies %>%
  group_by(stand, age, year, cluster, spp, dc) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each "normal" stand
ohfourvolstandsppdc.normies <- ohfourvolclustsppdc.normies %>%
  group_by(stand, age, year, spp, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/3)

###Sum vol for each transect of each "cluster" at CC2
###2020
twentyvoltransppdc.cc2 <- twenty.cc2 %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclustsppdc.cc2 <- twentyvoltransppdc.cc2 %>%
  group_by(stand, age, year, cluster, spp, dc) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for CC2
twentyvolstandsppdc.cc2 <- twentyvolclustsppdc.cc2 %>%
  group_by(stand, age, year, spp, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/6)
###2004
ohfourvoltransppdc.cc2.h1 <- ohfour.cc2.h1 %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
ohfourvolclustsppdc.cc2.h1 <- ohfourvoltransppdc.cc2.h1 %>%
  group_by(stand, age, year, cluster, spp, dc) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for CC2
ohfourvolstandsppdc.cc2.h1 <- ohfourvolclustsppdc.cc2.h1 %>%
  group_by(stand, age, year, spp, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/6)
###Sum vol for each transect of each cluster at T20
###2020
twentyvoltransppdc.t20 <- twenty.t20 %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclustsppdc.t20 <- twentyvoltransppdc.t20 %>%
  group_by(stand, age, year, cluster, spp, dc) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for T20
twentyvolstandsppdc.t20 <- twentyvolclustsppdc.t20 %>%
  group_by(stand, age, year, spp, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/8)
###2004
ohfourvoltransppdc.t20 <- ohfour.t20 %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
ohfourvolclustsppdc.t20 <- ohfourvoltransppdc.t20 %>%
  group_by(stand, age, year, cluster, spp, dc) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for T20
ohfourvolstandsppdc.t20 <- ohfourvolclustsppdc.t20 %>%
  group_by(stand, age, year, spp, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/8)
###Combine all stands again
###2020
twentyvolstandsppdc <- rbind(twentyvolstandsppdc.normies, twentyvolstandsppdc.cc2, twentyvolstandsppdc.t20, twentyvolstandsppdc.og)
###2004
ohfourvolstandsppdc <- rbind(ohfourvolstandsppdc.normies, ohfourvolstandsppdc.cc2.h1, ohfourvolstandsppdc.t20)
###Combine 2004 and 2020 species CWD data 
avgvol0420sppdc<- union(twentyvolstandsppdc, ohfourvolstandsppdc)
###Remove OG stands
avgvol0420sppdc_noog <- avgvol0420sppdc[-which(avgvol0420sppdc$stand == "Bowl"| avgvol0420sppdc$stand == "Pond"),]
###Make stand a factor
avgvol0420sppdc_noog$stand <- factor(avgvol0420sppdc_noog$stand, levels = c("CC2", "C2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3"))
##Make column identified for stand age and make a factor
avgvol0420sppdc_noog$standage <- paste(avgvol0420sppdc_noog$stand, avgvol0420sppdc_noog$age)
avgvol0420sppdc_noog$standage <- factor(avgvol0420sppdc_noog$standage, levels = c("CC2 15", "C2 16", "H6 20", "M6 24", "M5 27", "CC2 31","HB101 34", "H6 36", "H5 37", "M6 40", "M5 43", "T20 46", "HB101 50", "H5 53", "M4 54", "T30 56", "T20 62","H1 65",  "H4 70", "M4 70", "T30 72", "H4 86", "M3 94", "M3 110", "H2 129", "H3 129", "H2 145", "H3 145"))

```


###Figure showing progression of CWD volume (m3/ha) for each stand from 2004 to 2020
```{r}
ggplot(data = cwd_vol_se_noog, aes(x = age, y = cwdvol, group = stand, color = stand)) + 
  geom_point(size = 2) + 
  geom_errorbar(aes(ymin=cwdvol-cwdse, ymax=cwdvol+cwdse), position = position_dodge()) +
  geom_line(size = 1) + 
  labs(x = "stand Age", y = (expression(CWD~volume~(m^3/ha))), color = "stand") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,150)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 150)) + 
 scale_color_discrete() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA))
```

###Combined Federer Chronosequence stands and Old Growth stands (-C2)
```{r}
og_cwd_vol_se <- cwd_vol_se[which(cwd_vol_se$stand == "Bowl"| cwd_vol_se$stand == "Pond"),]
og_cwd_vol_se$age = 180
cwd_fed_og <- rbind(cwd_vol_se_noog, og_cwd_vol_se)
###Organizing stands by age 
cwd_fed_og$stand <- factor(cwd_fed_og$stand, levels = c("CC2", "C2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))
###Take out CC2
cwd_fed_og.noc2 <- cwd_fed_og[-which(cwd_fed_og$stand == "C2"),]
```

###Set colors for each stand based on geography. Nearer stands are more similair in color
###Color Groups:
#Bartlett: H stands and CC2
#Iron Mtn: T30 and M4
#Kancamangus and HB: M6 and HB101
#Ellis River: M3 and M5
#Sawyer River: T20
#OG: Bowl and Pond
```{r}
standcolors <- c(CC2 = "gold4",H6 = "goldenrod",H5 = "goldenrod1",H1 = "gold",H4 = "goldenrod2",H2 = "orange",H3 = "orange3",
                T20 = "lightgreen",
                M4 = "olivedrab",T30 = "olivedrab1",
                M5 = "steelblue",M3 = "navy",
                M6 = "orchid",HB101 = "orchid4",
                Bowl = "red",Pond = "red4")
```

Plot of all stands except C2 (C2 was converted to MELNHE stand in ~2010)
```{r}
ggplot(data = cwd_fed_og.noc2, aes(x = age, y = cwdvol, group = stand, color = stand)) + 
  geom_point( size = 2) + 
  geom_errorbar(aes(color = stand, ymin=cwdvol-cwdse, ymax=cwdvol+cwdse), size = 1.2, position = position_dodge(), show.legend = FALSE) +
  geom_line(size = 1.2, show.legend = TRUE) + 
  labs(x = "stand Age", y = (expression(CWD~volume~(m^3/ha))), color = "stand") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,200)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 155)) + 
  scale_color_manual(values = standcolors) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15, color = "black")) + 
  theme(axis.title.y = element_text(size = 15, color = "black")) + 
  theme(axis.text.x = element_text(size = 15, color = "black")) + 
  theme(axis.text.y = element_text(size = 15, color = "black")) + 
  theme(legend.text = element_text(size = 15, color = "black")) + 
  theme(legend.title = element_text(size = 15, color = "black")) + 
  theme(panel.border = element_rect(fill = NA)) +
  annotation_custom(textGrob("Bowl", gp = gpar(col = "black", fontsize = 15)), xmin = 170, xmax = 170, ymin = 62, ymax = 62 ) + 
  annotation_custom(textGrob("Pond", gp = gpar(col = "black", fontsize = 15)), xmin = 170, xmax = 170, ymin = 45, ymax = 45 ) + 
  annotate("text", x = 160, y = 0, label = "~", size = 5, angle = 90) +
  annotate("text", x = 170, y = 0, label = "~", size = 5, angle = 90) +
  annotation_custom(segmentsGrob(gp = gpar(col = "black", lwd = 1)), xmin = 180, xmax = 180, ymin = 0, ymax = -.80) +
  annotation_custom(textGrob("Uncut", gp = gpar(col = "black", fontsize = 15)), xmin = 180, xmax = 180, ymin = -3, ymax = -3 ) + 
  coord_cartesian(clip = "off")
```

###Regression on Volume for young stands ONLY
```{r}
###Subset young stands
young.cwd <- cwd_fed_og[cwd_fed_og$age == "20"|cwd_fed_og$age == "24"|cwd_fed_og$age == "27"|
                          cwd_fed_og$age == "31"|cwd_fed_og$age == "34"|cwd_fed_og$age == "36"|
                          cwd_fed_og$age == "37"|cwd_fed_og$age == "40"|cwd_fed_og$age == "43"|
                          cwd_fed_og$age == "46"|cwd_fed_og$age == "50",]
young.cwd.lm <- lm(young.cwd$age~young.cwd$cwdvol)
###Extract slope and intercept
cf.young <- coef(young.cwd.lm)
cwd.int.young <- cf.young[1]
cwd.slope.young <- cf.young[2]
ggplot(data = cwd_fed_og, aes(x = age, y = cwdvol, group = stand, color = stand)) + 
  geom_point(size = 2) + 
  geom_errorbar(aes(ymin=cwdvol-cwdse, ymax=cwdvol+cwdse), position = position_dodge()) +
  geom_line(size = 1) + 
  geom_segment(aes(x = 20, xend = 50, y = cwd.int.young + cwd.slope.young, 
                   yend = cwd.int.young + cwd.slope.young*50),size = 1, color = "black", linetype = 2) + 
  annotate("text", x = 34, y = 54, label = paste("R^2 ==", 
                                                         format(summary(young.cwd.lm)$r.squared, digits = 3)), parse = TRUE, size = 4) + 
  labs(x = "stand Age", y = (expression(CWD~volume~(m^3/ha))), color = "stand") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,200)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 150)) + 
  scale_color_discrete() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA)) +
  annotate("text", x = 165, y = 62, label = "Bowl") + 
  annotate("text", x = 165, y = 45, label = "Pond")

```

###Remove H3 large tree blowdown from windstorm
```{r}
cwd_vol_se_noog_out <- cwd_vol_se_noog[-2,]
###Figure showing progression of CWD volume (m3/ha) for each stand from 2004 to 2020 Without H3 blowdown
ggplot(data = cwd_vol_se_noog_out, aes(x = age, y = cwdvol, group = stand, color = stand)) + 
  geom_point(size = 2) + 
  geom_errorbar(aes(ymin=cwdvol-cwdse, ymax=cwdvol+cwdse), position = position_dodge()) +
  geom_line(size = 1) + 
  labs(x = "stand Age", y = (expression(CWD~volume~(m^3/ha))), color = "stand") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,150)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 150)) + 
  scale_color_discrete() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA))

```

###Assign colors to tree species
```{r}
spp.colors <- c("magenta", "lawngreen", "lightgray", "cornflowerblue", "black", "gold", "red", "darkorange","cyan","forestgreen" )
names(spp.colors) <- c("PC", "ASP", "WB", "ASH", "OTHER", "YB", "RM", "SM", "BE", "CON" )
```


###Load CWD density data measured by Marty Acker in 2004
```{r}
###Scale volumes based on average density for each spp and decay class
####Species x decay class densities:
cwd.density.measured <- read.csv("chronosequence_cwd_density.csv")
colnames(cwd.density.measured) <- c("stand", "age.2004", "dc", "spp", "sppcode", "cwdvol", "drymass", "density")

```

###Plot Marty's density by species x decay class
```{r}

ggplot(data = cwd.density.measured, aes(x = dc, y = density, color = spp)) + 
  geom_point() + 
  scale_color_manual(values = spp.colors) + 
  theme_bw()
```


###Density by DC spp as colors
###Points
```{r}
ggplot(data = cwd.density.measured, aes(x = dc, y = density, color = spp)) + 
  geom_point() + 
  scale_color_manual(values = spp.colors) + 
  theme_bw()
```

###Boxplots of Marty's Density by Spp & DC
```{r}
cwd.density.measured$spp.dc <- paste(cwd.density.measured$spp, cwd.density.measured$dc)
ggplot(data = cwd.density.measured, aes(dc, y = density, group = dc)) + 
  geom_boxplot(aes(fill = spp), outlier.shape = NA, show.legend = FALSE) + 
  stat_boxplot(geom = 'errorbar') + 
  stat_summary(fun = mean, geom = "point", shape = 23, size = 3, fill = "white", color = "black")+
  geom_jitter(aes(color = spp), size = 2, show.legend = TRUE) + 
  scale_fill_manual(values = spp.colors) + 
  scale_color_manual(values = spp.colors) + 
  labs(x = "Decay class", y = (expression(Density~(g/cm^3))), color = "Species") + 
  theme_bw() + 
  theme(axis.title = element_text(size = 18)) + 
  theme(legend.text = element_text(size = 18)) + 
  theme(legend.title = element_text(size = 18)) + 
  theme(axis.title.y = element_text(vjust = 3)) +
  theme(axis.title.x = element_text(vjust = -3)) +
  theme(axis.text = element_text(color = "black")) + 
  theme(text = element_text(size = 18)) + 
  theme(plot.margin = unit(c(2,2,2,2), "cm")) + 
  theme(panel.background = element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(1.5, "lines")) + 
  scale_y_continuous(expand = c(0,0), limits = c(0, 0.8))
```


###Calculate mean density (measured) for each spp x decay class
```{r}
cwd.mean.density.measured <- cwd.density.measured %>%
  group_by(dc, spp) %>%
  summarise(mean.density = mean(density))
```
###Plot mean density (measured) for each spp x decay class
```{r}
ggplot(data = cwd.mean.density.measured, aes(x = dc, y = mean.density, color = spp)) + 
  geom_point() + 
  scale_color_manual(values = spp.colors) + 
  theme_bw()
```

###Join volume and measured density data, find gaps in measured density data
```{r}
###Combine all stands with vol for each transect per species x decay class
cwd_vol_transects_sppdc <- rbind(twentyvoltransppdc.og, twentyvoltransppdc.normies, ohfourvoltransppdc.normies, twentyvoltransppdc.cc2, ohfourvoltransppdc.cc2.h1, twentyvoltransppdc.t20, ohfourvoltransppdc.t20) 
  
cwdvol.density.measured <- left_join(cwd_vol_transects_sppdc, cwd.mean.density.measured, by = c("spp", "dc"))
###Identify gaps in density data 
cwdvol.density.measured.na <- cwdvol.density.measured[which(is.na(cwdvol.density.measured$mean.density)),]
##Remove NONE species to identify species and dc classes needed
cwdvol.density.measured.gaps <- cwdvol.density.measured.na[-which(cwdvol.density.measured.na$spp == "NONE"),]
###Table of gaps in density data
table(cwdvol.density.measured.gaps$spp, cwdvol.density.measured.gaps$dc)
```

###ANOVA to determine if measured density is different among stand age, spp, dc
```{r}
cwd.density.measured$spp <- as.factor(cwd.density.measured$spp)
density.measured.model <- lmer(density ~ age.2004+spp+dc + (1|stand), data = cwd.density.measured)
summary(density.measured.model)
anova(density.measured.model)
```
###Age was NOT significant, new model with only spp & dc
```{r}
density.measured.model.2 <- lmer(density ~ spp+dc + (1|stand), data = cwd.density.measured)
summary(density.measured.model.2)
anova(density.measured.model.2)
```


###Using density.measured.model.2 to predict density 
```{r}
cwd.density.measured$predicted = predict(density.measured.model.2)

```


###Gaps filled from prediction of model
```{r}
cwdvol.density.measured.gaps$spp[cwdvol.density.measured.gaps$spp == "ANGIO"] <- "UNK"
cwdvol.density.measured.gaps$spp[cwdvol.density.measured.gaps$spp == "CON"] <- "HEM"
cwdvol.density.measured.gaps$spp[cwdvol.density.measured.gaps$spp == "RS"] <- "SP"
cwdvol.density.measured.gaps$spp[cwdvol.density.measured.gaps$spp == "FIR"] <- "SP"

cwdvol.density.measured.gaps$predicted = predict(density.measured.model.2, newdata = cwdvol.density.measured.gaps, allow.new.levels = TRUE)

```

###Gaps filled using data from Harmon et al. 2008
```{r}
harmon.gaps <- read.csv("Harmon_cwd_density_chronosequence_gaps.csv")
colnames(harmon.gaps) <- c("ID", "spp", "dc", "mean.density", "uncert")
```

###Compare Harmon to predicted
```{r}
density.harmon.predicted <- left_join(harmon.gaps, cwdvol.density.measured.gaps, by = c("spp", "dc"))
density.harmon.predicted <- subset(density.harmon.predicted, predicted != "NA")
density.harmon.predicted$dc <- factor(density.harmon.predicted$dc, 
                                               levels = c("1", "2", "3", "4", "5"))
ggplot(data = density.harmon.predicted) + 
  geom_jitter(aes(x = dc, y = mean.density.x, color = spp, shape = "1"), height = 0.02, width = 0, size = 5) +
  geom_jitter(aes(x = dc, y = predicted, color = spp, shape = "2"), height = 0.02, width = 0, size = 5) +
  scale_color_manual(values = spp.colors) + 
  labs(x = "Decay class", y = (expression(Density~(g/cm^3))), color = "Species", shape = "Data" ) + 
  theme_bw() + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.6)) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA))
```

###XY of Predicted vs Harmon
```{r}
ggplot(data = density.harmon.predicted, aes(x = mean.density.x, y = predicted, color = spp, shape = dc)) + 
  geom_point(size = 5) + 
  labs(x = "Harmon Density", y = "Acker Predicted Density", color = "Species", shape = "Decay Class") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,0.7)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.7)) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA))
```



###t.test to determine if means are different (p = 0.01)
```{r}
t.test(density.harmon.predicted$mean.density.x, density.harmon.predicted$predicted )

```





###Join data from Harmon and chrono
```{r}
cwdvol.density.full <- left_join(cwdvol.density, spp.dc.gaps, by = c("spp", "dc"))
cwdvol.density.full$mean.density.x <- ifelse(is.na(cwdvol.density.full$mean.density.x), cwdvol.density.full$mean.density.y, cwdvol.density.full$mean.density.x)


###1 UNK species DC 1 does not have a density, average across all species dc = 1 and assign this density to it
###Subset data to include only dc = 1
cwdvol.density.full.dc1 <- cwdvol.density.full[cwdvol.density.full$dc == 1,]
###Remove UNK species
cwdvol.density.full.dc1 <- cwdvol.density.full.dc1 [-which(cwdvol.density.full.dc1$spp == "UNK"),]
###Calculate mean density ( = 0.399)
cwdvol.density.full.dc1 %>%
  group_by(dc) %>%
  summarise(avg.density = mean(mean.density.x))
###Assign value to UNK DC 1
##Change NA values to 100 for ease
cwdvol.density.full$mean.density.x[is.na(cwdvol.density.full$mean.density.x)] <- 100
###Change UNK to 0.399
cwdvol.density.full[cwdvol.density.full$spp == "UNK",]["mean.density.x"][cwdvol.density.full[cwdvol.density.full$spp == "UNK",]["mean.density.x"] == 100] <- 0.399
###Asp dc 1 = 0.353
cwdvol.density.full[cwdvol.density.full$spp == "ASP",]["mean.density.x"][cwdvol.density.full[cwdvol.density.full$spp == "ASP",]["mean.density.x"] == 100] <- 0.353
###Decay class 4 or 5 for any species = 0.14 g/cm3
cwdvol.density.full[cwdvol.density.full$dc == "4",]["mean.density.x"][cwdvol.density.full[cwdvol.density.full$dc == "4",]["mean.density.x"] >0] <- 0.14
cwdvol.density.full[cwdvol.density.full$dc == "5",]["mean.density.x"][cwdvol.density.full[cwdvol.density.full$dc == "5",]["mean.density.x"] >0] <- 0.14
###Change NONE species density to 0 from the constant 100
cwdvol.density.full[cwdvol.density.full$spp == "NONE",]["mean.density.x"][cwdvol.density.full[cwdvol.density.full$spp == "NONE",]["mean.density.x"] == 100] <- 0
###Remove duplicate density column and re-name columns
cwdvol.density.full <- cwdvol.density.full[c(1:9)]
colnames(cwdvol.density.full) <- c("stand", "age", "year", "cluster", "az", "spp", "dc", "transvol", "density")
```



###Calculate biomass for each spp and decay class at each transect at each stand (mg/ha) using HARMON DATA to fill gaps
```{r}
cwdvol.density.full$tranbiomass <- cwdvol.density.full$transvol * cwdvol.density.full$density
```

###Calculate stand biomass by averaging transect biomass per cluster and cluster biomass per stand
```{r}
###Separate years
twenty_biomass <- cwdvol.density.full[cwdvol.density.full$year == "2020",] 
ohfour_biomass <- cwdvol.density.full[cwdvol.density.full$year == "2004",]

###Subset old growth stands
twenty_biomass.og <- twenty_biomass[which(twenty_biomass$stand == "Bowl"| twenty_biomass$stand == "Pond"),]

###Average transect biomass for each cluster
twentybiomassclust.og <- twenty_biomass.og %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustbiomass = sum(tranbiomass)/3)
###Average cluster biomass for each stand
twentybiomassstand.og <- twentybiomassclust.og %>%
  group_by(stand, age, year) %>%
  summarise(avgstandbiomass = sum(avgclustbiomass)/4)

###Subset "normal" stands
twenty_biomass.normies <- twenty_biomass[which(twenty_biomass$stand == "H2"| twenty_biomass$stand == "H3"| twenty_biomass$stand == "H4"| twenty_biomass$stand == "H5"| 
                                 twenty_biomass$stand == "H6"| twenty_biomass$stand == "M3"| twenty_biomass$stand == "M4"| twenty_biomass$stand == "M5"|twenty_biomass$stand == "M6"| twenty_biomass$stand == "T30"|twenty_biomass$stand == "HB101"),]
ohfour_biomass.normies <- ohfour_biomass[which(ohfour_biomass$stand == "C2"|ohfour_biomass$stand == "H2"| ohfour_biomass$stand == "H3"| ohfour_biomass$stand == "H4"| ohfour_biomass$stand == "H5"| 
                                 ohfour_biomass$stand == "H6"| ohfour_biomass$stand == "M3"| ohfour_biomass$stand == "M4"| ohfour_biomass$stand == "M5"|ohfour_biomass$stand == "M6"|ohfour_biomass$stand == "T30"| ohfour_biomass$stand == "HB101"),]

###2020
###Average transect biomass for each cluster
twentybiomassclust.normies <- twenty_biomass.normies %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustbiomass = sum(tranbiomass)/3)
###Average cluster biomass for each stand
twentybiomassstand.normies <- twentybiomassclust.normies %>%
    group_by(stand, age, year) %>%
  summarise(avgstandbiomass = sum(avgclustbiomass)/3)


###2004
###Average transect biomass for each cluster
ohfourbiomassclust.normies <- ohfour_biomass.normies %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustbiomass = sum(tranbiomass)/3)
###Average cluster biomass for each "normal" stand
ohfourbiomassstand.normies <- ohfourbiomassclust.normies %>%
  group_by(stand, age, year) %>%
  summarise(avgstandbiomass = mean(avgclustbiomass))

###Odd balls = CC2, H1, T20 
###CC2: AB, BC, CD, DA, EF, GH
twenty_biomass.cc2 <- twenty_biomass[which(twenty_biomass$stand == "CC2"),]
ohfour_biomass.cc2.h1 <- ohfour_biomass[which(ohfour_biomass$stand == "CC2"|ohfour_biomass$stand == "H1"),]

###2020
###Average transect biomass for each cluster
twentybiomassclust.cc2 <- twenty_biomass.cc2 %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustbiomass = mean(tranbiomass))
###Average cluster biomass for CC2
twentybiomassstand.cc2 <- twentybiomassclust.cc2 %>%
  group_by(stand, age, year) %>%
  summarise(avgstandbiomass = sum(avgclustbiomass)/6)

###2004
###Average transect biomass for each cluster
ohfourbiomassclust.cc2.h1 <- ohfour_biomass.cc2.h1 %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustbiomass = mean(tranbiomass))
###Average cluster biomass for CC2
ohfourbiomassstand.cc2.h1 <- ohfourbiomassclust.cc2.h1 %>%
  group_by(stand, age, year) %>%
  summarise(avgstandbiomass = sum(avgclustbiomass)/6)


###T20: AB, BC, CD, CE, DA, DF, GH, GI
twenty_biomass.t20 <- twenty_biomass[which(twenty_biomass$stand == "T20"),]
ohfour_biomass.t20 <- ohfour_biomass[which(ohfour_biomass$stand == "T20"),]

###2020
###Average transect biomass for each cluster
twentybiomassclust.t20 <- twenty_biomass.t20 %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustbiomass = mean(tranbiomass))
###Average cluster biomass for T20
twentybiomassstand.t20 <- twentybiomassclust.t20 %>%
  group_by(stand, age, year) %>%
  summarise(avgstandbiomass = sum(avgclustbiomass)/8)

###2004
###Average transect biomass for each cluster
ohfourbiomassclust.t20 <- ohfour_biomass.t20 %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustbiomass = mean(tranbiomass))
###Average cluster volumes for T20
ohfourbiomassstand.t20 <- ohfourbiomassclust.t20 %>%
  group_by(stand, age, year) %>%
  summarise(avgstandbiomass = sum(avgclustbiomass)/8)

###Combine all stands again
###2020
twentybiomassstand <- rbind(twentybiomassstand.normies, twentybiomassstand.cc2, twentybiomassstand.t20, twentybiomassstand.og)
###2004
ohfourbiomassstand <- rbind(ohfourbiomassstand.normies, ohfourbiomassstand.cc2.h1, ohfourbiomassstand.t20)
avgbiomass0420<- union(twentybiomassstand, ohfourbiomassstand)
```

###Calculate SE of biomass 
```{r}
##Calculate SE of CWD biomass in each stand
###OG
###2020
twentybiomass_se.og <- twenty_biomass.og %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranbiomass)/sqrt(12))
###Normies
###2020
twentybiomass_se.normies <- twenty_biomass.normies %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranbiomass)/sqrt(9))
###2004
ohfourbiomass_se.normies <- ohfour_biomass.normies %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranbiomass)/sqrt(9))
###CC2
###2020
twentybiomass_se.cc2 <- twenty_biomass.cc2 %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranbiomass)/sqrt(6))
###2004
ohfourbiomass_se.cc2.h1 <- ohfour_biomass.cc2.h1 %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranbiomass)/sqrt(6))
###T20
###2020
twentybiomass_se.t20 <- twenty_biomass.t20 %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranbiomass)/sqrt(8))
###2004
ohfourbiomass_se.t20 <- ohfour_biomass.t20 %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranbiomass)/sqrt(8))

###Combine all stands again
###2020
twentybiomassstand_se <- rbind(twentybiomass_se.normies, twentybiomass_se.cc2, twentybiomass_se.t20, twentybiomass_se.og)
###2004
ohfourbiomassstand_se <- rbind(ohfourbiomass_se.normies, ohfourbiomass_se.cc2.h1, ohfourbiomass_se.t20)
avgbiomass0420_se<- union(twentybiomassstand_se, ohfourbiomassstand_se)
```

###Combine biomass estimate and standard error
```{r}
cwd.stand.biomass <- left_join(avgbiomass0420, avgbiomass0420_se, by = c("stand", "age", "year"))

```




###INCORRECT BUT KEPT FOR CODE REFERENCE 7/9/23
```{r}
###Calculate average biomass at each stand
cwd.stand.biomass <- cwdvol.density.full %>%
  group_by(stand, age, year) %>%
  summarise(total.biomass = sum(tranbiomass))

###Calculate SE 
cwd.stand.biomass.se <- cwdvol.density.full[-which(cwdvol.density.full$spp == "NONE"),] %>%
  group_by(stand, age, year) %>%
  summarise(se = ((sd(tranbiomass))/sqrt(n())))

###Change NA to 0
cwd.stand.biomass.se$se[is.na(cwd.stand.biomass.se$se)] <- 0

cwd.stand.biomass <- left_join(cwd.stand.biomass, cwd.stand.biomass.se, by = c("stand", "age", "year"))
```



###2004
```{r}
ohfour.cwd.stand.biomass <- cwd.stand.biomass[cwd.stand.biomass$year == "2004",]
###Re-order stands
ohfour.cwd.stand.biomass$stand <- factor(ohfour.cwd.stand.biomass$stand, levels = c("CC2", "C2", "H6", "M6", "M5", "HB101", "H5", "T20",  "M4", "T30", "H1", "H4", "M3", "H2", "H3"))
###Change H3 to age 130 to seperate from H2 
ohfour.cwd.stand.biomass$age[ohfour.cwd.stand.biomass$stand == "H3"] <- 130
ohfour.cwd.stand.biomass$age <- factor(ohfour.cwd.stand.biomass$age, levels = c("15", "16", "20", "24", "27", "34", "37", "46", "54", "56", "65", "70", "94", "129", "130"))

ggplot(data = ohfour.cwd.stand.biomass, aes(x = age, y = avgstandbiomass)) + 
  geom_bar(stat = "identity") + 
  geom_errorbar(aes(ymin = avgstandbiomass-se, ymax = avgstandbiomass+se)) + 
  labs(x = "stand", y = (expression(CWD~biomass~(Mg/ha)))) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 30)) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA))
```

###2020
```{r}
twenty.cwd.stand.biomass <- cwd.stand.biomass[cwd.stand.biomass$year == "2020",]
###Re-order stands
twenty.cwd.stand.biomass$stand <- factor(twenty.cwd.stand.biomass$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20",  "M4", "T30", "H4", "M3", "H2", "H3", "Bowl", "Pond"))
###Change H3 to age 130 to seperate from H2 
twenty.cwd.stand.biomass$age[twenty.cwd.stand.biomass$stand == "H3"] <- 146
###Change Bowl and Pond to age 200 and 201
twenty.cwd.stand.biomass$age[twenty.cwd.stand.biomass$stand == "Bowl"] <- 200
twenty.cwd.stand.biomass$age[twenty.cwd.stand.biomass$stand == "Pond"] <- 201
twenty.cwd.stand.biomass$age <- factor(twenty.cwd.stand.biomass$age, levels = c("31", "36", "40", "43", "50", "53", "62", "70", "72", "86", "94", "110", "145", "146", "200", "201"))
ggplot(data = twenty.cwd.stand.biomass, aes(x = age, y = avgstandbiomass)) + 
  geom_bar(stat = "identity") + 
  geom_errorbar(aes(ymin = avgstandbiomass-se, ymax = avgstandbiomass+se)) + 
  labs(x = "stand", y = (expression(CWD~biomass~(Mg/ha)))) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 40)) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA))

```

###Combine Progression of biomass
```{r}
cwd.stand.biomass.noog <-  cwd.stand.biomass[-which(cwd.stand.biomass$stand == "Bowl"| cwd.stand.biomass$stand == "Pond"),]
cwd.stand.biomass.noog$stand <- factor(cwd.stand.biomass.noog$stand, levels = c("CC2", "C2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3"))
###With OG
cwd.stand.biomass$stand <- factor(cwd.stand.biomass$stand, levels = c("CC2", "C2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))
###Change age of Bowl and Pond to 180 so they fit on the graph
cwd.stand.biomass$age[cwd.stand.biomass$stand == "Bowl" | cwd.stand.biomass$stand == "Pond"] <- 180
ggplot(data = cwd.stand.biomass, aes(x = age, y = avgstandbiomass, group = stand, color = stand)) + 
  geom_point(size = 2) + 
  geom_errorbar(aes(ymin=avgstandbiomass-se, ymax=avgstandbiomass+se), size = 1.2, position = position_dodge()) +
  geom_line(size = 1.2) + 
  labs(x = "stand Age", y = (expression(CWD~Biomass~(Mg/ha))), color = "stand") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,200)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 40)) + 
  scale_color_discrete() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA)) + 
  annotation_custom(textGrob("Bowl", gp = gpar(col = "black", fontsize = 15)), xmin = 170, xmax = 170, ymin = 23, ymax = 23 ) + 
  annotation_custom(textGrob("Pond", gp = gpar(col = "black", fontsize = 15)), xmin = 170, xmax = 170, ymin = 15, ymax = 15 ) + 
  annotate("text", x = 160, y = 0, label = "~", size = 5, angle = 90) +
  annotate("text", x = 170, y = 0, label = "~", size = 5, angle = 90) +
  annotation_custom(segmentsGrob(gp = gpar(col = "black", lwd = 1)), xmin = 180, xmax = 180, ymin = 0, ymax = -.80) +
  annotation_custom(textGrob("Uncut", gp = gpar(col = "black", fontsize = 15)), xmin = 180, xmax = 180, ymin = -3, ymax = -3 ) + 
  coord_cartesian(clip = "off")

```




###Average densities across spp and dc
```{r}
acker.density <- cwd.density %>%
  group_by(spp, dc) %>%
  summarise(avg.den = mean(density))
###Calculate Sd
acker.density.sd <- cwd.density %>%
  group_by(spp, dc) %>%
  summarise(den.sd = sd(density))
###Join mean and sd
acker.density.compare <- left_join(acker.density, acker.density.sd, by = c("spp", "dc"))
###Remove UNK species
acker.density.compare <- acker.density.compare[-which(is.na(acker.density.compare$den.sd)),]
```

###Import Harmon data
```{r}
harmon.density <- read.csv("Harmon_cwd_density.csv")
harmon.density <- harmon.density[-1]
colnames(harmon.density) <- c("spp", "dc", "density", "uncert")

###Remove UNK species
harmon.density <- harmon.density [-which(harmon.density$spp == "UNK"),]
```

###Join Acker and Harmon data 
```{r}
acker.harmon <- left_join(acker.density.compare,harmon.density, by = c("spp", "dc"))
acker.harmon <- acker.harmon[-which(acker.harmon$spp == "UNK"),]
colnames(acker.harmon) <- c("spp", "dc", "acker.den", "acker.sd", "harmon.den", "harmon.sd")
acker.harmon$dc <- factor(acker.harmon$dc, levels = c("1", "2", "3", "4", "5"))
###XY of Acker v Harmon Density data
ggplot(data = acker.harmon, aes(x = acker.den, y = harmon.den, color = spp, shape = dc)) + 
  geom_point(size = 5) + 
  labs(x = "Acker Density", y = "Harmon Density", color = "Species", shape = "Decay Class") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,0.7)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.7)) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA))

```

###Paired two-sided t-test to determine if there is a difference between the two density data sets 
###(does not appear to be from the XY)
```{r}
###T-test agrees (p = 0.46)
t.test(acker.harmon$acker.den, acker.harmon$harmon.den, paired = TRUE, alternative = "two.sided")
```
###Finding bias between Acker and Harmon densities
```{r}
acker.harmon$error = acker.harmon$harmon.den-acker.harmon$acker.den

sum(acker.harmon$error)/nrow(acker.harmon)
```



###
###Filling in the gaps of Acker data by averaging across other species of the same dc
###
```{r}
###Average Hardwood dc densities 1-3
###Subset HW only
cwdvol.density.hw <- cwdvol.density[-which(cwdvol.density$spp == "HEM" | cwdvol.density$spp == "CON" | cwdvol.density$spp == "FIR" | cwdvol.density$spp == "SP" | cwdvol.density$spp == "UNK"),]
cwdvol.density.hw.no.gaps <- cwdvol.density.hw[-which(is.na(cwdvol.density.hw$mean.density)),]
###Acker average density per decay class for hardwoods
acker.hw.dc.avg.den <- cwdvol.density.hw.no.gaps %>% group_by(dc) %>%
  summarise(avg.den = mean(mean.density))
###Subset SW only
cwdvol.density.sw <- cwdvol.density[which(cwdvol.density$spp == "HEM" | cwdvol.density$spp == "CON" | cwdvol.density$spp == "FIR" | cwdvol.density$spp == "SP" | cwdvol.density$spp == "UNK"),]
cwdvol.density.sw.no.gaps <- cwdvol.density.sw[-which(is.na(cwdvol.density.sw$mean.density)),]
###Acker average density per decay class for conifers 
acker.sw.dc.avg.den <- cwdvol.density.sw.no.gaps %>% group_by(dc) %>%
  summarise(avg.den = mean(mean.density))

###Fill in gaps using averages for hardwoods
###Join cwdvol.density.hw with average densities
hw.density <- left_join(cwdvol.density.hw, acker.hw.dc.avg.den, by = c("dc"))
###Change NA for spp dc gaps to average from other spp
hw.density$mean.density <- ifelse(is.na(hw.density$mean.density), hw.density$avg.den, hw.density$mean.density)

###Fill in gaps using averages for softwoods
###Join cwdvol.density.sw with average densities
sw.density <- left_join(cwdvol.density.sw, acker.sw.dc.avg.den, by = c("dc"))
###Change NA for spp dc gaps to average from other spp
sw.density$mean.density <- ifelse(is.na(sw.density$mean.density), sw.density$avg.den, sw.density$mean.density)

###Join hardwoods and softwoods, all gaps filled
vol.acker.density.complete <- rbind(hw.density, sw.density)
###Remove dup column
vol.acker.density.complete <- vol.acker.density.complete[-8]
```

###Calculate biomass for each spp and decay class at each stand (mg/ha) using averages from acker's data to fill in gaps
```{r}
vol.acker.density.complete$biomass <- vol.acker.density.complete$avgstandvol * vol.acker.density.complete$mean.density
###Change NA for none species to 0
vol.acker.density.complete$biomass[is.na(vol.acker.density.complete$biomass)] <- 0
###Calculate average biomass at each stand
cwd.stand.biomass.acker <- vol.acker.density.complete %>%
  group_by(stand, age, year) %>%
  summarise(total.biomass = sum(biomass))

###Calculate SE 
cwd.stand.biomass.acker.se <- vol.acker.density.complete %>%
  group_by(stand, age, year) %>%
  summarise(se = (sd(biomass)/sqrt(n())))

###Combine mean and SE 
cwd.stand.biomass.second <- left_join(cwd.stand.biomass.acker,cwd.stand.biomass.acker.se, by = c("stand", "age", "year") )


###Including OG stands
###Change age of bowl and pond to 180 so they fit on grapgh
cwd.stand.biomass.second$age[cwd.stand.biomass.second$stand == "Bowl" | cwd.stand.biomass.second$stand == "Pond"] <- 180
###Re-order stands
cwd.stand.biomass.second$stand <- factor(cwd.stand.biomass.second$stand, levels = c("CC2", "C2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))

```


###Plot second biomass
```{r}
ggplot(data = cwd.stand.biomass.second[-which(cwd.stand.biomass.second$stand == "C2"),], aes(x = age, y = total.biomass, group = stand, color = stand)) + 
  geom_point(size = 2) + 
  geom_errorbar(aes(ymin=total.biomass-se, ymax=total.biomass+se), position = position_dodge()) +
  geom_line(size = 1) + 
  labs(x = "stand Age", y = (expression(CWD~Biomass~(Mg/ha))), color = "stand") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,200)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 40)) + 
  scale_color_manual(values = standcolors) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA)) + 
  annotation_custom(textGrob("Bowl", gp = gpar(col = "black", fontsize = 15)), xmin = 170, xmax = 170, ymin = 21.4, ymax = 21.4 ) + 
  annotation_custom(textGrob("Pond", gp = gpar(col = "black", fontsize = 15)), xmin = 170, xmax = 170, ymin = 15, ymax = 15 ) + 
  annotate("text", x = 160, y = 0, label = "~", size = 5, angle = 90) +
  annotate("text", x = 170, y = 0, label = "~", size = 5, angle = 90) +
  annotation_custom(segmentsGrob(gp = gpar(col = "black", lwd = 1)), xmin = 180, xmax = 180, ymin = 0, ymax = -.2) +
  annotation_custom(textGrob("Uncut", gp = gpar(col = "black", fontsize = 15)), xmin = 180, xmax = 180, ymin = -.80, ymax = -.80 ) + 
  coord_cartesian(clip = "off")

```

###Biomass Calculations
```{r}
###CWD volume data with species and decay class
##Volume calculations with species 
###Sum vol for each transect of each cluster at OG stands
twentyvoltransppdc.og <- twenty.og %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)

###Calculate biomass at each transect
twentybiomasstransppdc.og <- left_join(twentyvoltransppdc.og, cwd.mean.density, by = c("spp", "dc"))
twentybiomasstransppdc.og2 <- left_join(twentybiomasstransppdc.og, spp.dc.gaps, by = c("spp", "dc"))

twentybiomasstransppdc.og2$mean.density.x <- ifelse(is.na(twentybiomasstransppdc.og2$mean.density.x), twentybiomasstransppdc.og2$mean.density.y, twentybiomasstransppdc.og2$mean.density.x)

##Change NA values to 100 for ease
twentybiomasstransppdc.og2$mean.density.x[is.na(twentybiomasstransppdc.og2$mean.density.x)] <- 100

###Decay class 4 or 5 for any species = 0.14 g/cm3
twentybiomasstransppdc.og2[twentybiomasstransppdc.og2$dc == "4",]["mean.density.x"][twentybiomasstransppdc.og2[twentybiomasstransppdc.og2$dc == "4",]["mean.density.x"] >0] <- 0.14
twentybiomasstransppdc.og2[twentybiomasstransppdc.og2$dc == "5",]["mean.density.x"][twentybiomasstransppdc.og2[twentybiomasstransppdc.og2$dc == "5",]["mean.density.x"] >0] <- 0.14
###Change NONE species density to 0 from the constant 100
twentybiomasstransppdc.og2[twentybiomasstransppdc.og2$spp == "NONE",]["mean.density.x"][twentybiomasstransppdc.og2[twentybiomasstransppdc.og2$spp == "NONE",]["mean.density.x"] == 100] <- 0

twentybiomasstransppdc.og2$biomass = twentybiomasstransppdc.og2$tranvol*twentybiomasstransppdc.og2$mean.density.x
twentybiomasstransppdc.og.complete <- twentybiomasstransppdc.og2[-c(10:12)]

###Average transect biomass for each cluster
twentybiomassclust.og <- twentybiomasstransppdc.og.complete %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustbiomass = sum(biomass)/3)
###Average cluster biomass for each stand
twentybiomassstand.og <- twentybiomassclust.og %>%
  group_by(stand, age, year) %>%
  summarise(avgstandbiomass = sum(avgclustbiomass)/4)



###Sum vol for each transect of each cluster at each "normal" stand
###2020
twentyvoltransppdc.normies <- twenty.normies %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Calculate biomass at each transect
twentybiomasstransppdc.normies <- left_join(twentyvoltransppdc.normies, cwd.mean.density, by = c("spp", "dc"))
twentybiomasstransppdc.normies2 <- left_join(twentybiomasstransppdc.normies, spp.dc.gaps, by = c("spp", "dc"))

twentybiomasstransppdc.normies2$mean.density.x <- ifelse(is.na(twentybiomasstransppdc.normies2$mean.density.x), twentybiomasstransppdc.normies2$mean.density.y, twentybiomasstransppdc.normies2$mean.density.x)

##Change NA values to 100 for ease
twentybiomasstransppdc.normies2$mean.density.x[is.na(twentybiomasstransppdc.normies2$mean.density.x)] <- 100

###Asp dc 1 = 0.353
twentybiomasstransppdc.normies2[twentybiomasstransppdc.normies2$spp == "ASP",]["mean.density.x"][twentybiomasstransppdc.normies2[twentybiomasstransppdc.normies2$spp == "ASP",]["mean.density.x"] == 100] <- 0.353
###Decay class 4 or 5 for any species = 0.14 g/cm3
twentybiomasstransppdc.normies2[twentybiomasstransppdc.normies2$dc == "4",]["mean.density.x"][twentybiomasstransppdc.normies2[twentybiomasstransppdc.normies2$dc == "4",]["mean.density.x"] >0] <- 0.14
twentybiomasstransppdc.normies2[twentybiomasstransppdc.normies2$dc == "5",]["mean.density.x"][twentybiomasstransppdc.normies2[twentybiomasstransppdc.normies2$dc == "5",]["mean.density.x"] >0] <- 0.14
###Change NONE species density to 0 from the constant 100
twentybiomasstransppdc.normies2[twentybiomasstransppdc.normies2$spp == "NONE",]["mean.density.x"][twentybiomasstransppdc.normies2[twentybiomasstransppdc.normies2$spp == "NONE",]["mean.density.x"] == 100] <- 0

twentybiomasstransppdc.normies2$biomass = twentybiomasstransppdc.normies2$tranvol*twentybiomasstransppdc.normies2$mean.density.x
twentybiomasstransppdc.normies.complete <- twentybiomasstransppdc.normies2[-c(10:12)]

###Average transect biomass for each cluster
twentybiomassclust.normies <- twentybiomasstransppdc.normies.complete %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustbiomass = sum(biomass)/3)
###Average cluster biomass for each stand
twentybiomassstand.normies <- twentybiomassclust.normies %>%
  group_by(stand, age, year) %>%
  summarise(avgstandbiomass = sum(avgclustbiomass)/3)

###2004
ohfourvoltransppdc.normies <- ohfour.normies %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Calculate biomass at each transect
ohfourbiomasstransppdc.normies <- left_join(ohfourvoltransppdc.normies, cwd.mean.density, by = c("spp", "dc"))
ohfourbiomasstransppdc.normies2 <- left_join(ohfourbiomasstransppdc.normies, spp.dc.gaps, by = c("spp", "dc"))

ohfourbiomasstransppdc.normies2$mean.density.x <- ifelse(is.na(ohfourbiomasstransppdc.normies2$mean.density.x), ohfourbiomasstransppdc.normies2$mean.density.y, ohfourbiomasstransppdc.normies2$mean.density.x)

##Change NA values to 100 for ease
ohfourbiomasstransppdc.normies2$mean.density.x[is.na(ohfourbiomasstransppdc.normies2$mean.density.x)] <- 100

###Decay class 4 or 5 for any species = 0.14 g/cm3
ohfourbiomasstransppdc.normies2[ohfourbiomasstransppdc.normies2$dc == "4",]["mean.density.x"][ohfourbiomasstransppdc.normies2[ohfourbiomasstransppdc.normies2$dc == "4",]["mean.density.x"] >0] <- 0.14
ohfourbiomasstransppdc.normies2[ohfourbiomasstransppdc.normies2$dc == "5",]["mean.density.x"][ohfourbiomasstransppdc.normies2[ohfourbiomasstransppdc.normies2$dc == "5",]["mean.density.x"] >0] <- 0.14
###Change NONE species density to 0 from the constant 100
ohfourbiomasstransppdc.normies2[ohfourbiomasstransppdc.normies2$spp == "NONE",]["mean.density.x"][ohfourbiomasstransppdc.normies2[ohfourbiomasstransppdc.normies2$spp == "NONE",]["mean.density.x"] == 100] <- 0

ohfourbiomasstransppdc.normies2$biomass = ohfourbiomasstransppdc.normies2$tranvol*ohfourbiomasstransppdc.normies2$mean.density.x
ohfourbiomasstransppdc.normies.complete <- ohfourbiomasstransppdc.normies2[-c(10:12)]

###Average transect biomass for each cluster
ohfourbiomassclust.normies <- ohfourbiomasstransppdc.normies.complete %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustbiomass = sum(biomass)/3)
###Average cluster biomass for each stand
ohfourbiomassstand.normies <- ohfourbiomassclust.normies %>%
  group_by(stand, age, year) %>%
  summarise(avgstandbiomass = sum(avgclustbiomass)/3)

###Sum vol for each transect of each "cluster" at CC2
###2020
twentyvoltransppdc.cc2 <- twenty.cc2 %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Calculate biomass at each transect
twentybiomasstransppdc.cc2 <- left_join(twentyvoltransppdc.cc2, cwd.mean.density, by = c("spp", "dc"))
twentybiomasstransppdc.cc22 <- left_join(twentybiomasstransppdc.cc2, spp.dc.gaps, by = c("spp", "dc"))

twentybiomasstransppdc.cc22$mean.density.x <- ifelse(is.na(twentybiomasstransppdc.cc22$mean.density.x), twentybiomasstransppdc.cc22$mean.density.y, twentybiomasstransppdc.cc22$mean.density.x)

##Change NA values to 100 for ease
twentybiomasstransppdc.cc22$mean.density.x[is.na(twentybiomasstransppdc.cc22$mean.density.x)] <- 100

###Decay class 4 or 5 for any species = 0.14 g/cm3
twentybiomasstransppdc.cc22[twentybiomasstransppdc.cc22$dc == "4",]["mean.density.x"][twentybiomasstransppdc.cc22[twentybiomasstransppdc.cc22$dc == "4",]["mean.density.x"] >0] <- 0.14
twentybiomasstransppdc.cc22[twentybiomasstransppdc.cc22$dc == "5",]["mean.density.x"][twentybiomasstransppdc.cc22[twentybiomasstransppdc.cc22$dc == "5",]["mean.density.x"] >0] <- 0.14
###Change NONE species density to 0 from the constant 100
twentybiomasstransppdc.cc22[twentybiomasstransppdc.cc22$spp == "NONE",]["mean.density.x"][twentybiomasstransppdc.cc22[twentybiomasstransppdc.cc22$spp == "NONE",]["mean.density.x"] == 100] <- 0

twentybiomasstransppdc.cc22$biomass = twentybiomasstransppdc.cc22$tranvol*twentybiomasstransppdc.cc22$mean.density.x
twentybiomasstransppdc.cc2.complete <- twentybiomasstransppdc.cc22[-c(10:12)]

###Average transect biomass for each cluster
twentybiomassclust.cc2 <- twentybiomasstransppdc.cc2.complete %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustbiomass = mean(biomass))
###Average cluster biomass for CC2
twentybiomassstand.cc2 <- twentybiomassclust.cc2 %>%
  group_by(stand, age, year) %>%
  summarise(avgstandbiomass = sum(avgclustbiomass)/6)


###2004
ohfourvoltransppdc.cc2.h1 <- ohfour.cc2.h1 %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Calculate biomass at each transect
ohfourbiomasstransppdc.cc2.h1 <- left_join(ohfourvoltransppdc.cc2.h1, cwd.mean.density, by = c("spp", "dc"))
ohfourbiomasstransppdc.cc2.h12 <- left_join(ohfourbiomasstransppdc.cc2.h1, spp.dc.gaps, by = c("spp", "dc"))

ohfourbiomasstransppdc.cc2.h12$mean.density.x <- ifelse(is.na(ohfourbiomasstransppdc.cc2.h12$mean.density.x), ohfourbiomasstransppdc.cc2.h12$mean.density.y, ohfourbiomasstransppdc.cc2.h12$mean.density.x)

##Change NA values to 100 for ease
ohfourbiomasstransppdc.cc2.h12$mean.density.x[is.na(ohfourbiomasstransppdc.cc2.h12$mean.density.x)] <- 100

###Decay class 4 or 5 for any species = 0.14 g/cm3
ohfourbiomasstransppdc.cc2.h12[ohfourbiomasstransppdc.cc2.h12$dc == "4",]["mean.density.x"][ohfourbiomasstransppdc.cc2.h12[ohfourbiomasstransppdc.cc2.h12$dc == "4",]["mean.density.x"] >0] <- 0.14
ohfourbiomasstransppdc.cc2.h12[ohfourbiomasstransppdc.cc2.h12$dc == "5",]["mean.density.x"][ohfourbiomasstransppdc.cc2.h12[ohfourbiomasstransppdc.cc2.h12$dc == "5",]["mean.density.x"] >0] <- 0.14
###Change NONE species density to 0 from the constant 100
ohfourbiomasstransppdc.cc2.h12[ohfourbiomasstransppdc.cc2.h12$spp == "NONE",]["mean.density.x"][ohfourbiomasstransppdc.cc2.h12[ohfourbiomasstransppdc.cc2.h12$spp == "NONE",]["mean.density.x"] == 100] <- 0

ohfourbiomasstransppdc.cc2.h12$biomass = ohfourbiomasstransppdc.cc2.h12$tranvol*ohfourbiomasstransppdc.cc2.h12$mean.density.x
ohfourbiomasstransppdc.cc2.h1.complete <- ohfourbiomasstransppdc.cc2.h12[-c(10:12)]

###Average transect biomass for each cluster
ohfourbiomassclust.cc2.h1 <- ohfourbiomasstransppdc.cc2.h1.complete %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustbiomass = mean(biomass))
###Average cluster biomass for CC2
ohfourbiomassstand.cc2.h1 <- ohfourbiomassclust.cc2.h1 %>%
  group_by(stand, age, year) %>%
  summarise(avgstandbiomass = sum(avgclustbiomass)/6)

###Sum vol for each transect of each cluster at T20
###2020
twentyvoltransppdc.t20 <- twenty.t20 %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Calculate biomass at each transect
twentybiomasstransppdc.t20 <- left_join(twentyvoltransppdc.t20, cwd.mean.density, by = c("spp", "dc"))
twentybiomasstransppdc.t202 <- left_join(twentybiomasstransppdc.t20, spp.dc.gaps, by = c("spp", "dc"))

twentybiomasstransppdc.t202$mean.density.x <- ifelse(is.na(twentybiomasstransppdc.t202$mean.density.x), twentybiomasstransppdc.t202$mean.density.y, twentybiomasstransppdc.t202$mean.density.x)

##Change NA values to 100 for ease
twentybiomasstransppdc.t202$mean.density.x[is.na(twentybiomasstransppdc.t202$mean.density.x)] <- 100

###Decay class 4 or 5 for any species = 0.14 g/cm3
twentybiomasstransppdc.t202[twentybiomasstransppdc.t202$dc == "4",]["mean.density.x"][twentybiomasstransppdc.t202[twentybiomasstransppdc.t202$dc == "4",]["mean.density.x"] >0] <- 0.14
twentybiomasstransppdc.t202[twentybiomasstransppdc.t202$dc == "5",]["mean.density.x"][twentybiomasstransppdc.t202[twentybiomasstransppdc.t202$dc == "5",]["mean.density.x"] >0] <- 0.14
###Change NONE species density to 0 from the constant 100
twentybiomasstransppdc.t202[twentybiomasstransppdc.t202$spp == "NONE",]["mean.density.x"][twentybiomasstransppdc.t202[twentybiomasstransppdc.t202$spp == "NONE",]["mean.density.x"] == 100] <- 0

twentybiomasstransppdc.t202$biomass = twentybiomasstransppdc.t202$tranvol*twentybiomasstransppdc.t202$mean.density.x
twentybiomasstransppdc.t20.complete <- twentybiomasstransppdc.t202[-c(10:12)]


###Average transect biomass for each cluster
twentybiomassclust.t20 <- twentybiomasstransppdc.t20.complete %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustbiomass = mean(biomass))
###Average cluster biomass for T20
twentybiomassstand.t20 <- twentybiomassclust.t20 %>%
  group_by(stand, age, year) %>%
  summarise(avgstandbiomass = sum(avgclustbiomass)/8)


###2004
ohfourvoltransppdc.t20 <- ohfour.t20 %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Calculate biomass at each transect
ohfourbiomasstransppdc.t20 <- left_join(ohfourvoltransppdc.t20, cwd.mean.density, by = c("spp", "dc"))
ohfourbiomasstransppdc.t202 <- left_join(ohfourbiomasstransppdc.t20, spp.dc.gaps, by = c("spp", "dc"))

ohfourbiomasstransppdc.t202$mean.density.x <- ifelse(is.na(ohfourbiomasstransppdc.t202$mean.density.x), ohfourbiomasstransppdc.t202$mean.density.y, ohfourbiomasstransppdc.t202$mean.density.x)

##Change NA values to 100 for ease
ohfourbiomasstransppdc.t202$mean.density.x[is.na(ohfourbiomasstransppdc.t202$mean.density.x)] <- 100
ohfourbiomasstransppdc.t202[ohfourbiomasstransppdc.t202$spp == "UNK",]["mean.density.x"][ohfourbiomasstransppdc.t202[ohfourbiomasstransppdc.t202$spp == "UNK",]["mean.density.x"] == 100] <- 0.399
###Decay class 4 or 5 for any species = 0.14 g/cm3
ohfourbiomasstransppdc.t202[ohfourbiomasstransppdc.t202$dc == "4",]["mean.density.x"][ohfourbiomasstransppdc.t202[ohfourbiomasstransppdc.t202$dc == "4",]["mean.density.x"] >0] <- 0.14
ohfourbiomasstransppdc.t202[ohfourbiomasstransppdc.t202$dc == "5",]["mean.density.x"][ohfourbiomasstransppdc.t202[ohfourbiomasstransppdc.t202$dc == "5",]["mean.density.x"] >0] <- 0.14
###Change NONE species density to 0 from the constant 100
ohfourbiomasstransppdc.t202[ohfourbiomasstransppdc.t202$spp == "NONE",]["mean.density.x"][ohfourbiomasstransppdc.t202[ohfourbiomasstransppdc.t202$spp == "NONE",]["mean.density.x"] == 100] <- 0

ohfourbiomasstransppdc.t202$biomass = ohfourbiomasstransppdc.t202$tranvol*ohfourbiomasstransppdc.t202$mean.density.x
ohfourbiomasstransppdc.t20.complete <- ohfourbiomasstransppdc.t202[-c(10:12)]

###Average transect biomass for each cluster
ohfourbiomassclust.t20 <- ohfourbiomasstransppdc.t20.complete %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustbiomass = mean(biomass))
###Average cluster biomass for T20
ohfourbiomassstand.t20 <- ohfourbiomassclust.t20 %>%
  group_by(stand, age, year) %>%
  summarise(avgstandbiomass = sum(avgclustbiomass)/8)


###Combine all stands again
###2020
twentybiomass <- rbind(twentybiomassstand.normies, twentybiomassstand.cc2, twentybiomassstand.t20, twentybiomassstand.og)
###2004
ohfourbiomass <- rbind(ohfourbiomassstand.normies, ohfourbiomassstand.cc2.h1, ohfourbiomassstand.t20)
###Combine 2004 and 2020 species CWD data 
cwd.biomass0420<- union(twentybiomass, ohfourbiomass)






###Calculate SE of CWD biomass for each stand
###OG
###2020
twentybiomass_se.og <- twentybiomasstransppdc.og.complete %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(biomass)/sqrt(12))


###Normies
###2020
twentybiomass_se.normies <- twentybiomasstransppdc.normies.complete %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(biomass)/sqrt(9))
###2004
ohfourbiomass_se.normies <- ohfourbiomasstransppdc.normies.complete %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(biomass)/sqrt(9))
###CC2
###2020
twentybiomass_se.cc2 <- twentybiomasstransppdc.cc2.complete %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(biomass)/sqrt(6))
###2004
ohfourbiomass_se.cc2.h1 <- ohfourbiomasstransppdc.cc2.h1.complete %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(biomass)/sqrt(6))
###T20
###2020
twentybiomass_se.t20 <- twentybiomasstransppdc.t20.complete %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(biomass)/sqrt(8))
###2004
ohfourbiomass_se.t20 <- ohfourbiomasstransppdc.t20.complete %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(biomass)/sqrt(8))
###Combine all stands
###2020
twentybiomass_se <- rbind(twentybiomass_se.og, twentybiomass_se.normies, twentybiomass_se.cc2, twentybiomass_se.t20)
###2004
ohfourbiomass_se <- rbind(ohfourbiomass_se.normies, ohfourbiomass_se.cc2.h1, ohfourbiomass_se.t20)
###Combine both years
biomassse <- rbind(twentybiomass_se, ohfourbiomass_se)
###Combine CWD biomass and SE
cwd_biomass_se <- left_join(cwd.biomass0420,biomassse, by = c("stand", "age", "year"))

cwd_biomass_se$stand <- factor(cwd_biomass_se$stand, levels = c("CC2", "C2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))
###Change age of Bowl and Pond to 180 so they fit on the graph
cwd_biomass_se$age[cwd_biomass_se$stand == "Bowl" | cwd_biomass_se$stand == "Pond"] <- 180

###CORRECT CWD BIOMASS PROGRESSION 
ggplot(data = cwd_biomass_se[-which(cwd_biomass_se$stand == "C2"),], aes(x = age, y = avgstandbiomass, group = stand, color = age)) + 
  geom_point(size = 2) + 
  geom_errorbar(aes(ymin=avgstandbiomass-se, ymax=avgstandbiomass+se), size = 1.2, position = position_dodge()) +
  geom_line(size = 1.2) + 
  labs(x = "stand Age", y = (expression(CWD~Biomass~(Mg/ha))), color = "Stand Age") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,200)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 40)) + 
  scale_color_gradient2() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA)) + 
  annotate("text", x = 160, y = 0, label = "~", size = 5, angle = 90) +
  annotate("text", x = 170, y = 0, label = "~", size = 5, angle = 90) +
  annotation_custom(segmentsGrob(gp = gpar(col = "black", lwd = 1)), xmin = 180, xmax = 180, ymin = 0, ymax = -.2) +
  annotation_custom(textGrob("Uncut", gp = gpar(col = "black", fontsize = 15)), xmin = 180, xmax = 180, ymin = -0.6, ymax = -0.6 ) +   coord_cartesian(clip = "off")

```







###Volume calculations with species 
```{r}
###Sum vol for each transect of each cluster at OG stands
twentyvoltranspp.og <- twenty.og %>%
  group_by(stand, age, year, cluster, az, spp) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclustspp.og <- twentyvoltranspp.og %>%
  group_by(stand, age, year, cluster, spp) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each stand
twentyvolstandspp.og <- twentyvolclustspp.og %>%
  group_by(stand, age, year, spp) %>%
  summarise(avgstandvol = sum(avgclustvol)/4)
###Sum vol for each transect of each cluster at each "normal" stand
###2020
twentyvoltranspp.normies <- twenty.normies %>%
  group_by(stand, age, year, cluster, az, spp) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclustspp.normies <- twentyvoltranspp.normies %>%
  group_by(stand, age, year, cluster, spp) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each stand
twentyvolstandspp.normies <- twentyvolclustspp.normies %>%
  group_by(stand, age, year, spp) %>%
  summarise(avgstandvol = sum(avgclustvol)/3)

###2004
ohfourvoltranspp.normies <- ohfour.normies %>%
  group_by(stand, age, year, cluster, az, spp) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
ohfourvolclustspp.normies <- ohfourvoltranspp.normies %>%
  group_by(stand, age, year, cluster, spp) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each "normal" stand
ohfourvolstandspp.normies <- ohfourvolclustspp.normies %>%
  group_by(stand, age, year, spp) %>%
  summarise(avgstandvol = sum(avgclustvol)/3)

###Sum vol for each transect of each "cluster" at CC2
###2020
twentyvoltranspp.cc2 <- twenty.cc2 %>%
  group_by(stand, age, year, cluster, az, spp) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclustspp.cc2 <- twentyvoltranspp.cc2 %>%
  group_by(stand, age, year, cluster, spp) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for CC2
twentyvolstandspp.cc2 <- twentyvolclustspp.cc2 %>%
  group_by(stand, age, year, spp) %>%
  summarise(avgstandvol = sum(avgclustvol)/6)
###2004
ohfourvoltranspp.cc2.h1 <- ohfour.cc2.h1 %>%
  group_by(stand, age, year, cluster, az, spp) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
ohfourvolclustspp.cc2.h1 <- ohfourvoltranspp.cc2.h1 %>%
  group_by(stand, age, year, cluster, spp) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for CC2
ohfourvolstandspp.cc2.h1 <- ohfourvolclustspp.cc2.h1 %>%
  group_by(stand, age, year, spp) %>%
  summarise(avgstandvol = sum(avgclustvol)/6)
###Sum vol for each transect of each cluster at T20
###2020
twentyvoltranspp.t20 <- twenty.t20 %>%
  group_by(stand, age, year, cluster, az, spp) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclustspp.t20 <- twentyvoltranspp.t20 %>%
  group_by(stand, age, year, cluster, spp) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for T20
twentyvolstandspp.t20 <- twentyvolclustspp.t20 %>%
  group_by(stand, age, year, spp) %>%
  summarise(avgstandvol = sum(avgclustvol)/8)
###2004
ohfourvoltranspp.t20 <- ohfour.t20 %>%
  group_by(stand, age, year, cluster, az, spp) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
ohfourvolclustspp.t20 <- ohfourvoltranspp.t20 %>%
  group_by(stand, age, year, cluster, spp) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for T20
ohfourvolstandspp.t20 <- ohfourvolclustspp.t20 %>%
  group_by(stand, age, year, spp) %>%
  summarise(avgstandvol = sum(avgclustvol)/8)
###Combine all stands again
###2020
twentyvolstandspp <- rbind(twentyvolstandspp.normies, twentyvolstandspp.cc2, twentyvolstandspp.t20, twentyvolstandspp.og)
###2004
ohfourvolstandspp <- rbind(ohfourvolstandspp.normies, ohfourvolstandspp.cc2.h1, ohfourvolstandspp.t20)
###BE only
twentyvolstandbeech <- twentyvolstandspp[twentyvolstandspp$spp == "BE", ]
ohfourvolstandbeech <- ohfourvolstandspp[ohfourvolstandspp$spp == "BE", ]
###Combine 2004 and 2020 species CWD data 
avgvol0420spp<- union(twentyvolstandspp, ohfourvolstandspp)
###Remove OG stands
avgvol0420spp_noog <- avgvol0420spp[-which(avgvol0420spp$stand == "Bowl"| avgvol0420spp$stand == "Pond"),]
avgvol0420spp_noog$stand <- factor(avgvol0420spp_noog$stand, levels = c("CC2", "C2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3"))
avgvol0420spp_noog$standage <- paste(avgvol0420spp_noog$stand, avgvol0420spp_noog$age)
avgvol0420spp_noog$standage <- factor(avgvol0420spp_noog$standage, levels = c("CC2 15", "C2 16", "H6 20", "M6 24", "M5 27", "CC2 31","HB101 34", "H6 36", "H5 37", "M6 40", "M5 43", "T20 46", "HB101 50", "H5 53", "M4 54", "T30 56", "T20 62","H1 65",  "H4 70", "M4 70", "T30 72", "H4 86", "M3 94", "M3 110", "H2 129", "H3 129", "H2 145", "H3 145"))
###Remove "NONE" species
avgvol0420spp_noog <- subset(avgvol0420spp_noog, spp !="NONE")

```

###Stacked bars of CWD volume by species in each stand
###Assign patterns to species
```{r}
###Order of increasing shade tolerance
spp.patterns <- c("circle","stripe","none","crosshatch","none","stripe","stripe","stripe","none", "stripe")
names(spp.patterns) <- c("PC", "ASP", "WB", "ASH", "OTHER", "YB", "RM", "SM", "BE", "CON")

spp.pattern_angles <- c(120,25,0,45,0,-25,90,0,0,90)
names(spp.pattern_angles) <- c("PC", "ASP", "WB", "ASH", "OTHER", "YB", "RM", "SM", "BE", "CON")

spp.pattern_density <- c(0.05,0.025,0.5,0.025,0,0.025,0.025,0.6,0.6,0.75)
names(spp.pattern_density) <- c("PC", "ASP", "WB", "ASH", "OTHER", "YB", "RM", "SM", "BE", "CON")

spp.pattern_spacing <- c(0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.02)
names(spp.pattern_spacing) <- c("PC", "ASP", "WB", "ASH", "OTHER", "YB", "RM", "SM", "BE", "CON")

spp.pattern_fills <- c("plum1","white","grey","white","black","white","darkred","darkorange2","lightskyblue1","white")
names(spp.pattern_fills) <- c("PC", "ASP", "WB", "ASH", "OTHER", "YB", "RM", "SM", "BE", "CON")

```

###2004
```{r}
###Remove "NONE" species
ohfourvolstandspp <- subset(ohfourvolstandspp, spp !="NONE")
###Combine conifers to one species "CON"
###Subset with no conifers 
ohfourvolstandspp_nocon <- ohfourvolstandspp[-which(ohfourvolstandspp$spp == "HEM"|ohfourvolstandspp$spp =="SP"),]
colnames(ohfourvolstandspp_nocon) <- c("stand", "age", "year", "spp", "vol")
###Subset with conifers only
ohfourcon <- ohfourvolstandspp[which(ohfourvolstandspp$spp == "HEM"| ohfourvolstandspp$spp == "SP"),] 
ohfourcon$spp <- "CON"
ohfourcon <- ohfourcon %>%
  group_by(stand, age, year, spp) %>%
  summarise(vol = sum(avgstandvol))
ohfour_spp_con <- rbind(ohfourcon, ohfourvolstandspp_nocon)
###Combine OV, STM and UNK to "OTHER"
###Subset without OV, STM, or UNK
ohfourvolstandspp_noother <- ohfour_spp_con[-which(ohfour_spp_con$spp == "OV"| ohfour_spp_con$spp == "STM"| ohfour_spp_con$spp == "UNK"),] 
###Subset with OV, STM, UNK only
ohfourother <- ohfour_spp_con[which(ohfour_spp_con$spp =="OV"| ohfour_spp_con$spp == "STM"| ohfour_spp_con$spp == "UNK"),] 
ohfourother$spp <- "OTHER"
ohfourother <- ohfourother %>%
  group_by(stand, age, year, spp) %>%
  summarise(vol = sum(vol))
ohfour_spp <- rbind(ohfourother, ohfourvolstandspp_noother)
###Assign colors to species
spp.colors <- c("magenta", "lawngreen", "lightgray", "cornflowerblue", "black", "gold", "red", "darkorange","cyan","forestgreen" )
names(spp.colors) <- c("PC", "ASP", "WB", "ASH", "OTHER", "YB", "RM", "SM", "BE", "CON" )

###Create column for stand age 
ohfour_spp$standage <- paste(ohfour_spp$stand, ohfour_spp$age)
ohfour_spp$standage <- factor(ohfour_spp$standage, levels = c("CC2 15", "C2 16", "H6 20", "M6 24", "M5 27", "HB101 34", "H5 37",  "T20 46", "M4 54", "T30 56", "H1 65", "H4 70", "M3 94", "H2 129", "H3 129"))
ohfour_spp$spp <- factor(ohfour_spp$spp, levels = c("PC", "ASP", "WB", "ASH", "OTHER", "YB", "RM", "SM", "BE", "CON"))
###Create plot
ggplot(data = ohfour_spp[-which(ohfour_spp$stand == "C2"),]) + 
  geom_bar_pattern(stat = "identity", aes(x =standage, y = vol, group = stand, pattern = spp, pattern_spacing = spp, 
                                          fill = spp, pattern_density = spp, pattern_angle = spp), 
                   pattern_fill = "black", pattern_size = 0.5, width = 1, colour = "black")  + 
  labs(x = "stand & Age", y = (expression(CWD~volume~(m^3/ha)))) +
  scale_x_discrete(labels = function(standage) str_wrap(standage, width = 4)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 125)) + 
  scale_pattern_manual(values = spp.patterns) + 
  scale_pattern_density_manual(values = spp.pattern_density) + 
  scale_pattern_angle_manual(values = spp.pattern_angles) +
  scale_pattern_spacing_manual(values = spp.pattern_spacing) + 
  scale_fill_manual(values = spp.pattern_fills) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15, color = "black")) + 
  theme(axis.title.y = element_text(size = 15, color = "black")) + 
  theme(axis.text.x = element_text(size = 15, color = "black")) + 
  theme(axis.text.y = element_text(size = 15, color = "black")) + 
  theme(legend.text = element_text(size = 15, color = "black")) + 
  theme(legend.title = element_text(size = 15, color = "black")) + 
  theme(panel.border = element_rect(fill = NA))
```


###Species vol as % of total
```{r}
ohfour_spp_total <- left_join(ohfour_spp, ohfourvolstand, by = c("stand", "age", "year"))
ohfour_spp_total$percent <- (ohfour_spp_total$vol / ohfour_spp_total$avgstandvol) * 100
ggplot(data = ohfour_spp_total[-which(ohfour_spp_total$stand == "C2"),]) +  
  geom_bar_pattern(stat = "identity", aes(x =standage, y = percent, group = stand, pattern = spp, 
                                          pattern_spacing = spp, fill = spp, pattern_density = spp, pattern_angle = spp), 
                   pattern_fill = "black", pattern_size = 0.5, width = 1, colour = "black") + 
  labs(x = "stand & Age", y = "CWD volume (% of total)") +
  scale_x_discrete(labels = function(standage) str_wrap(standage, width = 4)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 101)) + 
  scale_pattern_manual(values = spp.patterns) + 
  scale_pattern_density_manual(values = spp.pattern_density) + 
  scale_pattern_angle_manual(values = spp.pattern_angles) +
  scale_pattern_spacing_manual(values = spp.pattern_spacing) + 
  scale_fill_manual(values = spp.pattern_fills) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15, color = "black")) + 
  theme(axis.title.y = element_text(size = 15, color = "black")) + 
  theme(axis.text.x = element_text(size = 15, color = "black")) + 
  theme(axis.text.y = element_text(size = 15, color = "black")) + 
  theme(legend.text = element_text(size = 15, color = "black")) + 
  theme(legend.title = element_text(size = 15, color = "black")) + 
  theme(panel.border = element_rect(fill = NA))

```

###2020
```{r}
###Remove "NONE" species
twentyvolstandspp <- subset(twentyvolstandspp, spp !="NONE")
###Remove OG stands
twentyvolstandspp_noog <- twentyvolstandspp[-which(twentyvolstandspp$stand == "Bowl"| twentyvolstandspp$stand == "Pond"),]
###Combine conifers to one species "CON"
twentyvolstandspp_nohem <- subset(twentyvolstandspp,spp !="HEM")
twentyvolstandspp_nohemsp <- subset(twentyvolstandspp_nohem,spp !="SP")
twentyvolstandspp_nohemspcon <- subset(twentyvolstandspp_nohemsp,spp !="CON")
twentyvolstandspp_nocon <- subset(twentyvolstandspp_nohemspcon,spp !="FIR")
colnames(twentyvolstandspp_nocon) <- c("stand", "age", "year", "spp", "vol")
twentycon <- twentyvolstandspp[which(twentyvolstandspp$spp == "HEM"| twentyvolstandspp$spp == "SP"| twentyvolstandspp$spp == "FIR"| twentyvolstandspp$spp == "CON"),] 
twentycon$spp <- "CON"
twentycon <- twentycon %>%
  group_by(stand, age, year, spp) %>%
  summarise(vol = sum(avgstandvol))
twenty_spp_con <- rbind(twentycon, twentyvolstandspp_nocon)
###Combine OV, STM and UNK to "OTHER"
twentyvolstandspp_noov <- subset(twenty_spp_con, spp !="OV") 
twentyvolstandspp_nostm <- subset(twentyvolstandspp_noov, spp !="STM")
twentyvolstandspp_nounk <- subset(twentyvolstandspp_nostm, spp !="UNK")
twentyvolstandspp_noother <- subset(twentyvolstandspp_nounk, spp !="ANGIO")
twentyother <- twenty_spp_con[which(twenty_spp_con$spp =="OV"| twenty_spp_con$spp == "STM"| twenty_spp_con$spp == "UNK"| twenty_spp_con$spp == "ANGIO"),] 
twentyother$spp <- "OTHER"
twentyother <- twentyother %>%
  group_by(stand, age, year, spp) %>%
  summarise(vol = sum(vol))
twenty_spp <- rbind(twentyother, twentyvolstandspp_noother)
###Create column for stand age 
twenty_spp$standage <- paste(twenty_spp$stand, twenty_spp$age)
twenty_spp$standage <- factor(twenty_spp$standage, levels = c("CC2 31", "H6 36", "M6 40", "M5 43", "HB101 50", "H5 53",  "T20 62", "M4 70", "T30 72", "H4 86", "M3 110", "H2 145", "H3 145", "Bowl 300", "Pond 300"))
twenty_spp$spp <- factor(twenty_spp$spp, levels = c("PC", "ASP", "WB", "ASH", "OTHER", "YB", "RM", "SM", "BE", "CON"))
###Create plot
ggplot(data = twenty_spp) + 
  geom_bar_pattern(stat = "identity", aes(x =standage, y = vol, group = stand, pattern = spp, pattern_spacing = spp, 
                                  fill = spp, pattern_density = spp, pattern_angle = spp),
                                  pattern_fill = "black", pattern_size = 0.5, width = 1, colour = "black") + 
  labs(x = "stand & Age", y = (expression(CWD~volume~(m^3/ha)))) +
  scale_x_discrete(labels = function(standage) str_wrap(standage, width = 4)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 125)) + 
  scale_pattern_manual(values = spp.patterns) + 
  scale_pattern_density_manual(values = spp.pattern_density) + 
  scale_pattern_angle_manual(values = spp.pattern_angles) +
  scale_pattern_spacing_manual(values = spp.pattern_spacing) + 
  scale_fill_manual(values = spp.pattern_fills) +  
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15, color = "black")) + 
  theme(axis.title.y = element_text(size = 15, color = "black")) + 
  theme(axis.text.x = element_text(size = 15, color = "black")) + 
  theme(axis.text.y = element_text(size = 15, color = "black")) + 
  theme(legend.text = element_text(size = 15, color = "black")) + 
  theme(legend.title = element_text(size = 15, color = "black")) + 
  theme(panel.border = element_rect(fill = NA))

```

###Species vol as % of total
```{r}
twenty_spp_total <- left_join(twenty_spp, twentyvolstand, by = c("stand", "age", "year"))
twenty_spp_total$percent <- (twenty_spp_total$vol / twenty_spp_total$avgstandvol) * 100
ggplot(data = twenty_spp_total, aes(x =standage, y = percent, group = stand, fill = spp)) + 
  geom_bar(stat = "identity") + 
  labs(x = "stand & Age", y = "CWD volume (% of total)", fill = "Species") +
  scale_x_discrete(labels = function(standage) str_wrap(standage, width = 4)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 101)) + 
  scale_fill_manual(values = spp.colors) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15, color = "black")) + 
  theme(axis.title.y = element_text(size = 15, color = "black")) + 
  theme(axis.text.x = element_text(size = 15, color = "black")) + 
  theme(axis.text.y = element_text(size = 15, color = "black")) + 
  theme(legend.text = element_text(size = 15, color = "black")) + 
  theme(legend.title = element_text(size = 15, color = "black")) + 
  theme(panel.border = element_rect(fill = NA))
```

##Volume calculations with decay class only
```{r}
###Sum vol for each transect of each cluster at OG stands
twentyvoltrandc.og <- twenty.og %>%
  group_by(stand, age, year, cluster, az, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclustdc.og <- twentyvoltrandc.og %>%
  group_by(stand, age, year, cluster, dc) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each stand
twentyvolstanddc.og <- twentyvolclustdc.og %>%
  group_by(stand, age, year, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/4)
###Sum vol for each transect of each cluster at each "normal" stand
###2020
twentyvoltrandc.normies <- twenty.normies %>%
  group_by(stand, age, year, cluster, az, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclustdc.normies <- twentyvoltrandc.normies %>%
  group_by(stand, age, year, cluster, dc) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each stand
twentyvolstanddc.normies <- twentyvolclustdc.normies %>%
  group_by(stand, age, year, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/3)

###2004
ohfourvoltrandc.normies <- ohfour.normies %>%
  group_by(stand, age, year, cluster, az, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
ohfourvolclustdc.normies <- ohfourvoltrandc.normies %>%
  group_by(stand, age, year, cluster, dc) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each "normal" stand
ohfourvolstanddc.normies <- ohfourvolclustdc.normies %>%
  group_by(stand, age, year, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/3)

###Sum vol for each transect of each "cluster" at CC2
###2020
twentyvoltrandc.cc2 <- twenty.cc2 %>%
  group_by(stand, age, year, cluster, az, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclustdc.cc2 <- twentyvoltrandc.cc2 %>%
  group_by(stand, age, year, cluster, dc) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for CC2
twentyvolstanddc.cc2 <- twentyvolclustdc.cc2 %>%
  group_by(stand, age, year, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/6)
###2004
ohfourvoltrandc.cc2.h1 <- ohfour.cc2.h1 %>%
  group_by(stand, age, year, cluster, az, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
ohfourvolclustdc.cc2.h1 <- ohfourvoltrandc.cc2.h1 %>%
  group_by(stand, age, year, cluster, dc) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for CC2
ohfourvolstanddc.cc2.h1 <- ohfourvolclustdc.cc2.h1 %>%
  group_by(stand, age, year, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/6)
###Sum vol for each transect of each cluster at T20
###2020
twentyvoltrandc.t20 <- twenty.t20 %>%
  group_by(stand, age, year, cluster, az, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclustdc.t20 <- twentyvoltrandc.t20 %>%
  group_by(stand, age, year, cluster, dc) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for T20
twentyvolstanddc.t20 <- twentyvolclustdc.t20 %>%
  group_by(stand, age, year, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/8)
###2004
ohfourvoltrandc.t20 <- ohfour.t20 %>%
  group_by(stand, age, year, cluster, az, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, dc) %>%
  summarise(tranvol = (((pi)/(2*cwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
ohfourvolclustdc.t20 <- ohfourvoltrandc.t20 %>%
  group_by(stand, age, year, cluster, dc) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for T20
ohfourvolstanddc.t20 <- ohfourvolclustdc.t20 %>%
  group_by(stand, age, year, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/8)
###Combine all stands again
###2020
twentyvolstanddc <- rbind(twentyvolstanddc.normies, twentyvolstanddc.cc2, twentyvolstanddc.t20, twentyvolstanddc.og)
###2004
ohfourvolstanddc <- rbind(ohfourvolstanddc.normies, ohfourvolstanddc.cc2.h1, ohfourvolstanddc.t20)
###Combine 2004 and 2020 decay class CWD data 
avgvol0420dc<- union(twentyvolstanddc, ohfourvolstanddc)
##Remove "0" dc
twentyvolstanddc <- subset(twentyvolstanddc, dc !="0")
ohfourvolstanddc <- subset(ohfourvolstanddc, dc !="0")
###Remove OG stands
twentyvolstanddc_noog <- twentyvolstanddc[-which(twentyvolstanddc$stand == "Bowl"| twentyvolstanddc$stand == "Pond"),]
###Re-order stands and stand ages
twentyvolstanddc$stand <- factor(twentyvolstanddc$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H4", "M3", "H2", "H3", "Bowl", "Pond"))
twentyvolstanddc$standage <- paste(twentyvolstanddc$stand, twentyvolstanddc$age)
twentyvolstanddc$standage <- factor(twentyvolstanddc$standage, levels = c("CC2 31", "H6 36", "M6 40", "M5 43", "HB101 50", "H5 53",  "T20 62", "M4 70", "T30 72", "H4 86", "M3 110", "H2 145", "H3 145", "Bowl 300", "Pond 300"))
ohfourvolstanddc$stand <- factor(ohfourvolstanddc$stand, levels = c("CC2", "C2", "H6", "M6", "M5", "HB101", "H5", "T20",  "M4", "T30", "H1", "H4", "M3", "H2", "H3"))
ohfourvolstanddc$standage <- paste(ohfourvolstanddc$stand, ohfourvolstanddc$age)
ohfourvolstanddc$standage <- factor(ohfourvolstanddc$standage, levels = c("CC2 15", "C2 16", "H6 20", "M6 24", "M5 27", "HB101 34", "H5 37",  "T20 46", "M4 54", "T30 56", "H1 65", "H4 70", "M3 94", "H2 129", "H3 129"))


```


###Stacked bars of CWD volume by decay class in each DC
```{r}
###2004
###Asign colors to decay classes
dc.colors <- c("tan4", "tan3", "tan2", "lightgoldenrod3", "lightgoldenrod1" )
names(dc.colors) <- c("5", "4", "3", "2", "1")
###Create column for stand age 
ohfourvolstanddc$dc <- factor(ohfourvolstanddc$dc, levels = c("1", "2", "3", "4", "5"))
###Create plot
ggplot(data = ohfourvolstanddc[-which(ohfourvolstanddc$stand == "C2"),], aes(x =standage, y = avgstandvol, group = stand, fill = dc)) + 
  geom_bar(stat = "identity", width = 1) + 
  labs(x = "stand & Age", y = (expression(CWD~volume~(m^3/ha))), fill = "Decay Class") +
  scale_x_discrete(labels = function(standage) str_wrap(standage, width = 4)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 125)) + 
  scale_fill_manual(values = dc.colors) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15, color = "black")) + 
  theme(axis.title.y = element_text(size = 15, color = "black")) + 
  theme(axis.text.x = element_text(size = 15, color = "black")) + 
  theme(axis.text.y = element_text(size = 15, color = "black")) + 
  theme(legend.text = element_text(size = 15, color = "black")) + 
  theme(legend.title = element_text(size = 15, color = "black")) + 
  theme(panel.border = element_rect(fill = NA))
###DC vol as % of total
ohfour_dc_total <- left_join(ohfourvolstanddc, ohfourvolstand, by = c("stand", "age", "year"))
ohfour_dc_total$percent <- (ohfour_dc_total$avgstandvol.x / ohfour_dc_total$avgstandvol.y) * 100
ggplot(data = ohfour_dc_total, aes(x =standage, y = percent, group = stand, fill = dc)) + 
  geom_bar(stat = "identity") + 
  labs(x = "stand & Age", y = "CWD volume (% of total)", fill = "Decay Class") +
  scale_x_discrete(labels = function(standage) str_wrap(standage, width = 4)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 101)) + 
  scale_fill_manual(values = dc.colors) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15, color = "black")) + 
  theme(axis.title.y = element_text(size = 15, color = "black")) + 
  theme(axis.text.x = element_text(size = 15, color = "black")) + 
  theme(axis.text.y = element_text(size = 15, color = "black")) + 
  theme(legend.text = element_text(size = 15, color = "black")) + 
  theme(legend.title = element_text(size = 15, color = "black")) + 
  theme(panel.border = element_rect(fill = NA))

###2020
###Create column for stand age 
twentyvolstanddc$dc <- factor(twentyvolstanddc$dc, levels = c("5", "4", "3", "2", "1"))
###Create plot
ggplot(data = twentyvolstanddc, aes(x =standage, y = avgstandvol, group = stand, fill = dc)) + 
  geom_bar(stat = "identity", width = 1) + 
  labs(x = "stand & Age", y = (expression(CWD~volume~(m^3/ha))), fill = "Decay Class") +
  scale_x_discrete(labels = function(standage) str_wrap(standage, width = 4)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 125)) + 
  scale_fill_manual(values = dc.colors) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15, color = "black")) + 
  theme(axis.title.y = element_text(size = 15, color = "black")) + 
  theme(axis.text.x = element_text(size = 15, color = "black")) + 
  theme(axis.text.y = element_text(size = 15, color = "black")) + 
  theme(legend.text = element_text(size = 15, color = "black")) + 
  theme(legend.title = element_text(size = 15, color = "black")) + 
  theme(panel.border = element_rect(fill = NA))
###DC vol as % of total
twenty_dc_total <- left_join(twentyvolstanddc, twentyvolstand, by = c("stand", "age", "year"))
twenty_dc_total$percent <- (twenty_dc_total$avgstandvol.x / twenty_dc_total$avgstandvol.y) * 100
ggplot(data = twenty_dc_total, aes(x =standage, y = percent, group = stand, fill = dc)) + 
  geom_bar(stat = "identity") + 
  labs(x = "stand & Age", y = "CWD volume (% of total)", fill = "Decay Class") +
  scale_x_discrete(labels = function(standage) str_wrap(standage, width = 4)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 101)) + 
  scale_fill_manual(values = dc.colors) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15, color = "black")) + 
  theme(axis.title.y = element_text(size = 15, color = "black")) + 
  theme(axis.text.x = element_text(size = 15, color = "black")) + 
  theme(axis.text.y = element_text(size = 15, color = "black")) + 
  theme(legend.text = element_text(size = 15, color = "black")) + 
  theme(legend.title = element_text(size = 15, color = "black")) + 
  theme(panel.border = element_rect(fill = NA))
```






###NMDS for CWD
```{r}
###Spread data of vol per species 
data.spread <- spread(avgvol0420sppdc, spp, avgstandvol)
###Change NA to 0
data.spread[is.na(data.spread)] <- 0
###Create column for total
data.spread$total = rowSums(data.spread[5:21])
###Remove rows that total to 0
data.spread2 <- data.spread[-which(data.spread$total == "0"),]
###Remove columns that are not species
data.spread3 <- data.spread2[,-12][,5:ncol(data.spread2[,-12])]
com <- data.spread3
env <- data.spread2[,2:4]
###Matrify data
m.data <- as.matrix(com)
###Run NMDS
set.seed(123)
nmds = metaMDS(m.data, distance = "bray", autotransform = FALSE)
###Plot NMDS
plot(nmds)
###Extract NMDS scores (x and y coordinates)
data.scores = as.data.frame(scores(nmds)$stands)
#Add columns to data frame 
data.scores$stand = data.spread2$stand
data.scores$age = data.spread2$age
data.scores$year = data.spread2$year
data.scores$dc = data.spread2$dc
###Make stand, year, and dc factors
data.scores$stand <- as.factor(data.scores$stand)
data.scores$dc <- as.factor(data.scores$dc)
data.scores$year <- as.factor(data.scores$year)


```

###NMDS model only
###Stress = 0.14
###Generally, stress < 0.05 provides an excellent represention in reduced dimensions, < 0.1 is great, < 0.2 is good, and stress > 0.3 provides a poor representation
```{r}
nmds
```


###Run ENVFIT
```{r}
en = envfit(nmds, env, permutations = 999, na.rm = TRUE)

###Extract variable data
en_coord_cont = as.data.frame(scores(en, "vectors")) * ordiArrowMul(en)
```

Plot NMDS with Variables
```{r}
plot(nmds)
plot(en)
```

###Plot NMDS in GGPLOT
```{r}
ggplot(data.scores, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(data = data.scores, size = 4, stroke = 2, aes(shape = dc, colour = year, fill = age))+ 
  geom_segment(aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2), 
       data = en_coord_cont, size =1, alpha = 0.5, colour = "grey30") +
     geom_text(data = en_coord_cont, aes(x = NMDS1, y = NMDS2), colour = "grey30", 
       fontface = "bold", label = row.names(en_coord_cont)) + 
    scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
    scale_fill_gradient(low = "red", high = "blue") + 
   labs(x = "NMDS1", colour = "Sampling Year", y = "NMDS2", shape = "Decay Class", fill = "Age") + 
  theme_bw()
```

###Permanova
```{r}
stand.manova <- adonis(com ~ stand, method = "euclidean", data= data.spread2)
stand.manova

age.manova <- adonis(com ~ age, method = "euclidean", data= data.spread2)
age.manova

year.manova <- adonis(com ~ year, method = "euclidean", data= data.spread2)
year.manova

dc.manova <- adonis(com ~ dc, method = "euclidean", data= data.spread2)
dc.manova

```


###Pearson correlation coefficients
```{r}
###Pearson correlation matrix of age, year, and site cwdvol
round(cor(cwd_vol_se[2:4], method = "pearson" ),2)
###Pearson correlation matrix of age, year, dc, and piece cwdvol
round(cor(coarse[c(1,3,7,16)], method = "pearson"), 2)
###Pearson correlation matrix of age, year, dc,  and piece cwdvol
round(cor(avgvol0420dc[2:5], method = "pearson"), 2)

```

###Comparing volume of CWD in H2 and H3 with the volume of CWD in the OG sites 
```{r}
###Seperate years
ohfour_cwd <- cwd_vol_se[cwd_vol_se$year == "2004",]
twenty_cwd <- cwd_vol_se[cwd_vol_se$year == "2020",]
ohfour_groups <- left_join(ohfour_cwd, ohfour_site_group, by = "site")
twenty_groups <- left_join(twenty_cwd, twenty_site_group, by = "site")
###Seperate groups
ohfour.residual <- ohfour_groups[ohfour_groups$group == "RESIDUAL",]
ohfour.early <- ohfour_groups[ohfour_groups$group == "EARLY",]
ohfour.mixed <- ohfour_groups[ohfour_groups$group == "MIXED",]
twenty.residual <- twenty_groups[twenty_groups$group == "RESIDUAL",]
twenty.early <- twenty_groups[twenty_groups$group == "EARLY",]
twenty.mixed <- twenty_groups[twenty_groups$group == "MIXED",]
twenty.old <- twenty_groups[twenty_groups$group == "OLD",]
###Separate sites
H2_twenty_cwd <- twenty.mixed[twenty.mixed$site == "H2",]
H3_twenty_cwd <- twenty.mixed[twenty.mixed$site == "H3",]
H2_ohfour_cwd <- ohfour.mixed[ohfour.mixed$site == "H2",]
H3_ohfour_cwd <- ohfour.mixed[ohfour.mixed$site == "H3",]
###Add together as H2_H3
H2_H3_twenty_cwd <- rbind(H2_twenty_cwd, H3_twenty_cwd)
H2_H3_ohfour_cwd <- rbind(H2_ohfour_cwd, H3_ohfour_cwd)

###Separate Bowl and Pond sites for OG sites
Bowl_cwd <- twenty.old[twenty.old$site == "Bowl",]
Pond_cwd <- twenty.old[twenty.old$site == "Pond",]
###Add together as OG
OG_cwd <- rbind(Bowl_cwd, Pond_cwd)
###Combine H2, H3, Bowl, and Pond
old_sites <- rbind(H2_H3_twenty_cwd, OG_cwd)

```


###T-tests for differences between groups

```{r}
###2020
t.test(H2_H3_twenty_cwd$cwdvol,OG_cwd$cwdvol)
t.test(H2_H3_ohfour_cwd$cwdvol, OG_cwd$cwdvol)


H2_ohfour_coarse <- ohfour[ohfour$site == "H2",]
H3_ohfour_coarse <- ohfour[ohfour$site == "H3",]
H2_twenty_coarse <- twenty[twenty$site == "H2",]
H3_twenty_coarse <- twenty[twenty$site == "H3",]
Bowl_twenty_coarse <- twenty[twenty$site == "Bowl",]
Pond_twenty_coarse <- twenty[twenty$site == "Pond",]

###2020
###Number of pieces in old sites greater than 40 cm dbh at intersection
sum(H2_twenty_coarse$diamint >40)
sum(H3_twenty_coarse$diamint >40)
sum(Bowl_twenty_coarse$diamint >40)
sum(Pond_twenty_coarse$diamint >40)
###Number of pieces in old sites greater than 40 cm dbh at large-end
sum(H2_twenty_coarse$diaml >40)
sum(H3_twenty_coarse$diaml >40)
sum(Bowl_twenty_coarse$diaml >40)
sum(Pond_twenty_coarse$diaml >40)

###2004
###Number of pieces in old sites greater than 40 cm dbh at intersection
sum(H2_ohfour_coarse$diamint >40)
sum(H3_ohfour_coarse$diamint >40)
###Number of pieces in old sites greater than 40 cm dbh at large-end
sum(H2_ohfour_coarse$diaml >40)
sum(H3_ohfour_coarse$diaml >40)
```


###Cumulative Frequency Plots
```{r}
###Format data for cumulative frequencies of CWD
cwd_freq_data = coarse[1:12]
cwd_freq_data$year = factor(cwd_freq_data$year, levels = c("2004", "2020"))
H2cwd_freq_data = cwd_freq_data[cwd_freq_data$site == "H2",]
H3cwd_freq_data = cwd_freq_data[cwd_freq_data$site == "H3",]
Bowlcwd_freq_data = cwd_freq_data[cwd_freq_data$site == "Bowl",]
Pondcwd_freq_data = cwd_freq_data[cwd_freq_data$site == "Pond",]
oldcwd_freq_data = rbind(H2cwd_freq_data, H3cwd_freq_data, Bowlcwd_freq_data, Pondcwd_freq_data)
oldcwd_freq_data$site <- factor(oldcwd_freq_data$site, levels = c("Bowl", "Pond", "H2", "H3"))
###Cumalitive Frequency Diagram of CWD largest diameter for all sites (use "y = 1-..y..," in aes to reverse direction)
ggplot(cwd_freq_data, aes(diaml,  color = site, linetype = year)) + 
  stat_ecdf(geom = "smooth", size = 1) + 
  scale_y_continuous(breaks=seq(0,1,0.1), labels = seq(0,100,10)) + 
  scale_x_continuous(expand = c(0, 0), limits = c(7.5,100)) + 
  scale_color_discrete() + 
  scale_linetype_discrete() + 
  labs(x = "Large-end CWD diameter (cm)", y = "%", color = "Site", linetype = "Year") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA))

cwd_freq_data$age[cwd_freq_data$site == "Bowl" | cwd_freq_data$site == "Pond"] <- 180
cwd_freq_data$siteage <- paste(cwd_freq_data$site,cwd_freq_data$age)

cwd.freq.plot <- ggplot(cwd_freq_data, aes(diaml,  color = age, group = siteage)) + 
  stat_ecdf(geom = "smooth", size = 1, aes(linetype = factor(ifelse(site=="Bowl"|site=="Pond", 2,1))), show.legend = TRUE) + 
  scale_y_continuous(breaks=seq(0,1,0.1), labels = seq(0,100,10)) + 
  scale_x_continuous(expand = c(0, 0), limits = c(7.5,80)) + 
  scale_color_gradient2() +
  labs(x = "Large-end CWD diameter (cm)", y = "Cumulative Frequency (%)", color = "Age") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15, color = "black")) + 
  theme(axis.title.y = element_text(size = 15, color = "black")) + 
  theme(axis.text.x = element_text(size = 15, color = "black")) + 
  theme(axis.text.y = element_text(size = 15, color = "black")) + 
  theme(legend.text = element_text(size = 15, color = "black")) + 
  theme(legend.title = element_text(size = 15, color = "black")) + 
  theme(panel.border = element_rect(fill = NA))
cwd.freq.plot
cwd.freq.plot + facet_wrap(~year) + 
  theme(panel.spacing.x = unit(1, "lines")) + 
  theme(strip.text = element_text(size = 25)) +
  theme(strip.background = element_blank()) + 
  theme(panel.border = element_rect(fill = NA))


###Cumalitive Frequency Diagram of CWD largest diameter for old sites (use "y = 1-..y..," in aes to reverse direction)
H2.duration = H2cwd_freq_data$diaml
H2.breaks = seq(7.5, 80, by = 8)
H2.cut = cut(H2.duration, H2.breaks, right = FALSE)
H2.freq = table(H2.cut)
H2.freq <- data.frame()
H2.sum <- sum(H2.freq)
H2.cumfreq0 = c(0, cumsum(H2.freq))

plot(H2.breaks, H2.cumfreq0)
lines(H2.breaks, H2.cumfreq0)





oldcwd_freq<- ggplot(oldcwd_freq_data, aes(diaml,  color = site, linetype = year)) + 
  stat_ecdf(geom = "smooth", size = 1) + 
  geom_hline(aes(yintercept = 0.80)) + 
  geom_vline(aes(xintercept = 30)) + 
  annotate(geom = "point", shape = 23, size = 3, fill = "red", x = 17.1, y = 0.80) + 
    annotate(geom = "text", label = "17", x = 17.1, y = 0.82) + 
  annotate(geom = "point", shape = 23, size = 3, fill = "red", x = 21.1, y = 0.80) + 
    annotate(geom = "text", label = "21", x = 21.1, y = 0.82) + 
  annotate(geom = "point", shape = 23, size = 3, fill = "gold", x = 24.7, y = 0.80) + 
    annotate(geom = "text", label = "25", x = 24.7, y = 0.82) + 
  annotate(geom = "point", shape = 23, size = 3, fill = "green", x = 29.0, y = 0.80) + 
    annotate(geom = "text", label = "29", x = 29.0, y = 0.82) + 
  annotate(geom = "point", shape = 23, size = 3, fill = "green", x = 31.8, y = 0.80) + 
    annotate(geom = "text", label = "32", x = 31.8, y = 0.82) + 
  annotate(geom = "point", shape = 23, size = 3, fill = "black", x = 35.8, y = 0.80) + 
    annotate(geom = "text", label = "36", x = 35.8, y = 0.82) + 
  scale_y_continuous(breaks=seq(0,1,0.1), labels = seq(0,100,10)) + 
  scale_x_continuous(expand = c(0, 0), limits = c(7.5,50)) + 
  scale_color_manual(values = c("black", "gold", "red", "green")) + 
  scale_linetype_discrete() + 
  labs(x = "Large-end CWD diameter (cm)", y = "%", color = "Site", linetype = "Year") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA))
oldcwd_freq  

oldcwd_freq<- ggplot(oldcwd_freq_data, aes(diaml,  color = site, linetype = year)) + 
  stat_ecdf(geom = "smooth", size = 1) + 
  geom_vline(aes(xintercept = 30)) + 
  annotate(geom = "point", shape = 23, size = 3, fill = "black", x = 30, y = 0.62) + 
    annotate(geom = "text", label = "62", x = 31, y = 0.62) + 
  annotate(geom = "point", shape = 23, size = 3, fill = "green", x = 30, y = 0.76) + 
    annotate(geom = "text", label = "76", x = 31, y = 0.76) +
  annotate(geom = "point", shape = 23, size = 3, fill = "green", x = 30, y = 0.87) + 
    annotate(geom = "text", label = "87", x = 31, y = 0.87) + 
  annotate(geom = "point", shape = 23, size = 3, fill = "gold", x = 30, y = 0.875) + 
  annotate(geom = "point", shape = 23, size = 3, fill = "red", x = 30, y = 0.895) + 
    annotate(geom = "text", label = "89", x = 31, y = 0.895) + 
  annotate(geom = "point", shape = 23, size = 3, fill = "red", x = 30, y = 0.905) + 
    annotate(geom = "text", label = "90", x = 31, y = 0.915) +
  scale_y_continuous(breaks=seq(0,1,0.1), labels = seq(0,100,10)) + 
  scale_x_continuous(expand = c(0, 0), limits = c(7.5,50)) + 
  scale_color_manual(values = c("black", "gold", "red", "green")) + 
  scale_linetype_discrete() + 
  labs(x = "Large-end CWD diameter (cm)", y = "%", color = "Site", linetype = "Year") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA))
oldcwd_freq  

###X-axis expanded to 100 cm
oldcwd_freq<- ggplot(oldcwd_freq_data, aes(diaml,  color = site, linetype = year)) + 
  stat_ecdf(geom = "smooth", size = 1) + 
  geom_vline(aes(xintercept = 50)) + 
  annotate(geom = "point", shape = 23, size = 3, fill = "green", x = 50, y = 0.97) + 
  annotate(geom = "text", label = "97", x = 51, y = 0.97) +
  annotate(geom = "point", shape = 23, size = 3, fill = "gold", x = 50, y = 0.965) + 
  scale_y_continuous(breaks=seq(0,1,0.1), labels = seq(0,100,10)) + 
  scale_x_continuous(expand = c(0, 0), limits = c(7.5,100)) + 
  scale_color_manual(values = c("black", "gold", "red", "green")) + 
  scale_linetype_discrete() + 
  labs(x = "Large-end CWD diameter (cm)", y = "%", color = "Site", linetype = "Year") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA))
oldcwd_freq 


h <- hist(H2cwd_freq_data$diaml, plot = FALSE)
plot(h, ylim = c(0, sum(h$counts)))
lines(h$mids, cumsum(h$counts))


```



###Kolmogorov-Smirnov Test to determine if CWD follows the same distribution in the oldest chrono and true OG sites
```{r}
###Subset data using large-end diameter
H2_ohfour_ks.data <- H2_ohfour_coarse[c(1:3,6,8:9)]
H3_ohfour_ks.data <- H3_ohfour_coarse[c(1:3,6,8:9)]
H2_twenty_ks.data <- H2_twenty_coarse[c(1:3,6,8:9)]
H3_twenty_ks.data <- H3_twenty_coarse[c(1:3,6,8:9)]
Bowl_twenty_ks.data <- Bowl_twenty_coarse[c(1:3,6,8:9)]
Pond_twenty_ks.data <- Pond_twenty_coarse[c(1:3,6,8:9)]


###First, see if distributions are the same at H2 and H3 in 2004 (p = 0.75)
ks.test(H2_ohfour_ks.data$diaml, H3_ohfour_ks.data$diaml)
###H2 and H3 in 2020 (p = 0.20)
ks.test(H2_twenty_ks.data$diaml, H3_twenty_ks.data$diaml)
###Bowl and Pond (p = 0.28)
ks.test(Bowl_twenty_ks.data$diaml, Pond_twenty_ks.data$diaml)

###H2 and H3 combined vs Bowl and Pond combined (p = 0.71)
H2_H3_ks.data <- rbind(H2_twenty_ks.data, H3_twenty_ks.data )
Bowl_Pond_ks.data <- rbind(Bowl_twenty_ks.data, Pond_twenty_ks.data )
ks.test(H2_H3_ks.data$diaml, Bowl_Pond_ks.data$diaml)

###H2 2020 vs Bowl and Pond (p = 0.13)
ks.test(H2_twenty_ks.data$diaml, Bowl_Pond_ks.data$diaml)
###H3 2020 vs Bowl and Pond (p = 0.33)
ks.test(H3_twenty_ks.data$diaml, Bowl_Pond_ks.data$diaml)

###H2 2004  vs Bowl (p = 0.20)
ks.test(H2_ohfour_ks.data$diaml, Bowl_twenty_ks.data$diaml)
###H2 2020  vs Bowl (p = 0.02), alternative CDF of H2 lies above Bowl
ks.test(H2_twenty_ks.data$diaml, Bowl_twenty_ks.data$diaml, alternative = "greater")

###H2 2004  vs Pond (p = 1.0)
ks.test(H2_ohfour_ks.data$diaml, Pond_twenty_ks.data$diaml)
###H2 2020 vs Pond (p = 0.85)
ks.test(H2_twenty_ks.data$diaml, Pond_twenty_ks.data$diaml)

###H3 2004 vs Bowl (p = 0.49)
ks.test(H3_ohfour_ks.data$diaml, Bowl_twenty_ks.data$diaml)
###H3 2020 vs Bowl (p = 0.91)
ks.test(H3_twenty_ks.data$diaml, Bowl_twenty_ks.data$diaml)
###H3 2004 to vs Pond (p = 0.81)
ks.test(H3_ohfour_ks.data$diaml, Pond_twenty_ks.data$diaml)
###H3 2020 to vs Pond (p = 0.17)
ks.test(H3_twenty_ks.data$diaml, Pond_twenty_ks.data$diaml)



### r sample K.S tests
u1.down <- unlist(H2_twenty_ks.data[6])
u2.down <- unlist(H3_twenty_ks.data[6])
u3.down <- unlist(Bowl_twenty_ks.data[6])
u4.down <- unlist(Pond_twenty_ks.data[6])
y.down <- c(u1.down, u2.down, u3.down, u4.down)
g.down <- as.factor(c(rep(1,22), rep(2,24), rep(3,25), rep(4,25)))
ad.test(u1.down, u2.down, u3.down, u4.down, method = "exact", dist = FALSE, Nsim = 1000)

nrow(Pond_twenty_ks.data[6])
Pond_twenty_ks.data[6]
```


###Perform Anderson-Darling Normality Test. Null hypothesis is that the data is normal. 
```{r}
###H2 (p = 0.01, data does not fit normal distribution)
ad.test(H2_twenty_ks.data$diaml)
plot(H2_twenty_ks.data$diaml, pch = 15)
###H3 (p = 0.003, data does not fit normal distribution)
ad.test(H3_twenty_ks.data$diaml)
plot(H3_twenty_ks.data$diaml, pch = 15)
###Bowl (p = 0.37, data does fit normal distribution)
ad.test(Bowl_twenty_ks.data$diaml)
plot(Bowl_twenty_ks.data$diaml, pch = 15)
###Pond (p = 0.0003, data does not fit normal distribution)
ad.test(Pond_twenty_ks.data$diaml)
plot(Pond_twenty_ks.data$diaml, pch = 15)
```




###Volume calculations for FWD - <7.6cm
```{r}
fine<- read.csv("chronosequence_fwd.csv")
###Re-name columns
colnames(fine) <-c("year", "stand", "age", "cluster", "az", "spp", "dc", "diamint", "length") 
###Replace Na with O
fine$dc[is.na(fine$dc)] <- 0
fine$diamint[is.na(fine$diamint)] <- 0
fine$length[is.na(fine$length)] <- 0
###Square Diameters
fine$diamintsq <- fine$diamint^2
###Calculate volume (m3) per piece of CWD
fine$piecevol <- ((pi/8)*(fine$diamintsq)*(fine$length))/10000
###Volume of each piece/piece length
fine$piecevl <- fine$piecevol/fine$length
###Replace NaN with O
fine$piecevl[is.nan(fine$piecevl)] <- 0
###Separate into years
twentyfine <- fine[fine$year == "2020",] 
ohfourfine <- fine[fine$year == "2004",]
###Transect lengths (m)
fwdtrans <- 5
M6fwdtrans <- 15
###Volume Calculations
###Subset old growth stands
twentyfine.og <- twentyfine[which(twentyfine$stand == "Bowl"| twentyfine$stand == "Pond"),]
###Sum vol for each transect of each cluster at OG stands
twentyvoltranfine.og <- twentyfine.og %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(tranvol = (((pi)/(2*fwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclustfine.og <- twentyvoltranfine.og %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each stand
twentyvolstandfine.og <- twentyvolclustfine.og %>%
  group_by(stand, age, year) %>%
  summarise(avgstandvol = sum(avgclustvol)/4)
###Subset "normal" stands
twentyfine.normies <- twentyfine[which(twentyfine$stand == "H2"| twentyfine$stand == "H3"| twentyfine$stand == "H4"| twentyfine$stand == "H5"| 
                                 twentyfine$stand == "H6"| twentyfine$stand == "M3"| twentyfine$stand == "M4"| twentyfine$stand == "M5"| twentyfine$stand == "T30"|twentyfine$stand == "HB101"),]
ohfourfine.normies <- ohfourfine[which(ohfourfine$stand == "C2"| ohfourfine$stand == "H2"| ohfourfine$stand == "H3"| ohfourfine$stand == "H4"| ohfourfine$stand == "H5"| 
                                 ohfourfine$stand == "H6"| ohfourfine$stand == "M3"| ohfourfine$stand == "M4"| ohfourfine$stand == "M5"| ohfourfine$stand == "T30"|ohfourfine$stand == "HB101"),]
###Sum vol for each transect of each cluster at each "normal" stand
###2020
twentyvoltranfine.normies <- twentyfine.normies %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(tranvol = (((pi)/(2*fwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclustfine.normies <- twentyvoltranfine.normies %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each stand
twentyvolstandfine.normies <- twentyvolclustfine.normies %>%
  group_by(stand, age, year) %>%
  summarise(avgstandvol = sum(avgclustvol)/3)
###2004
ohfourvoltranfine.normies <- ohfourfine.normies %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(tranvol = (((pi)/(2*fwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
ohfourvolclustfine.normies <- ohfourvoltranfine.normies %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each "normal" stand
ohfourvolstandfine.normies <- ohfourvolclustfine.normies %>%
  group_by(stand, age, year) %>%
  summarise(avgstandvol = sum(avgclustvol)/3)
###M6 (longer transect)
M6twentyfwd <- twentyfine[which(twentyfine$stand == "M6"),]
M6ohfourfwd <- ohfourfine[which(ohfourfine$stand == "M6"),]
###2020
M6twentyvoltranfine <- M6twentyfwd %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(tranvol = (((pi)/(2*M6fwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
M6twentyvolclustfine <- M6twentyvoltranfine %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each "normal" stand
M6twentyvolstandfine <- M6twentyvolclustfine %>%
  group_by(stand, age, year) %>%
  summarise(avgstandvol = sum(avgclustvol)/3)
###2004
M6ohfourvoltranfine <- M6ohfourfwd %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(tranvol = (((pi)/(2*M6fwdtrans))*sumvl)*10000)
M6ohfourvoltranfine <- M6ohfourfwd %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(tranvol = (((pi)/(2*M6fwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
M6ohfourvolclustfine <- M6ohfourvoltranfine %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each "normal" stand
M6ohfourvolstandfine <- M6ohfourvolclustfine %>%
  group_by(stand, age, year) %>%
  summarise(avgstandvol = sum(avgclustvol)/3)
###Odd balls = CC2,T20 
###CC2: AB, BC, CD, DA, EF, GH
twentyfine.cc2 <- twentyfine[which(twentyfine$stand == "CC2"),]
ohfourfine.cc2.h1 <- ohfourfine[which(ohfourfine$stand == "CC2"|ohfourfine$stand == "H1"),]
###Sum vol for each transect of each "cluster" at CC2
###2020
twentyvoltranfine.cc2 <- twentyfine.cc2 %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(tranvol = (((pi)/(2*fwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclustfine.cc2 <- twentyvoltranfine.cc2 %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for CC2
twentyvolstandfine.cc2 <- twentyvolclustfine.cc2 %>%
  group_by(stand, age, year) %>%
  summarise(avgstandvol = sum(avgclustvol)/6)
###2004
ohfourvoltranfine.cc2.h1 <- ohfourfine.cc2.h1 %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(tranvol = (((pi)/(2*fwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
ohfourvolclustfine.cc2.h1 <- ohfourvoltranfine.cc2.h1 %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for CC2
ohfourvolstandfine.cc2.h1 <- ohfourvolclustfine.cc2.h1 %>%
  group_by(stand, age, year) %>%
  summarise(avgstandvol = sum(avgclustvol)/6)
###T20: AB, BC, CD, CE, DA, DF, GH, GI
twentyfine.t20 <- twentyfine[which(twentyfine$stand == "T20"),]
ohfourfine.t20 <- ohfourfine[which(ohfourfine$stand == "T20"),]
###Sum vol for each transect of each cluster at T20
###2020
twentyvoltranfine.t20 <- twentyfine.t20 %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(tranvol = (((pi)/(2*fwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclustfine.t20 <- twentyvoltranfine.t20 %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for T20
twentyvolstandfine.t20 <- twentyvolclustfine.t20 %>%
  group_by(stand, age, year) %>%
  summarise(avgstandvol = sum(avgclustvol)/8)
###2004
ohfourvoltranfine.t20 <- ohfourfine.t20 %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az) %>%
  summarise(tranvol = (((pi)/(2*fwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
ohfourvolclustfine.t20 <- ohfourvoltranfine.t20 %>%
  group_by(stand, age, year, cluster) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for T20
ohfourvolstandfine.t20 <- ohfourvolclustfine.t20 %>%
  group_by(stand, age, year) %>%
  summarise(avgstandvol = sum(avgclustvol)/8)
###Combine all stands again
###2020
twentyvolstandfine <- rbind(twentyvolstandfine.normies, M6twentyvolstandfine, twentyvolstandfine.cc2, twentyvolstandfine.t20, twentyvolstandfine.og)
###2004
ohfourvolstandfine <- rbind(ohfourvolstandfine.normies, M6ohfourvolstandfine, ohfourvolstandfine.cc2.h1, ohfourvolstandfine.t20)
###Combine both years
stand_fwd <- rbind(ohfourvolstandfine, twentyvolstandfine)
avgvol0420<- union(twentyvolstand, ohfourvolstand)
###Removing OG stands
avgvol0420_noog <- avgvol0420[-which(avgvol0420$stand == "Bowl"| avgvol0420$stand == "Pond"),]
avgvol0420_noog$stand <- factor(avgvol0420_noog$stand, levels = c("CC2", "C2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3"))

###Calculate SE of FWD volume (m3/ha) in each stand
###OG
###2020
twentyvolfine_se.og <- twentyvoltranfine.og %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranvol)/sqrt(12))
###Normies
###2020
twentyvolfine_se.normies <- twentyvoltranfine.normies %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranvol)/sqrt(9))
###2004
ohfourvolfine_se.normies <- ohfourvoltranfine.normies %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranvol)/sqrt(9))
###M6
###2020
twentyvolfine_se.m6 <- M6twentyvoltranfine %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranvol)/sqrt(9))
###2004
ohfourvolfine_se.m6 <- M6ohfourvoltranfine %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranvol)/sqrt(9))
###CC2 and H1
###2020
twentyvolfine_se.cc2 <- twentyvoltranfine.cc2 %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranvol)/sqrt(6))
###2004
ohfourvolfine_se.cc2.h1 <- ohfourvoltranfine.cc2.h1 %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranvol)/sqrt(6))
###T20
###2020
twentyvolfine_se.t20 <- twentyvoltranfine.t20 %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranvol)/sqrt(8))
###2004
ohfourvolfine_se.t20 <- ohfourvoltranfine.t20 %>%
  group_by(stand, age, year) %>%
  summarise(se = sd(tranvol)/sqrt(8))
###Combine all stands
###2020
twentyvolfwd_se <- rbind(twentyvolfine_se.og, twentyvolfine_se.m6, twentyvolfine_se.normies, twentyvolfine_se.cc2, twentyvolfine_se.t20)
###2004
ohfourvolfwd_se <- rbind(ohfourvolfine_se.normies, ohfourvolfine_se.m6, ohfourvolfine_se.cc2.h1, ohfourvolfine_se.t20)
###Combine both years
volfwd_se <- rbind(twentyvolfwd_se, ohfourvolfwd_se)
###Combine FWD volume and SE
fwd_vol_se <- left_join(stand_fwd, volfwd_se, by = c("stand", "age", "year"))
colnames(fwd_vol_se) <- c("stand", "age", "year", "fwdvol", "fwdse")
fwd_vol_se$stand <- factor(fwd_vol_se$stand, levels = c("CC2", "C2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))
###Removing OG stands
fwd_vol_se_noog <- fwd_vol_se[-which(fwd_vol_se$stand == "Bowl"| fwd_vol_se$stand == "Pond"),]
###Re-order stands
fwd_vol_se$stand <- factor(fwd_vol_se$stand, levels = c("CC2", "C2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))
fwd_vol_se$age[fwd_vol_se$stand == "Bowl"|fwd_vol_se$stand == "Pond"] <- 180
```

###Figure showing progression of FWD volume (m3/ha) for each stand from 2004 to 2020
```{r}
ggplot(data = fwd_vol_se, aes(x = age, y = fwdvol, group = stand, color = stand)) + 
  geom_point(size = 2) + 
  geom_errorbar(aes(ymin=fwdvol-fwdse, ymax=fwdvol+fwdse), position = position_dodge()) +
  geom_line(size = 1) + 
  labs(x = "stand Age", y = (expression(FWD~volume~(m^3/ha))), color = "stand") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,200)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(-1, 20)) + 
  scale_color_manual(values = standcolors) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15, color = "black")) + 
  theme(axis.title.y = element_text(size = 15, color = "black")) + 
  theme(axis.text.x = element_text(size = 15, color = "black")) + 
  theme(axis.text.y = element_text(size = 15, color = "black")) + 
  theme(legend.text = element_text(size = 15, color = "black")) + 
  theme(legend.title = element_text(size = 15, color = "black")) + 
  theme(panel.border = element_rect(fill = NA))

```

###Add coarse and fine volumes 
```{r}
cwd_vol_se$age[cwd_vol_se$stand == "Bowl"|cwd_vol_se$stand == "Pond"] <- 180
volcomb <- left_join(cwd_vol_se, fwd_vol_se, by = c("stand", "age", "year"))
###All but OG
volcomb_noog <- left_join(cwd_vol_se_noog, fwd_vol_se_noog, by = c("stand", "age", "year"))
###Add coarse and fine to make a total volume m3/ha column 
volcomb$totalvol <- volcomb$cwdvol + volcomb$fwdvol
volcomb_noog$totalvol <- volcomb_noog$cwdvol + volcomb_noog$fwdvol
volcomb$totalse <- volcomb$cwdse + volcomb$fwdse
###Seperate years
volcomb_04 <- volcomb[volcomb$year == "2004",]
volcomb_20 <- volcomb[volcomb$year == "2020",]
volcomb_noog04 <- volcomb_noog[volcomb_noog$year == "2004",]
volcomb_noog20 <- volcomb_noog[volcomb_noog$year == "2020",]
###Create column identifier for age and stand
volcomb_noog04$agestand <- paste(volcomb_noog04$age, "\n" ,volcomb_noog04$stand)
volcomb_noog04$agestand <- factor(volcomb_noog04$agestand, levels = c("15 \n CC2", "16 \n C2", "20 \n H6", "24 \n M6", "27 \n M5", "34 \n HB101", "37 \n H5", "46 \n T20", "54 \n M4", "56 \n T30", "65 \n H1", "70 \n H4", "94 \n M3", "129 \n H2", "129 \n H3"))
volcomb_noog20$agestand <- paste(volcomb_noog20$age, "\n" ,volcomb_noog20$stand)
volcomb_noog20$agestand <- factor(volcomb_noog20$agestand, levels = c("31 \n CC2", "36 \n H6", "40 \n M6", "43 \n M5", "50 \n HB101", "53 \n H5", "62 \n T20", "70 \n M4", "72 \n T30", "86 \n H4", "110 \n M3", "145 \n H2", "145 \n H3"))


###Seperate old stands
H2.ohfour.total.volume <- volcomb_04[volcomb_04$stand == "H2",]
H3.ohfour.total.volume <- volcomb_04[volcomb_04$stand == "H3",]
H2.H3.ohfour.total.volume <- rbind(H2.ohfour.total.volume, H3.ohfour.total.volume)
H2.twenty.total.volume <- volcomb_20[volcomb_20$stand == "H2",]
H3.twenty.total.volume <- volcomb_20[volcomb_20$stand == "H3",]
H2.H3.twenty.total.volume <- rbind(H2.twenty.total.volume, H3.twenty.total.volume)
Bowl.twenty.total.volume <- volcomb_20[volcomb_20$stand == "Bowl",]
Pond.twenty.total.volume <- volcomb_20[volcomb_20$stand == "Pond",]
Bowl.Pond.twenty.total.volume <- rbind(Bowl.twenty.total.volume, Pond.twenty.total.volume)
###T-test between H2 and H3 in 2004 vs Bowl and Pond total volume in 2020 (p = 0.30)
t.test(H2.H3.ohfour.total.volume$totalvol,Bowl.Pond.twenty.total.volume$totalvol )
###T-test between H2 and H3 in 2020 vs Bowl and Pond total volume in 2020 (p = 0.58)
t.test(H2.H3.twenty.total.volume$totalvol,Bowl.Pond.twenty.total.volume$totalvol )
```


###Total volume regression
```{r}
totalvol.20.lm <- lm(volcomb_20$age~volcomb_20$totalvol)
summary(totalvol.20.lm)
cf.totalvol.20.lm <- coef(totalvol.20.lm)
cf.totalvol.20.lm
totalvol.20.int <- cf.totalvol.20.lm[1]
totalvol.20.slope <- cf.totalvol.20.lm[2]
ggplot(data =volcomb_20, aes(x = age, y = totalvol)) + 
  geom_point() + 
  geom_abline(slope = totalvol.20.slope, intercept = totalvol.20.int, size = 1, color = "black") + 
  annotate("text", x = 50, y = 100, label = paste("R^2 ==", 
          format(summary(totalvol.20.lm)$r.squared, digits = 3)), parse = TRUE, size = 4) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15, color = "black")) + 
  theme(axis.title.y = element_text(size = 15, color = "black")) + 
  theme(axis.text.x = element_text(size = 15, color = "black")) + 
  theme(axis.text.y = element_text(size = 15, color = "black")) + 
  theme(legend.text = element_text(size = 15, color = "black")) + 
  theme(legend.title = element_text(size = 15, color = "black")) + 
  theme(panel.border = element_rect(fill = NA))
```


###Set year colors for dwd
```{r}
dwd.year.colors <- c("#009E73", "#D55E00")
names(dwd.year.colors) <- c("2004", "2020")
```

###Progression of total vol
```{r}
ggplot(data = volcomb[-which(volcomb$stand == "C2"),], aes(x = age, y = totalvol, group = stand, color = factor(year))) + 
  geom_point(size = 2) + 
  geom_errorbar(aes(ymin=totalvol-totalse, ymax=totalvol+totalse), size = 1.2, position = position_dodge()) +
  geom_line(size = 1.2, color = "black") + 
  labs(x = "Stand Age", y = (expression(Total~DWD~volume~(m^3/ha))), color = "Sampling year") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,200)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 155)) + 
  scale_color_manual(values = dwd.year.colors) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 20, color = "black")) + 
  theme(axis.title.y = element_text(size = 20, color = "black")) + 
  theme(axis.text.x = element_text(size = 20, color = "black")) + 
  theme(axis.text.y = element_text(size = 20, color = "black")) + 
  theme(legend.text = element_text(size = 20, color = "black")) + 
  theme(legend.title = element_text(size = 20, color = "black")) + 
  theme(panel.border = element_rect(fill = NA)) + 
  annotate("text", x = 160, y = 0, label = "~", size = 5, angle = 90) +
  annotate("text", x = 170, y = 0, label = "~", size = 5, angle = 90) +
  annotation_custom(segmentsGrob(gp = gpar(col = "black", lwd = 1)), xmin = 180, xmax = 180, ymin = 0, ymax = -.40) +
  annotation_custom(textGrob("Uncut", gp = gpar(col = "black", fontsize = 20)), xmin = 180, xmax = 180, ymin = -4, ymax = -4 ) + 
  coord_cartesian(clip = "off")
```


##
###FWD Biomass
#
```{r}
###Volume Calculations for species and dc
###Sum vol for each transect of each cluster at OG stands
twentyvoltranfine.og.sppdc <- twentyfine.og %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*fwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclustfine.og.sppdc <- twentyvoltranfine.og.sppdc %>%
  group_by(stand, age, year, cluster, spp, dc) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each stand
twentyvolstandfine.og.sppdc <- twentyvolclustfine.og.sppdc %>%
  group_by(stand, age, year, spp, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/4)

###Sum vol for each transect of each cluster at each "normal" stand
###2020
twentyvoltranfine.normies.sppdc <- twentyfine.normies %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*fwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclustfine.normies.sppdc <- twentyvoltranfine.normies.sppdc %>%
  group_by(stand, age, year, cluster, spp, dc) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each stand
twentyvolstandfine.normies.sppdc <- twentyvolclustfine.normies.sppdc %>%
  group_by(stand, age, year, spp, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/3)
###2004
ohfourvoltranfine.normies.sppdc <- ohfourfine.normies %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*fwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
ohfourvolclustfine.normies.sppdc <- ohfourvoltranfine.normies.sppdc %>%
  group_by(stand, age, year, cluster, spp, dc) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each "normal" stand
ohfourvolstandfine.normies.sppdc <- ohfourvolclustfine.normies.sppdc %>%
  group_by(stand, age, year, spp, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/3)
###2020
M6twentyvoltranfine.sppdc <- M6twentyfwd %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*M6fwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
M6twentyvolclustfine.sppdc <- M6twentyvoltranfine.sppdc %>%
  group_by(stand, age, year, cluster, spp, dc) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each "normal" stand
M6twentyvolstandfine.sppdc <- M6twentyvolclustfine.sppdc %>%
  group_by(stand, age, year, spp, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/3)
###2004
M6ohfourvoltranfine.sppdc <- M6ohfourfwd %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*M6fwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
M6ohfourvolclustfine.sppdc <- M6ohfourvoltranfine.sppdc %>%
  group_by(stand, age, year, cluster, spp, dc) %>%
  summarise(avgclustvol = sum(tranvol)/3)
###Average cluster volumes for each "normal" stand
M6ohfourvolstandfine.sppdc <- M6ohfourvolclustfine.sppdc %>%
  group_by(stand, age, year, spp, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/3)
###Odd balls = CC2,T20 
###CC2: AB, BC, CD, DA, EF, GH
###Sum vol for each transect of each "cluster" at CC2
###2020
twentyvoltranfine.cc2.sppdc <- twentyfine.cc2 %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*fwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclustfine.cc2.sppdc <- twentyvoltranfine.cc2.sppdc %>%
  group_by(stand, age, year, cluster, spp, dc) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for CC2
twentyvolstandfine.cc2.sppdc <- twentyvolclustfine.cc2.sppdc %>%
  group_by(stand, age, year, spp, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/6)
###2004
ohfourvoltranfine.cc2.h1.sppdc <- ohfourfine.cc2.h1%>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*fwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
ohfourvolclustfine.cc2.h1.sppdc <- ohfourvoltranfine.cc2.h1.sppdc %>%
  group_by(stand, age, year, cluster, spp, dc) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for CC2
ohfourvolstandfine.cc2.h1.sppdc <- ohfourvolclustfine.cc2.h1.sppdc %>%
  group_by(stand, age, year, spp, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/6)
###T20: AB, BC, CD, CE, DA, DF, GH, GI
###Sum vol for each transect of each cluster at T20
###2020
twentyvoltranfine.t20.sppdc <- twentyfine.t20 %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*fwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
twentyvolclustfine.t20.sppdc <- twentyvoltranfine.t20.sppdc %>%
  group_by(stand, age, year, cluster, spp, dc) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for T20
twentyvolstandfine.t20.sppdc <- twentyvolclustfine.t20.sppdc %>%
  group_by(stand, age, year, spp, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/8)
###2004
ohfourvoltranfine.t20.sppdc <- ohfourfine.t20 %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(sumvl = sum(piecevl)) %>%
  group_by(stand, age, year, cluster, az, spp, dc) %>%
  summarise(tranvol = (((pi)/(2*fwdtrans))*sumvl)*10000)
###Average transect volumes for each cluster
ohfourvolclustfine.t20.sppdc <- ohfourvoltranfine.t20.sppdc %>%
  group_by(stand, age, year, cluster, spp, dc) %>%
  summarise(avgclustvol = mean(tranvol))
###Average cluster volumes for T20
ohfourvolstandfine.t20.sppdc <- ohfourvolclustfine.t20.sppdc %>%
  group_by(stand, age, year, spp, dc) %>%
  summarise(avgstandvol = sum(avgclustvol)/8)
###Combine all stands again
###2020
twentyvolstandfine.sppdc <- rbind(twentyvolstandfine.normies.sppdc, M6twentyvolstandfine.sppdc, twentyvolstandfine.cc2.sppdc, twentyvolstandfine.t20.sppdc, twentyvolstandfine.og.sppdc)
###2004
ohfourvolstandfine.sppdc <- rbind(ohfourvolstandfine.normies.sppdc, M6ohfourvolstandfine.sppdc, ohfourvolstandfine.cc2.h1.sppdc, ohfourvolstandfine.t20.sppdc)
###Combine both years
stand_fwd.sppdc <- rbind(ohfourvolstandfine.sppdc, twentyvolstandfine.sppdc)

```

###Join density data with FWD volumes per spp and dc
```{r}
fwd.vol.density <- stand_fwd.sppdc %>%
left_join(unique(cwdvol.density.full [, c(c("spp", "dc", "density"))]))


###Clean up columns
colnames(fwd.vol.density) <- c("stand", "age", "year", "spp", "dc", "vol", "density")

###Identify gaps in FWD density data 
fwd.vol.density.gaps <- fwd.vol.density [which(is.na(fwd.vol.density $density)),]


###Table of gaps in density data
table(fwd.vol.density.gaps$spp, fwd.vol.density.gaps$dc)

fwd.spp.dc.gaps <- read.csv("Harmon_fwd_density_chronosequence_gaps.csv")
colnames(fwd.spp.dc.gaps) <- c("ID", "spp", "dc", "density", "uncert")
###Join data from Harmon and chrono
fwdvol.density.full <- left_join(fwd.vol.density, fwd.spp.dc.gaps, by = c("spp", "dc"))
fwdvol.density.full$density.x <- ifelse(is.na(fwdvol.density.full$density.x), fwdvol.density.full$density.y, fwdvol.density.full$density.x)

###Decay class 4 or 5 for any species = 0.14 g/cm3
fwdvol.density.full[fwdvol.density.full$dc == "4",]["density.x"][fwdvol.density.full[fwdvol.density.full$dc == "4",]["density.x"] >0] <- 0.14
fwdvol.density.full[fwdvol.density.full$dc == "5",]["density.x"][fwdvol.density.full[fwdvol.density.full$dc == "5",]["density.x"] >0] <- 0.14

###Remove duplicate density column and re-name columns
fwdvol.density.full <- fwdvol.density.full[-c(8:10)]
colnames(fwdvol.density.full) <- c("stand", "age", "year", "spp", "dc", "vol", "density")
```


###Calculate FWD biomass
```{r}
fwdvol.density.full$biomass <- fwdvol.density.full$vol*fwdvol.density.full$density
###Sum for each stand
fwd.biomass <- fwdvol.density.full %>%
  group_by(stand, age, year) %>%
  summarise(total.biomass = sum(biomass))
###Calculate SE
fwd.stand.biomass.se <- fwdvol.density.full %>%
  group_by(stand, age, year) %>%
  summarise(se = (sd(biomass)/sqrt(n())))

fwd.stand.biomass <- left_join(fwd.biomass, fwd.stand.biomass.se, by = c("stand", "age", "year"))
fwd.stand.biomass$age[fwd.stand.biomass$stand == "Bowl"|fwd.stand.biomass$stand == "Pond"] <- 180
colnames(fwd.stand.biomass) <- c("stand", "age", "year", "fwdbiomass", "fwdse")
```

###Join CWD and FWD biomass data 
```{r}
total.biomass <- left_join(cwd_biomass_se, fwd.stand.biomass, by = c("stand", "age", "year"))
colnames(total.biomass) <- c("stand", "age", "year", "cwdbiomass", "cwdse", "fwdbiomass", "fwdse")
###Re-order stands
total.biomass$stand <- factor(total.biomass$stand, levels = c("CC2", "C2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))

###Seperate years
ohfour.total.biomass <- total.biomass[total.biomass$year == "2004",]
twenty.total.biomass <- total.biomass[total.biomass$year == "2020",]


###Re-order ages
ohfour.total.biomass$age <- factor(ohfour.total.biomass$age, levels = c("15", "16", "20", "24", "27", "34", "37", "46", "54", "56", "65", "70", "94", "129", "130"))
twenty.total.biomass$age <- factor(twenty.total.biomass$age, levels = c("31", "36", "40", "43", "50", "53", "62", "70", "72", "86", "94", "110", "145", "146", "200", "201"))

###Calculate totals
total.biomass$total <- total.biomass$cwdbiomass + total.biomass$fwdbiomass 
total.biomass$totalse <- total.biomass$cwdse + total.biomass$fwdse

```

###Figure of Total DWD Biomass 
```{r}
###2004
ggplot() + 
  geom_bar_pattern(data =ohfour.total.biomass, aes(x = age, y = cwdbiomass + fwdbiomass), stat = "identity", 
                   pattern = "stripe", pattern_spacing = 0.01, 
                   pattern_fill = "black", fill = "white", color = "black", pattern_density = 0.20) +
  geom_bar(data =ohfour.total.biomass, aes(x = age, y = cwdbiomass), stat = "identity", fill = "black") +  
  labs(x = element_blank(), y = (expression(Biomass~(Mg/ha)))) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 40)) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA))

###2020
ggplot() + 
  geom_bar_pattern(data =twenty.total.biomass, aes(x = age, y = cwdbiomass + fwdbiomass), stat = "identity", 
                   pattern = "stripe", pattern_spacing = 0.01, 
                   pattern_fill = "black", fill = "white", color = "black", pattern_density = 0.20) +
  geom_bar(data =twenty.total.biomass, aes(x = age, y = cwdbiomass), stat = "identity", fill = "black") +  
  labs(x = element_blank(), y = (expression(Biomass~(Mg/ha)))) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 40)) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA))

###Progression of total DWD biomass
ggplot(data = total.biomass[-which(total.biomass$stand == "C2"),], aes(x = age, y = total, group = stand, color = factor(year))) + 
  geom_point(size = 2) + 
  geom_errorbar(aes(ymin=total-totalse, ymax=total+totalse), size = 1.2, position = position_dodge()) +
  geom_line(size = 1.2, color = "black") + 
  labs(x = "Stand Age", y = "Total DWD biomass (Mg/ha)", color = "Sampling year") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,200)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 40)) + 
  scale_color_manual(values = dwd.year.colors)+ 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 20, color = "black")) + 
  theme(axis.title.y = element_text(size = 20, color = "black")) + 
  theme(axis.text.x = element_text(size = 20, color = "black")) + 
  theme(axis.text.y = element_text(size = 20, color = "black")) + 
  theme(legend.text = element_text(size = 20, color = "black")) + 
  theme(legend.title = element_text(size = 20, color = "black")) + 
  theme(panel.border = element_rect(fill = NA)) + 
  annotate("text", x = 160, y = 0, label = "~", size = 5, angle = 90) +
  annotate("text", x = 170, y = 0, label = "~", size = 5, angle = 90) +
  annotation_custom(segmentsGrob(gp = gpar(col = "black", lwd = 1)), xmin = 180, xmax = 180, ymin = 0, ymax = -.30) +
  annotation_custom(textGrob("Uncut", gp = gpar(col = "black", fontsize = 20)), xmin = 180, xmax = 180, ymin = -0.8, ymax = -0.8 ) + 
  coord_cartesian(clip = "off")

```



```{r}

```


###Regresiion on total DWD biomass
```{r}
###2004
total.dwd.biomass.2004 <- total.biomass[total.biomass$year == "2004",]
dwd.biomass.2004.lm <- lm(total.dwd.biomass.2004$age~total.dwd.biomass.2004$total)



###2020
total.dwd.biomass.2020 <- total.biomass[total.biomass$year == "2020",]

dwd.biomass.2020.lm <- lm(total.dwd.biomass.2020$age~total.dwd.biomass.2020$total)
###Extract slope and intercept
cf.dwd.biomass.2020.lm<- coef(dwd.biomass.2020.lm)
int.dwd.biomass.2020.lm <- cf.dwd.biomass.2020.lm[1]
slope.dwd.biomass.2020.lm <- cf.dwd.biomass.2020.lm[2]

ggplot(data = total.dwd.biomass.2020, aes(x = age, y = total, group = stand, color = stand)) + 
  geom_point(size = 2) + 
  geom_errorbar(aes(ymin=total-totalse, ymax=total+totalse), position = position_dodge()) +
  geom_line(size = 1) + 
  geom_abline(slope = slope.dwd.biomass.2020.lm, intercept = int.dwd.biomass.2020.lm, size = 1, color = "black") + 
  annotate("text", x = 50, y = 35, label = paste("R^2 ==", 
  format(summary(dwd.biomass.2020.lm)$r.squared, digits = 3)), parse = TRUE, size = 4) + 
  labs(x = "stand Age", y = (expression(DWD~biomass~(Mg/ha))), color = "stand") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,200)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 40)) + 
  scale_color_discrete() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA))
```


```{r}
###2004 DWD biomass regression
plot(age~total, data = total.dwd.biomass.2004)
abline(dwd.biomass.2004.lm)
legend("topleft", legend = paste("R2 is", format(summary(dwd.biomass.2004.lm)$r.squared, digits = 3)))
```


```{r}
###2020 DWD biomass regression
plot(age~total, data = total.dwd.biomass.2020)
abline(dwd.biomass.2020.lm)
legend("topleft", legend = paste("R2 is", format(summary(dwd.biomass.2020.lm)$r.squared, digits = 3)))

```






###Seperate years of total biomass
```{r}
ohfour.total.biomass <- total.biomass[total.biomass$year == "2004",]
twenty.total.biomass <- total.biomass[total.biomass$year == "2020",]
###Seperate old stands
H2.ohfour.total.biomass <- ohfour.total.biomass[ohfour.total.biomass$stand == "H2",]
H3.ohfour.total.biomass <- ohfour.total.biomass[ohfour.total.biomass$stand == "H3",]
H2.H3.ohfour.total.biomass <- rbind(H2.ohfour.total.biomass, H3.ohfour.total.biomass)
H2.twenty.total.biomass <- twenty.total.biomass[twenty.total.biomass$stand == "H2",]
H3.twenty.total.biomass <- twenty.total.biomass[twenty.total.biomass$stand == "H3",]
H2.H3.twenty.total.biomass <- rbind(H2.twenty.total.biomass, H3.twenty.total.biomass)
Bowl.twenty.total.biomass <- twenty.total.biomass[twenty.total.biomass$stand == "Bowl",]
Pond.twenty.total.biomass <- twenty.total.biomass[twenty.total.biomass$stand == "Pond",]
Bowl.Pond.twenty.total.biomass <- rbind(Bowl.twenty.total.biomass, Pond.twenty.total.biomass)
###T-test between H2 and H3 in 2004 vs Bowl and Pond total biomass in 2020 (p = 0.27)
t.test(H2.H3.ohfour.total.biomass$total,Bowl.Pond.twenty.total.biomass$total )
###T-test between H2 and H3 in 2020 vs Bowl and Pond total biomass in 2020 (p = 0.58)
t.test(H2.H3.twenty.total.biomass$total,Bowl.Pond.twenty.total.biomass$total )
```







#########     #########
#######         #######
#####             #####
###                 ###
#         -   -       #
##                   ##
###         O       ###
#####             #####
########        #######

###Twig (<3.0 cm) data
```{r}
###Load data
twig<- read.csv("chronosequence_twigs.csv")
colnames(twig) <- c("year","stand", "age", "transect", "size", "weight", "g.m2", "mg.ha")
```

### 1 ha = 10000 m2
###Area per plot
###<7.5 mm = 0.707 m2 plot
###7.5-16 mm = 0.707 m2 plot
###16-30 mm = 2 m2
###Calculate Mean Mg/ha for each stand
```{r}
twig.mg.ha <- twig %>%
  group_by(year, stand, age, size) %>%
  summarise(mean = mean(mg.ha))
###Calculate SE
twig.mg.ha_se <- twig %>%
  group_by(year, stand, age, size) %>%
  summarise(se = sd(mg.ha)/sqrt(5))
###Combine Mean Mg/ha and SE
twig_data <- left_join(twig.mg.ha, twig.mg.ha_se, by = c("year", "stand", "age", "size"))
###Re-order stands
twig_data$stand <- factor(twig_data$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3"))
twig_data$size <- factor(twig_data$size, levels = c("<7.5", "7.5-16", "16-30"))
twig_data$standage <- paste(twig_data$stand, twig_data$age)
twig_data$standage <- factor(twig_data$standage, levels = c("CC2 17", "H6 22", "M6 26", "M5 29", "CC2 31","HB101 36", "H6 36", "H5 39", "M6 40", "M5 43", "T20 48", "HB101 50", "H5 53", "M4 56", "T30 58", "T20 62","H1 67",  "H4 72", "M4 70", "T30 72", "H4 86", "M3 96", "M3 110", "H2 131", "H3 131", "H2 145", "H3 145"))

```

###Re-organize data to get total Mg/ha
```{r}
twig$size <- factor(twig$size, levels = c("<7.5", "7.5-16", "16-30"))
twig_data_total <- spread(twig, size, mg.ha)
twig_data_total$`<7.5`[is.na(twig_data_total$`<7.5`)] <- 0
twig_data_total$`7.5-16`[is.na(twig_data_total$`7.5-16`)] <- 0
twig_data_total$`16-30`[is.na(twig_data_total$`16-30`)] <- 0
twig_data_total$total <- twig_data_total$`<7.5` + twig_data_total$`7.5-16` + twig_data_total$`16-30`
###Calculate Mean Mg/ha for each stand
twigg <- twig_data_total %>%
  group_by(year, stand, age, transect) %>%
  summarise(total = sum(total))
twig_total.mg.ha <- twigg %>%
  group_by(year, stand, age) %>%
  summarise(mean = mean(total))
###Calculate SE
twig_total.mg.ha_se <- twig_data_total %>%
  group_by(year, stand, age) %>%
  summarise(se = sd(total)/sqrt(5))
###Combine Mean Mg/ha and SE
twig_totals <- left_join(twig_total.mg.ha, twig_total.mg.ha_se, by = c("year", "stand", "age"))
###Re-order stands
twig_totals$stand <- factor(twig_totals$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3"))
twig_totals$year <- factor(twig_totals$year, levels = c("2006", "2020"))

```

###Set year colors for twigs
```{r}
twig.year.colors <- c("#009E73", "#D55E00")
names(twig.year.colors) <- c("2006", "2020")
```


###Progression of total twig mass
```{r}
ggplot(data = twig_totals, aes(x = age, y = mean, group = stand, color = factor(year))) + 
  geom_point(size = 2) + 
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), size = 1.2, position = position_dodge()) +
  geom_line(size = 1.2, color = "black", aes(linetype = factor(ifelse(stand=="M6"|stand=="HB101", 2,1))), show.legend = FALSE) + 
  labs(x = "Stand Age", y = "Total twig mass (Mg/ha)", color = "Sampling year") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,150)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 7)) + 
  scale_color_manual(values = twig.year.colors) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15, color = "black")) + 
  theme(axis.title.y = element_text(size = 15, color = "black")) + 
  theme(axis.text.x = element_text(size = 15, color = "black")) + 
  theme(axis.text.y = element_text(size = 15, color = "black")) + 
  theme(legend.text = element_text(size = 15, color = "black")) + 
  theme(legend.title = element_text(size = 15., color = "black")) + 
  theme(panel.border = element_rect(fill = NA))

```

###Finding stands dominated by PC in 2004 and 2021 to use in twig figure
```{r}
allbaspp.total.2004 <- left_join(allbaspp2004, allba2004, by = c("stand", "age", "year"))
allbaspp.total.2004$ba.ratio <- (allbaspp.total.2004$standbaha.x/allbaspp.total.2004$standbaha.y)*100
allbaspp.total.2021 <- left_join(allbaspp2021, allba2021, by = c("stand", "age", "year"))
allbaspp.total.2021$ba.ratio <- (allbaspp.total.2021$standbaha.x/allbaspp.total.2021$standbaha.y)*100

allbaspp.total.2004$stand <- factor(allbaspp.total.2004$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3"))
allbaspp.total.2021$stand <- factor(allbaspp.total.2021$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))

ggplot(data = allbaspp.total.2004, aes(x = stand, y = ba.ratio, fill = spp)) + 
  geom_bar(stat = "identity") + 
  scale_fill_manual(values = spp.colors)


ggplot(data = allbaspp.total.2021, aes(x = stand, y = ba.ratio, fill = spp)) + 
  geom_bar(stat = "identity") + 
  scale_fill_manual(values = spp.colors)

```






#########     #########
#######         #######
#####             #####
###                 ###
#         ~   ~       #
##                   ##
###         3       ###
#####             #####
########        #######


#Over 10 Tree Analysis 2021
```{r}
##Import Data
overten2021<- read.csv("chronosequence_tree_inventory_2021.csv")
colnames(overten2021) <- c("stand", "age", "transect", "distance", "side", "spp", "dbh", "status", "wax", "neo", "treecond" )

###Calculate Basal Area m2 (BA) for each tree
overten2021$ba <- 0.00007854*(overten2021$dbh^2) 

###Calculate DBH class
overten2021$dbhclass <- 2*round((overten2021$dbh)/2)


###Calculate LIVE BA for each transect in each stand
### 1 ha = 10000 m2
###1 ha = 2.471 acre
###Area of a transect = 10 m * 50 m = 500 m2 for H2, H3, H4, H5, H6, M3, M6, HB101,     10000/500 = 20
###                   = 10 m * 25 m = 250 m2 for 5a and 5b transects in M4, M5, T20, and T30    10000/250 = 40
###                   = 5 m * 30 m = 150 m2 for H1 and CC2                                 10000/150 = 66.7
###                   = 10 m * 70.7 m  = 707 m2 in Bowl and Mt. Pond                        10000/707 = 14.1


###Subset live trees
overten2021_alive <- overten2021[overten2021$status == "A",]

library(tidyr)
library(tidyverse)
###Basal Area
transectba2021 <- overten2021_alive %>%
  group_by(stand, age, transect) %>%
  summarise(transectba = sum(ba))

###By species
transectbaspp2021 <- overten2021_alive %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectba = sum(ba))

###TPA
transectcount2021 <- overten2021_alive %>%
  group_by(stand, age, transect, dbhclass) %>%
  summarise(transecttreecount = n())


###Subset OG stands
og2021 <- overten2021_alive[which(overten2021_alive$stand == "Bowl"| overten2021_alive$stand == "Pond"),]
###Basal Area
ogtransectbaha2021 <- og2021 %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(ba)*14.1)
ogstandbaha2021 <- ogtransectbaha2021 %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/5)
###With species
ogtransectbahaspp2021 <- og2021 %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*14.1)
ogstandbahaspp2021 <- ogtransectbahaspp2021 %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/5)

###TPA
ogtransecttpa2021 <- og2021 %>%
  group_by(stand, age, transect, dbhclass) %>%
  summarise(transecttpa = (n()*14.1)/2.471)
ogstandtpa2021 <- ogtransecttpa2021 %>%
  group_by(stand, age, dbhclass) %>%
  summarise(standtpa = sum(transecttpa)/5)
###With species
ogtransecttpaspp2021 <- og2021 %>%
  group_by(stand, age, transect, spp, dbhclass) %>%
  summarise(transecttpa = (n()*14.1)/2.471)
ogstandtpaspp2021 <- ogtransecttpaspp2021 %>%
  group_by(stand, age, spp, dbhclass) %>%
  summarise(standtpa = sum(transecttpa)/5)




###Subset "normal" stands
normies2021 <- overten2021_alive[which(overten2021_alive$stand == "H2"| overten2021_alive$stand == "H3"| 
                                         overten2021_alive$stand == "H4"| overten2021_alive$stand == "H5"| 
                                         overten2021_alive$stand == "H6"| overten2021_alive$stand == "M3"| 
                                         overten2021_alive$stand == "M6"| overten2021_alive$stand == "HB101"),]
###Calculate BA/ha for each transect, then average for the stand
normiestransectba2021 <- normies2021 %>%
               group_by(stand, age, transect) %>%
               summarise(transectba = sum(ba))
normiestransectbaha2021 <- normiestransectba2021 %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(transectba)*20)
###Sum for each stand
normiesstandbaha2021 <- normiestransectbaha2021 %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/5)

###With species
normiestransectbahaspp2021 <- normies2021 %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*20)
normiesstandbahaspp2021 <- normiestransectbahaspp2021 %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/5)

###TPA
normiestransecttpa2021 <- normies2021 %>%
  group_by(stand, age, transect, dbhclass) %>%
  summarise(transecttpa = (n()*20)/2.471)
normiesstandtpa2021 <- normiestransecttpa2021 %>%
  group_by(stand, age, dbhclass) %>%
  summarise(standtpa = sum(transecttpa)/5)
###With species
normiestransecttpaspp2021 <- normies2021 %>%
  group_by(stand, age, transect, spp, dbhclass) %>%
  summarise(transecttpa = (n()*20)/2.471)
normiesstandtpaspp2021 <- normiestransecttpaspp2021 %>%
  group_by(stand, age, spp, dbhclass) %>%
  summarise(standtpa = sum(transecttpa)/5)


###Subset stands with 5A and 5B transects due to skid trails 
skids2021 <- overten2021_alive[which(overten2021_alive$stand == "M4"|overten2021_alive$stand == "M5" | 
                                       overten2021_alive$stand == "T20" | overten2021_alive$stand == "T30"),]
###Calculate BA/ha for each transect, then average for the stand
skidstransect1234baha2021 <- skids2021[which(skids2021$transect == "L1" | skids2021$transect == "L2" | 
                                               skids2021$transect == "L3" | skids2021$transect == "L4"),] %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(ba)*20)
skidstransect5baha2021 <- skids2021[which(skids2021$transect == "L5A" | skids2021$transect == "L5B"),] %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = (sum(ba)*40))
skidstransectbaha2021 <- rbind(skidstransect1234baha2021, skidstransect5baha2021)

skidsstandbaha2021 <- skidstransectbaha2021 %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/6)

###With species
skidstransect1234bahaspp2021 <- skids2021[which(skids2021$transect == "L1" | skids2021$transect == "L2" | 
                                                  skids2021$transect == "L3" | skids2021$transect == "L4"),] %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*20)
skidstransect5bahaspp2021 <- skids2021[which(skids2021$transect == "L5A" | skids2021$transect == "L5B"),] %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = (sum(ba)*40))
skidstransectbahaspp2021 <- rbind(skidstransect1234bahaspp2021, skidstransect5bahaspp2021)

skidsstandbahaspp2021 <- skidstransectbahaspp2021 %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/6)


###TPA
skidstransect1234tpa2021 <- skids2021[which(skids2021$transect == "L1" | skids2021$transect == "L2" | 
                                              skids2021$transect == "L3" | skids2021$transect == "L4"),] %>%
  group_by(stand, age, transect, dbhclass) %>%
  summarise(transecttpa = (n()*20)/2.471)
skidstransect5tpa2021 <- skids2021[which(skids2021$transect == "L5A" | skids2021$transect == "L5B"),] %>%
  group_by(stand, age, transect, dbhclass) %>%
  summarise(transectbaha = (n()*40)/2.471)
skidstransecttpa2021 <- rbind(skidstransect1234tpa2021, skidstransect5tpa2021)

skidsstandtpa2021 <- skidstransecttpa2021 %>%
  group_by(stand, age, dbhclass) %>%
  summarise(standtpa = sum(transecttpa)/6)

###With Species
skidstransect1234tpaspp2021 <- skids2021[which(skids2021$transect == "L1" | skids2021$transect == "L2" | 
                                                 skids2021$transect == "L3" | skids2021$transect == "L4"),] %>%
  group_by(stand, age, transect, spp, dbhclass) %>%
  summarise(transecttpa = (n()*20)/2.471)
skidstransect5tpaspp2021 <- skids2021[which(skids2021$transect == "L5A" | skids2021$transect == "L5B"),] %>%
  group_by(stand, age, transect, spp, dbhclass) %>%
  summarise(transectbaha = (n()*40)/2.471)
skidstransecttpaspp2021 <- rbind(skidstransect1234tpaspp2021, skidstransect5tpaspp2021)

skidsstandtpaspp2021 <- skidstransecttpaspp2021 %>%
  group_by(stand, age, spp, dbhclass) %>%
  summarise(standtpa = sum(transecttpa)/6)


###Subset smaller stands
smalls2021 <- overten2021_alive[which(overten2021_alive$stand == "H1"| overten2021_alive$stand == "CC2"),]
###Calculate BA/ha for each transect, then average for the stand
smallstransectbaha2021 <- smalls2021 %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(ba)*66.7)
smallsstandbaha2021 <- smallstransectbaha2021 %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/5)

###With species
smallstransectbahaspp2021 <- smalls2021 %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*66.7)
smallsstandbahaspp2021 <- smallstransectbahaspp2021 %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/5)



###TPA
smallstransecttpa2021 <- smalls2021 %>%
  group_by(stand, age, transect, dbhclass) %>%
  summarise(transecttpa = (n()*66.7)/2.471)
smallsstandtpa2021 <- smallstransecttpa2021 %>%
  group_by(stand, age, dbhclass) %>%
  summarise(standtpa = sum(transecttpa)/5)
###With species
smallstransecttpaspp2021 <- smalls2021 %>%
  group_by(stand, age, transect, spp, dbhclass) %>%
  summarise(transecttpa = (n()*66.7)/2.471)
smallsstandtpaspp2021 <- smallstransecttpaspp2021 %>%
  group_by(stand, age, spp, dbhclass) %>%
  summarise(standtpa = sum(transecttpa)/5)





###Combine all stands 
###Basal Area
allba2021 <- rbind(normiesstandbaha2021, skidsstandbaha2021, smallsstandbaha2021, ogstandbaha2021)
allba2021$year <- 2021
allba2021$stand <- factor(allba2021$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))
###With species
allbaspp2021 <- rbind(ogstandbahaspp2021, normiesstandbahaspp2021, skidsstandbahaspp2021, smallsstandbahaspp2021)
allbaspp2021$year <- 2021
###Add stand and age
allbaspp2021$standage <- paste(allbaspp2021$stand, allbaspp2021$age)
allbaspp2021$standage <- factor(allbaspp2021$standage, levels = c("CC2 32", "H6 37", "M6 41", "M5 44", "HB101 51", "H5 54",  "T20 63", "M4 71", "T30 73", "H1 82", "H4 86", "M3 111", "H2 146", "H3 146", "Bowl 300", "Pond 300"))

```



###Assign colors to species
```{r}
spp.ba.colors <- c("magenta", "purple", "lawngreen", "lightgray", "cornflowerblue", "red", "burlywood", "red4", "rosybrown", "darkorange","cyan","gold","forestgreen", "black" )
names(spp.ba.colors) <- c("PC", "STM", "ASP", "WB", "ASH", "RM", "BASS", "BC", "RO", "SM", "BE", "YB", "CON", "OTHER")

```



###Plot Basal area 2021
```{r}
ggplot(data = allbaspp2021, aes(x = standage, y = standbaha, group = stand, fill = spp)) + 
  geom_bar(stat =  "identity", color= "black") + 
  labs(x = "stand and Age", y = (expression(Basal~area~(m^2/ha))), fill = "Species") + 
  scale_fill_manual(values = spp.ba.colors) + 
  scale_y_continuous(expand = c(0,0), limits = c(0,50)) + 
  scale_x_discrete(labels = function(standage) str_wrap(standage, width = 2)) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15, color = "black")) + 
  theme(axis.title.y = element_text(size = 15, color = "black")) + 
  theme(axis.text.x = element_text(size = 15, color = "black")) + 
  theme(axis.text.y = element_text(size = 15, color = "black")) + 
  theme(legend.text = element_text(size = 15, color = "black")) + 
  theme(legend.title = element_text(size = 15, color = "black")) + 
  theme(panel.border = element_rect(fill = NA))

```

###TPA
```{r}
alltpa2021 <- rbind(normiesstandtpa2021, skidsstandtpa2021, smallsstandtpa2021, ogstandtpa2021)
alltpa2021$year <- 2021
alltpa2021$stand <- factor(alltpa2021$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))
###With species
alltpaspp2021 <- rbind(ogstandtpaspp2021, normiesstandtpaspp2021, skidsstandtpaspp2021, smallsstandtpaspp2021)
alltpaspp2021$year <- 2021
alltpaspp2021$stand <- factor(alltpaspp2021$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))

table(alltpaspp2021$stand, alltpaspp2021$dbhclass, alltpaspp2021$standtpa)
```

###Plot TPA
```{r}
tpa.2021 <- ggplot(data = alltpaspp2021, aes(x = dbhclass, y = standtpa, group = stand, fill = spp)) + 
  geom_bar(stat =  "identity", color= "black") + 
  scale_fill_manual(values = spp.ba.colors) + 
  scale_y_continuous(expand = c(0,0), limits = c(0,80)) + 
  scale_x_continuous(limits = c(10, 80))
tpa.2021 + facet_wrap(~stand)
```


#########     #########
#######         #######
#####             #####
###                 ###
#         ~   ~       #
##                   ##
###         O       ###
#####             #####
########        #######

###Over 10 Analysis for 2012  
```{r}
##Import Data
overten2012<- read.csv("chronosequence_tree_inventory_2012.csv")
colnames(overten2012) <- c("stand", "age", "transect", "distance", "side", "spp", "dbh", "status", "wax", "neo", "treecond" )

###Calculate Basal Area m2 (BA) for each tree
overten2012$dbh <- as.numeric(overten2012$dbh)
##overten2012$dbh <- na.omit(overten2012)
overten2012$ba <- 0.00007854*(overten2012$dbh^2) 

###Calculate LIVE BA for each transect in each stand
### 1 ha = 10000 m2
###Area of a transect = 10 m * 50 m = 500 m2 for H2, H3, H4, H5, H6, M3, M6, HB101,     10000/500 = 20
###                   = 10 m * 25 m = 250 m2 for 5a and 5b transects in M4, M5, T20, and T30    10000/250 = 40
###                   = 5 m * 30 m = 150 m2 for H1 and CC2                                 10000/150 = 66.7



###Subset live trees
overten2012_alive <- overten2012[overten2012$status == "A",]

library(tidyr)
library(tidyverse)
transectba2012 <- overten2012_alive %>%
  group_by(stand, age, transect) %>%
  summarise(transectba = sum(ba))

###By species
transectbaspp2012 <- overten2012_alive %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectba = sum(ba))


###Subset "normal" stands
normies2012 <- overten2012_alive[which(overten2012_alive$stand == "H2"| overten2012_alive$stand == "H3"| 
                                         overten2012_alive$stand == "H4"| overten2012_alive$stand == "H5"| 
                                         overten2012_alive$stand == "H6"| overten2012_alive$stand == "M3"| 
                                         overten2012_alive$stand == "M6"| overten2012_alive$stand == "HB101"),]
###Calculate BA/ha for each transect, then average for the stand
normiestransectba2012 <- normies2012 %>%
  group_by(stand, age, transect) %>%
  summarise(transectba = sum(ba))
normiestransectbaha2012 <- normiestransectba2012 %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(transectba)*20)
###Sum for each stand
normiesstandbaha2012 <- normiestransectbaha2012 %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/5)

###With species
normiestransectbahaspp2012 <- normies2012 %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*20)
normiesstandbahaspp2012 <- normiestransectbahaspp2012 %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/5)


###Subset stands with 5A and 5B transects due to skid trails 
skids2012 <- overten2012_alive[which(overten2012_alive$stand == "M4"|overten2012_alive$stand == "M5" | 
                                       overten2012_alive$stand == "T20" | overten2012_alive$stand == "T30"),]
###Calculate BA/ha for each transect, then average for the stand
skidstransect1234baha2012 <- skids2012[which(skids2012$transect == "L1" | skids2012$transect == "L2" | 
                                               skids2012$transect == "L3" | skids2012$transect == "L4"),] %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(ba)*20)
skidstransect5baha2012 <- skids2012[which(skids2012$transect == "L5A" | skids2012$transect == "L5B"),] %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = (sum(ba)*40))
skidstransectbaha2012 <- rbind(skidstransect1234baha2012, skidstransect5baha2012)

skidsstandbaha2012 <- skidstransectbaha2012 %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/6)

###With species
skidstransect1234bahaspp2012 <- skids2012[which(skids2012$transect == "L1" | skids2012$transect == "L2" | 
                                                  skids2012$transect == "L3" | skids2012$transect == "L4"),] %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*20)
skidstransect5bahaspp2012 <- skids2012[which(skids2012$transect == "L5A" | skids2012$transect == "L5B"),] %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = (sum(ba)*40))
skidstransectbahaspp2012 <- rbind(skidstransect1234bahaspp2012, skidstransect5bahaspp2012)

skidsstandbahaspp2012 <- skidstransectbahaspp2012 %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/6)


###Subset smaller stands
smalls2012 <- overten2012_alive[which(overten2012_alive$stand == "H1"| overten2012_alive$stand == "CC2"),]
###Calculate BA/ha for each transect, then average for the stand
smallstransectbaha2012 <- smalls2012 %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(ba)*66.7)
smallsstandbaha2012 <- smallstransectbaha2012 %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/5)

###With species
smallstransectbahaspp2012 <- smalls2012 %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*66.7)
smallsstandbahaspp2012 <- smallstransectbahaspp2012 %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/5)


###Combine all stands 
allba2012 <- rbind(normiesstandbaha2012, skidsstandbaha2012, smallsstandbaha2012)
allba2012$year <- 2012
allba2012$stand <- factor(allba2012$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3"))
###With species
allbaspp2012 <- rbind(normiesstandbahaspp2012, skidsstandbahaspp2012, smallsstandbahaspp2012)
allbaspp2012$year <- 2012
###Beech only
allba_beech2012 <- allbaspp2012[allbaspp2012$spp == "BE", ]
allba_beech2012$year <- 2012
```

#########     #########
#######         #######
#####             #####
###                 ###
#         ~   ~       #
##                   ##
###         O       ###
#####             #####
########        #######

###Over 10 Analysis for 2004 
```{r}
##Import Data
overten2004<- read.csv("chronosequence_tree_inventory_2004.csv")
colnames(overten2004) <- c("stand", "age", "transect", "spp", "dbh", "status")
###Calculate Basal Area m2 (BA) for each tree
overten2004$ba <- 0.00007854*(overten2004$dbh^2) 


###Calculate LIVE BA for each transect in each stand
### 1 ha = 10000 m2
###Area of a transect = 10 m * 50 m = 500 m2 for H2, H3, H4, H5, H6, M3, M4, M6, HB101, M5, T20, and T30    10000/500 = 20
###                   = 5 m * 30 m = 150 m2 for H1 and CC2                                 10000/150 = 66.7



###Subset live trees
overten2004_alive <- overten2004[overten2004$status == "A",]

library(tidyr)
library(tidyverse)
transectba2004 <- overten2004_alive %>%
  group_by(stand, age, transect) %>%
  summarise(transectba = sum(ba))

###By species
transectbaspp2004 <- overten2004_alive %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectba = sum(ba))


###Subset "normal" stands
normies2004 <- overten2004_alive[which(overten2004_alive$stand == "H2"| overten2004_alive$stand == "H3"| overten2004_alive$stand == "H4"| 
                                         overten2004_alive$stand == "H5"| overten2004_alive$stand == "H6"| overten2004_alive$stand == "M3"| 
                                         overten2004_alive$stand == "M4"| overten2004_alive$stand == "M6"| overten2004_alive$stand == "HB101"|
                                         overten2004_alive$stand == "M5" | overten2004_alive$stand == "T20" | overten2004_alive$stand == "T30"),]
###Calculate BA/ha for each transect, then average for the stand
normiestransectba2004 <- normies2004 %>%
  group_by(stand, age, transect) %>%
  summarise(transectba = sum(ba))
normiestransectbaha2004 <- normiestransectba2004 %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(transectba)*20)
###Sum for each stand
normiesstandbaha2004 <- normiestransectbaha2004 %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/5)

###With species
normiestransectbahaspp2004 <- normies2004 %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*20)
normiesstandbahaspp2004 <- normiestransectbahaspp2004 %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/5)


###Subset smaller stands
smalls2004 <- overten2004_alive[which(overten2004_alive$stand == "H1"| overten2004_alive$stand == "CC2"),]
###Calculate BA/ha for each transect, then average for the stand
smallstransectbaha2004 <- smalls2004 %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(ba)*66.7)
smallsstandbaha2004 <- smallstransectbaha2004 %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/5)

###With species
smallstransectbahaspp2004 <- smalls2004 %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*66.7)
smallsstandbahaspp2004 <- smallstransectbahaspp2004 %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/5)


###Combine all stands 
allba2004 <- rbind(normiesstandbaha2004, smallsstandbaha2004)
allba2004$year <- 2004
allba2004$stand <- factor(allba2004$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3"))
###With species
allbaspp2004 <- rbind(normiesstandbahaspp2004, smallsstandbahaspp2004)
allbaspp2004$year <- 2004
###Beech only
allba_beech2004 <- allbaspp2004[allbaspp2004$spp == "BE", ]
allba_beech2004$year <- 2004

```

#########     #########
#######         #######
#####             #####
###                 ###
#         ~   ~       #
##                   ##
###         O       ###
#####             #####
########        #######

###Over 10 Analysis for 1994 
```{r}
##Import Data
overten1994<- read.csv("chronosequence_tree_inventory_1994.csv")
colnames(overten1994) <- c("stand", "age", "transect", "spp", "dbh", "status")
###Calculate Basal Area m2 (BA) for each tree
overten1994$ba <- 0.00007854*(overten1994$dbh^2) 


###Calculate LIVE BA for each transect in each stand
### 1 ha = 10000 m2
###Area of a transect = 10 m * 50 m = 500 m2 for H2, H3, H4, H5, H6, M3, M4, M6, HB101, M5, T20, and T30    10000/500 = 20
###                   = 5 m * 30 m = 150 m2 for H1                                 10000/150 = 66.7


###Subset live trees
overten1994_alive <- overten1994[overten1994$status == "A",]

library(tidyr)
library(tidyverse)
transectba1994 <- overten1994_alive %>%
  group_by(stand, age, transect) %>%
  summarise(transectba = sum(ba))

###By species
transectbaspp1994 <- overten1994_alive %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectba = sum(ba))


###Subset "normal" stands
normies1994 <- overten1994_alive[which(overten1994_alive$stand == "H2"| overten1994_alive$stand == "H3"| overten1994_alive$stand == "H4"| 
                                         overten1994_alive$stand == "H5"| overten1994_alive$stand == "H6"| overten1994_alive$stand == "M3"| 
                                         overten1994_alive$stand == "M4"| overten1994_alive$stand == "M6"| overten1994_alive$stand == "HB101"|
                                         overten1994_alive$stand == "M5" | overten1994_alive$stand == "T20" | overten1994_alive$stand == "T30"),]
###Calculate BA/ha for each transect, then average for the stand
normiestransectba1994 <- normies1994 %>%
  group_by(stand, age, transect) %>%
  summarise(transectba = sum(ba))
normiestransectbaha1994 <- normiestransectba1994 %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(transectba)*20)
###Sum for each stand
normiesstandbaha1994 <- normiestransectbaha1994 %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/5)

###With species
normiestransectbahaspp1994 <- normies1994 %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*20)
normiesstandbahaspp1994 <- normiestransectbahaspp1994 %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/5)


###Subset smaller stands
smalls1994 <- overten1994_alive[which(overten1994_alive$stand == "H1"),]
###Calculate BA/ha for each transect, then average for the stand
smallstransectbaha1994 <- smalls1994 %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(ba)*66.7)
smallsstandbaha1994 <- smallstransectbaha1994 %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/5)

###With species
smallstransectbahaspp1994 <- smalls1994 %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*66.7)
smallsstandbahaspp1994 <- smallstransectbahaspp1994 %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/5)


###Combine all stands 
allba1994 <- rbind(normiesstandbaha1994, smallsstandbaha1994)
allba1994$year <- 1994
allba1994$stand <- factor(allba1994$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3"))
###With species
allbaspp1994 <- rbind(normiesstandbahaspp1994, smallsstandbahaspp1994)
allbaspp1994$year <- 1994
###Beech only
allba_beech1994 <- allbaspp1994[allbaspp1994$spp == "BE", ]
allba_beech1994$year <- 1994

```
###Combine all years of live tree sampling
```{r}
allba <- rbind(allba1994, allba2004, allba2012, allba2021)
allba$stand <- factor(allba$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))
###With species
allbaspp <- rbind(allbaspp1994, allbaspp2004, allbaspp2012, allbaspp2021)

###Calculate BA SE for each stand
###2021
###OG
og_se_2021 <- ogtransectbaha2021 %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Normies
normies_se_2021 <- normiestransectbaha2021 %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Skids
skids_se_2021 <- skidstransectbaha2021 %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(6))
###Smaller stands
smalls_se_2021 <- smallstransectbaha2021 %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Combine all stands 
allba_se_2021 <- rbind(og_se_2021, normies_se_2021, skids_se_2021, smalls_se_2021)
allba_se_2021$year <- 2021

###2012
###Normies
normies_se_2012 <- normiestransectbaha2012 %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Skids
skids_se_2012 <- skidstransectbaha2012 %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(6))
###Smaller stands
smalls_se_2012 <- smallstransectbaha2012 %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Combine all stands
allba_se_2012 <- rbind(normies_se_2012, skids_se_2012, smalls_se_2012)
allba_se_2012$year <- 2012

###2004
###Normies
normies_se_2004 <- normiestransectbaha2004 %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Smaller stands
smalls_se_2004 <- smallstransectbaha2004 %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Combine all stands
allba_se_2004 <- rbind(normies_se_2004, smalls_se_2004)
allba_se_2004$year <- 2004

###1994
###Normies
normies_se_1994 <- normiestransectbaha1994 %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Smaller stands
smalls_se_1994 <- smallstransectbaha1994 %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Combine all stands
allba_se_1994 <- rbind(normies_se_1994, smalls_se_1994)
allba_se_1994$year <- 1994


###Combine all years
allba_se <- rbind(allba_se_1994, allba_se_2004, allba_se_2012, allba_se_2021)
###Combine BA (m2/ha) and SE for all stands - OG
allbaha_se <- left_join(allba, allba_se, by = c("stand", "age", "year"))




###With species
###2021
###Old Growth
ogspp_se_2021 <- ogtransectbahaspp2021 %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Normies
normiesspp_se_2021 <- normiestransectbahaspp2021 %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Skids
skidsspp_se_2021 <- skidstransectbahaspp2021 %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(6))
###Smaller stands
smallsspp_se_2021 <- smallstransectbahaspp2021 %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Combine all stands
allbaspp_se_2021 <- rbind(ogspp_se_2021, normiesspp_se_2021, skidsspp_se_2021, smallsspp_se_2021)
allbaspp_se_2021$year <- 2021

###2012
###Normies
normiesspp_se_2012 <- normiestransectbahaspp2012 %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Skids
skidsspp_se_2012 <- skidstransectbahaspp2012 %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(6))
###Smaller stands
smallsspp_se_2012 <- smallstransectbahaspp2012 %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Combine all stands
allbaspp_se_2012 <- rbind(normiesspp_se_2012, skidsspp_se_2012, smallsspp_se_2012)
allbaspp_se_2012$year <- 2012

###2004
###Normies
normiesspp_se_2004 <- normiestransectbahaspp2004 %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Smaller stands
smallsspp_se_2004 <- smallstransectbahaspp2004 %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Combine all stands
allbaspp_se_2004 <- rbind(normiesspp_se_2004, smallsspp_se_2004)
allbaspp_se_2004$year <- 2004

###1994
###Normies
normiesspp_se_1994 <- normiestransectbahaspp1994 %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Smaller stands
smallsspp_se_1994 <- smallstransectbahaspp1994 %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Combine all stands
allbaspp_se_1994 <- rbind(normiesspp_se_1994, smallsspp_se_1994)
allbaspp_se_1994$year <- 1994


###Combine all years
allbaspp_se <- rbind(allbaspp_se_1994, allbaspp_se_2004, allbaspp_se_2012, allbaspp_se_2021)
###Combine BA (m2/ha) and SE
allbahaspp_se <- left_join(allbaspp, allbaspp_se, by = c("stand", "age", "spp", "year"))
###Replace NA's with 0
allbahaspp_se$se[is.na(allbahaspp_se$se)] <- 0
```

###Figure showing progression of BA (m2/ha) occupied by each species at each stand 1994 - 2020
```{r}
allbahaspp_se$stand <- factor(allbahaspp_se$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))
###Change age of Bowl and Pond to 180 to fit on graph
allbahaspp_se$age[allbahaspp_se$stand == "Bowl" | allbahaspp_se$stand == "Pond"] <- 180

###Change species names
##BA and QA = ASP
allbahaspp_se$spp[allbahaspp_se$spp == "BA" |allbahaspp_se$spp == "QA"] <- "ASP"
###FIR, HEM, RS = CON
allbahaspp_se$spp[allbahaspp_se$spp == "FIR" |allbahaspp_se$spp == "HEM"|allbahaspp_se$spp == "RS"] <- "CON"
###MM, STM, BASS, BC, RO, OV, UNK = OTHER
allbahaspp_se$spp[allbahaspp_se$spp == "MM" |allbahaspp_se$spp == "STM" |allbahaspp_se$spp == "BASS" |
                    allbahaspp_se$spp == "BC" | allbahaspp_se$spp == "RO" |allbahaspp_se$spp == "OV"|allbahaspp_se$spp == "UNK"] <- "OTHER"

allbahaspp_se_final<- allbahaspp_se %>%
  group_by(stand, age, year, spp) %>%
  summarise(sppbaha = mean(standbaha))

allbahaspp_se_final$standage <- paste(allbahaspp_se_final$stand, "-", allbahaspp_se_final$age)
allbahaspp_se_final <- allbahaspp_se_final[-which(allbahaspp_se_final$spp == "NONE"|allbahaspp_se_final$spp == "None"),]
allbahaspp_se_final$spp <- factor(allbahaspp_se_final$spp, levels = c("PC", "ASP", "WB", "ASH", "OTHER", "YB", "RM", "SM", "BE", "CON"))

spp.ba.plot <- ggplot(data = allbahaspp_se_final, aes(x = stand, y = sppbaha, group = stand, fill = spp)) + 
  geom_bar(stat = "identity", color= "black", position = position_dodge(), width = 1) + 
  labs(x = "stand Age", y = (expression(Basal~area~(m^2/ha))), fill = "Species") +
  scale_fill_manual(values = spp.ba.colors) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 50)) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA)) + 
  annotation_custom(segmentsGrob(gp = gpar(col = "black", lwd = 1)), xmin = 180, xmax = 180, ymin = 0, ymax = -.30) +
  annotation_custom(textGrob("Uncut", gp = gpar(col = "black", fontsize = 15)), xmin = 180, xmax = 180, ymin = -0.8, ymax = -0.8 ) + 
  coord_cartesian(clip = "off")
spp.ba.plot + facet_wrap(~year)

```


###With patterned fills
```{r}
###Assign patterns to species
###Order of increasing shade tolerance
spp.patterns <- c("circle","stripe","none","crosshatch","none","stripe","stripe","stripe","none", "stripe")
names(spp.patterns) <- c("PC", "ASP", "WB", "ASH", "OTHER", "YB", "RM", "SM", "BE", "CON")

spp.pattern_angles <- c(120,25,0,45,0,-25,90,0,0,90)
names(spp.pattern_angles) <- c("PC", "ASP", "WB", "ASH", "OTHER", "YB", "RM", "SM", "BE", "CON")

spp.pattern_density <- c(0.05,0.025,0.5,0.025,0,0.025,0.025,0.6,0.6,0.75)
names(spp.pattern_density) <- c("PC", "ASP", "WB", "ASH", "OTHER", "YB", "RM", "SM", "BE", "CON")

spp.pattern_spacing <- c(0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.02)
names(spp.pattern_spacing) <- c("PC", "ASP", "WB", "ASH", "OTHER", "YB", "RM", "SM", "BE", "CON")

spp.pattern_fills <- c("plum1","white","grey","white","black","white","darkred","darkorange2","lightskyblue1","white")
names(spp.pattern_fills) <- c("PC", "ASP", "WB", "ASH", "OTHER", "YB", "RM", "SM", "BE", "CON")

###1994
spp.ba.plot.patt.1994 <- ggplot(data = allbahaspp_se_final[allbahaspp_se_final$year == "1994",]) + 
  geom_bar_pattern(stat = "identity", aes(x =stand, y = sppbaha, pattern = spp, pattern_spacing = spp,
                                          fill = spp, pattern_density = spp, pattern_angle = spp), 
                   pattern_fill = "black", pattern_size = 0.5, width = 1, colour = "black")  + 
  labs(x = "stand", y = (expression(Basal~area~(m^2/ha)))) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 45)) + 
  scale_pattern_manual(values = spp.patterns) + 
  scale_pattern_density_manual(values = spp.pattern_density) + 
  scale_pattern_angle_manual(values = spp.pattern_angles) +
  scale_pattern_spacing_manual(values = spp.pattern_spacing) + 
  scale_fill_manual(values = spp.pattern_fills) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15, color = "black")) + 
  theme(axis.title.y = element_text(size = 15, color = "black")) + 
  theme(axis.text.x = element_text(size = 15, color = "black")) + 
  theme(axis.text.y = element_text(size = 15, color = "black")) + 
  theme(legend.text = element_text(size = 15, color = "black")) + 
  theme(legend.title = element_text(size = 15, color = "black")) + 
  theme(panel.border = element_rect(fill = NA))
spp.ba.plot.patt.1994
###2004
spp.ba.plot.patt.2004 <- ggplot(data = allbahaspp_se_final[allbahaspp_se_final$year == "2004",]) + 
  geom_bar_pattern(stat = "identity", aes(x =stand, y = sppbaha, pattern = spp, pattern_spacing = spp,
                                          fill = spp, pattern_density = spp, pattern_angle = spp), 
                   pattern_fill = "black", pattern_size = 0.5, width = 1, colour = "black")  + 
  labs(x = "stand", y = (expression(Basal~area~(m^2/ha)))) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 45)) + 
  scale_pattern_manual(values = spp.patterns) + 
  scale_pattern_density_manual(values = spp.pattern_density) + 
  scale_pattern_angle_manual(values = spp.pattern_angles) +
  scale_pattern_spacing_manual(values = spp.pattern_spacing) + 
  scale_fill_manual(values = spp.pattern_fills) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15, color = "black")) + 
  theme(axis.title.y = element_text(size = 15, color = "black")) + 
  theme(axis.text.x = element_text(size = 15, color = "black")) + 
  theme(axis.text.y = element_text(size = 15, color = "black")) + 
  theme(legend.text = element_text(size = 15, color = "black")) + 
  theme(legend.title = element_text(size = 15, color = "black")) + 
  theme(panel.border = element_rect(fill = NA))
spp.ba.plot.patt.2004
###2012
spp.ba.plot.patt.2012 <- ggplot(data = allbahaspp_se_final[allbahaspp_se_final$year == "2012",]) + 
  geom_bar_pattern(stat = "identity", aes(x =stand, y = sppbaha, pattern = spp, pattern_spacing = spp,
                                          fill = spp, pattern_density = spp, pattern_angle = spp), 
                   pattern_fill = "black", pattern_size = 0.5, width = 1, colour = "black")  + 
  labs(x = "stand", y = (expression(Basal~area~(m^2/ha)))) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 45)) + 
  scale_pattern_manual(values = spp.patterns) + 
  scale_pattern_density_manual(values = spp.pattern_density) + 
  scale_pattern_angle_manual(values = spp.pattern_angles) +
  scale_pattern_spacing_manual(values = spp.pattern_spacing) + 
  scale_fill_manual(values = spp.pattern_fills) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15, color = "black")) + 
  theme(axis.title.y = element_text(size = 15, color = "black")) + 
  theme(axis.text.x = element_text(size = 15, color = "black")) + 
  theme(axis.text.y = element_text(size = 15, color = "black")) + 
  theme(legend.text = element_text(size = 15, color = "black")) + 
  theme(legend.title = element_text(size = 15, color = "black")) + 
  theme(panel.border = element_rect(fill = NA))
spp.ba.plot.patt.2012
###2021
spp.ba.plot.patt.2021 <- ggplot(data = allbahaspp_se_final[allbahaspp_se_final$year == "2021",]) + 
  geom_bar_pattern(stat = "identity", aes(x =stand, y = sppbaha, pattern = spp, pattern_spacing = spp,
                                          fill = spp, pattern_density = spp, pattern_angle = spp), 
                   pattern_fill = "black", pattern_size = 0.5, width = 1, colour = "black")  + 
  labs(x = "stand", y = (expression(Basal~area~(m^2/ha)))) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 45)) + 
  scale_pattern_manual(values = spp.patterns) + 
  scale_pattern_density_manual(values = spp.pattern_density) + 
  scale_pattern_angle_manual(values = spp.pattern_angles) +
  scale_pattern_spacing_manual(values = spp.pattern_spacing) + 
  scale_fill_manual(values = spp.pattern_fills) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15, color = "black")) + 
  theme(axis.title.y = element_text(size = 15, color = "black")) + 
  theme(axis.text.x = element_text(size = 15, color = "black")) + 
  theme(axis.text.y = element_text(size = 15, color = "black")) + 
  theme(legend.text = element_text(size = 15, color = "black")) + 
  theme(legend.title = element_text(size = 15, color = "black")) + 
  theme(panel.border = element_rect(fill = NA))
spp.ba.plot.patt.2021

```


###Figure showing progression of BA (m2/ha) for each stand from 1994 to 2020
```{r}
allbaha_se$stand <- factor(allbaha_se$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))
###Change age of Bowl and Pond to 180 to fit on graph
allbaha_se$age[allbaha_se$stand == "Bowl" | allbaha_se$stand == "Pond"] <- 180

###Calculate Harvest year from age
allbaha_se$harvyr <- abs(allbaha_se$age - 2020)
ggplot(data = allbaha_se, aes(x = age, y = standbaha, group = stand, color = stand)) + 
  geom_point(size = 2) + 
  geom_errorbar(aes(ymin=standbaha-se, ymax=standbaha+se), position = position_dodge()) +
  geom_line(size = 1) + 
  labs(x = "stand Age", y = (expression(Basal~area~(m^2/ha))), color = "stand") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,200)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 55)) + 
  scale_color_manual(values = standcolors) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA)) + 
  annotation_custom(textGrob("Pond", gp = gpar(col = "black", fontsize = 15)), xmin = 170, xmax = 170, ymin = 46.3, ymax = 46.3) + 
  annotation_custom(textGrob("Bowl", gp = gpar(col = "black", fontsize = 15)), xmin = 170, xmax = 170, ymin = 32, ymax = 32) + 
  annotate("text", x = 160, y = 0, label = "~", size = 5, angle = 90) +
  annotate("text", x = 170, y = 0, label = "~", size = 5, angle = 90) +
  annotation_custom(segmentsGrob(gp = gpar(col = "black", lwd = 1)), xmin = 180, xmax = 180, ymin = 0, ymax = -.30) +
  annotation_custom(textGrob("Uncut", gp = gpar(col = "black", fontsize = 15)), xmin = 180, xmax = 180, ymin = -0.8, ymax = -0.8 ) + 
  coord_cartesian(clip = "off")

```


#
##
###
###Using allometry to calculate biomass of live trees      
###
##
#
```{r}
overten1994_alive$year <- 1994
overten2004_alive$year <- 2004
overten2012_alive$year <- 2012
overten2021_alive$year <- 2021
head(overten2004_alive)

####Get list of species found in inventory (1994-2021)
overten.alive <- rbind(overten1994_alive, overten2004_alive, overten2012_alive[c(1:3, 6:8, 12:13)], overten2021_alive[c(1:3, 6:8, 12,14)])
###Change "None" to "NONE" to match all entries 
overten.alive$spp[overten.alive$spp == "None"] <- "NONE"

table(overten.alive$spp)
###Full Species List: ASH, ASP, BA, BASS, BC, BE, FIR, HEM, MM, OV, PC, QA, RM, RO, RS, SM, STM, WB, YB

#####Whittaker et al. 1974 species  log10(biomass (g)) = a + b log10(X), X = dbh (cm)
#A. saccharum   a = 2.2151   b = 2.4209
#A. spicatum    a = 2.3096   b = 2.2524
#B. lutea or alleghaniensis  a = 2.2264   b = 2.4150
#F. grandifolia  a = 2.2916  b = 2.3916
#P. rubens      a = 2.3151   b = 2.1830
#low-elevation  a = 2.2380   b = 2.4223

###SM
overten.alive.SM.whit <- overten.alive[overten.alive$spp == "SM", ]
overten.alive.SM.whit$agb = 2.2151 + 2.4209*log10(overten.alive.SM.whit$dbh)
###STM
overten.alive.STM.whit <- overten.alive[overten.alive$spp == "STM", ]
overten.alive.STM.whit$agb = 2.3096 + 2.2524*log10(overten.alive.STM.whit$dbh)
###YB
overten.alive.YB.whit <- overten.alive[overten.alive$spp == "YB", ]
overten.alive.YB.whit$agb = 2.2264 + 2.4150*log10(overten.alive.YB.whit$dbh)
###BE
overten.alive.BE.whit <- overten.alive[overten.alive$spp == "BE", ]
overten.alive.BE.whit$agb = 2.2916 + 2.3916*log10(overten.alive.BE.whit$dbh)
###RS
overten.alive.RS.whit <- overten.alive[overten.alive$spp == "RS", ]
overten.alive.RS.whit$agb = 2.3151 + 2.1830*log10(overten.alive.RS.whit$dbh)

###All other species
overten.alive.leftovers.whit <- overten.alive[-which(overten.alive$spp == "SM" |overten.alive$spp == "STM" | 
                                                  overten.alive$spp == "YB" |overten.alive$spp == "BE" | 
                                                  overten.alive$spp == "RS"), ]
overten.alive.leftovers.whit$agb = 2.2380 + 2.4223*log10(overten.alive.leftovers.whit$dbh)

###Combine all species
overten.alive.agb.whit <- rbind(overten.alive.SM.whit,
                           overten.alive.STM.whit,overten.alive.YB.whit,overten.alive.BE.whit,overten.alive.RS.whit,overten.alive.leftovers.whit)

###AGB g
overten.alive.agb.whit$agb.g <-  10^(overten.alive.agb.whit$agb)
###Agb kg
overten.alive.agb.whit$agb.kg <- overten.alive.agb.whit$agb.g/1000



###Calculate AGB (kg/ha) using Whittaker equations
library(tidyr)
library(tidyverse)

###2021
overten.alive.agb.2021.whit <- overten.alive.agb.whit[which(overten.alive.agb.whit$year == "2021"),]
###Subset OG stands
og.agb.2021.whit <- overten.alive.agb.2021.whit[which(overten.alive.agb.2021.whit$stand == "Bowl"| overten.alive.agb.2021.whit$stand == "Pond"),]
ogtransect.agb.kgha.2021.whit <- og.agb.2021.whit %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*14.1)
ogstandagb.kgha.2021.whit <- ogtransect.agb.kgha.2021.whit %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/5)

ogstandagb.kgha.2021.whit$standagb.Mgha <- ogstandagb.kgha.2021.whit$standagb.kgha/1000

###With species
ogtransect.agb.kgha.spp.2021.whit <- og.agb.2021.whit %>%
  group_by(year, stand, age, transect, spp) %>%
  summarise(transectagb.kgha = sum(agb.kg)*14.1)
ogstandagb.kgha.spp.2021.whit <- ogtransect.agb.kgha.spp.2021.whit %>%
  group_by(year, stand, age, spp) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/5)

###Subset "normal" stands
normies.agb.2021.whit <- overten.alive.agb.2021.whit[which(overten.alive.agb.2021.whit$stand == "H2"| 
                                                   overten.alive.agb.2021.whit$stand == "H3"| overten.alive.agb.2021.whit$stand == "H4"| 
                                                   overten.alive.agb.2021.whit$stand == "H5"| overten.alive.agb.2021.whit$stand == "H6"| 
                                                   overten.alive.agb.2021.whit$stand == "M3"| overten.alive.agb.2021.whit$stand == "M6"| overten.alive.agb.2021.whit$stand == "HB101"),]
###Calculate Kg/ha for each transect, then average for the stand
normiestransect.agb.kg.ha.2021.whit <- normies.agb.2021.whit %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*20)
###Average for each stand
normiesstand.agb.kgha.2021.whit <- normiestransect.agb.kg.ha.2021.whit %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/5)

normiesstand.agb.kgha.2021.whit$standagb.Mgha <- normiesstand.agb.kgha.2021.whit$standagb.kgha/1000




###Subset stands with 5A and 5B transects due to skid trails 
skids.agb.2021.whit <- overten.alive.agb.2021.whit[which(overten.alive.agb.2021.whit$stand == "M4"| overten.alive.agb.2021.whit$stand == "M5" | 
                                                 overten.alive.agb.2021.whit$stand == "T20" | overten.alive.agb.2021.whit$stand == "T30"),]
###Calculate BA/ha for each transect, then average for the stand
skidstransect1234.agb.kg.ha.2021.whit <- skids.agb.2021.whit[which(skids.agb.2021.whit$transect == "L1" | skids.agb.2021.whit$transect == "L2" | 
                                                           skids.agb.2021.whit$transect == "L3" | skids.agb.2021.whit$transect == "L4"),] %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*20)
skidstransect5.agb.kg.ha.2021.whit <- skids.agb.2021.whit[which(skids.agb.2021.whit$transect == "L5A" | skids.agb.2021.whit$transect == "L5B"),] %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = (sum(agb.kg)*40))
skidstransect.agb.kg.ha.2021.whit <- rbind(skidstransect1234.agb.kg.ha.2021.whit, skidstransect5.agb.kg.ha.2021.whit)

skidsstand.agb.kg.ha.2021.whit <- skidstransect.agb.kg.ha.2021.whit %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/6)

skidsstand.agb.kg.ha.2021.whit$standagb.Mgha <- skidsstand.agb.kg.ha.2021.whit$standagb.kgha/1000


###Subset smaller stands
smalls.agb.2021.whit <- overten.alive.agb.2021.whit[which(overten.alive.agb.2021.whit$stand == "H1"| overten.alive.agb.2021.whit$stand == "CC2"),]
###Calculate BA/ha for each transect, then average for the stand
smallstransect.agb.kg.ha.2021.whit <- smalls.agb.2021.whit %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*66.7)
smallsstand.agb.kg.ha.2021.whit <- smallstransect.agb.kg.ha.2021.whit %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/5)

smallsstand.agb.kg.ha.2021.whit$standagb.Mgha <- smallsstand.agb.kg.ha.2021.whit$standagb.kgha/1000

###Combine all stands 
allagb.2021.whit <- rbind(normiesstand.agb.kgha.2021.whit, skidsstand.agb.kg.ha.2021.whit, smallsstand.agb.kg.ha.2021.whit, ogstandagb.kgha.2021.whit)

###Calculate SE
###OG
ogagb_se.2021.whit <- ogtransect.agb.kgha.2021.whit %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(5))
###Normies
normiesagb_se.2021.whit <- normiestransect.agb.kg.ha.2021.whit %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(5))
###Skids
skidsagb_se.2021.whit <- skidstransect.agb.kg.ha.2021.whit %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(6))
###Smaller stands
smallsagb_se.2021.whit <- smallstransect.agb.kg.ha.2021.whit %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(5))
###Combine all stands 
allagb_se.2021.whit <- rbind(ogagb_se.2021.whit, normiesagb_se.2021.whit, skidsagb_se.2021.whit, smallsagb_se.2021.whit)
allagb_se.2021.whit$se.mgha <- allagb_se.2021.whit$se.kgha/1000
###Combine SE and AGB Mg/ha
all.agb.2021.whit <- left_join(allagb.2021.whit, allagb_se.2021.whit, by = c("year", "stand", "age"))

###Re-order stands
all.agb.2021.whit$stand <- factor(all.agb.2021.whit$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))
###Change age of Bowl and Pond to 180
all.agb.2021.whit$age[all.agb.2021.whit$stand == "Bowl" | all.agb.2021.whit$stand == "Pond"] <- 180


###2012
overten.alive.agb.2012.whit <- overten.alive.agb.whit[which(overten.alive.agb.whit$year == "2012"),]
###Subset "normal" stands
normies.agb.2012.whit <- overten.alive.agb.2012.whit[which(overten.alive.agb.2012.whit$stand == "H2"| 
                                                        overten.alive.agb.2012.whit$stand == "H3"| overten.alive.agb.2012.whit$stand == "H4"| 
                                                        overten.alive.agb.2012.whit$stand == "H5"| overten.alive.agb.2012.whit$stand == "H6"| 
                                                        overten.alive.agb.2012.whit$stand == "M3"| overten.alive.agb.2012.whit$stand == "M6"| overten.alive.agb.2012.whit$stand == "HB101"),]
###Calculate Kg/ha for each transect, then average for the stand
normiestransect.agb.kg.ha.2012.whit <- normies.agb.2012.whit %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*20)
###Average for each stand
normiesstand.agb.kgha.2012.whit <- normiestransect.agb.kg.ha.2012.whit %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/5)

normiesstand.agb.kgha.2012.whit$standagb.Mgha <- normiesstand.agb.kgha.2012.whit$standagb.kgha/1000




###Subset stands with 5A and 5B transects due to skid trails 
skids.agb.2012.whit <- overten.alive.agb.2012.whit[which(overten.alive.agb.2012.whit$stand == "M4"| overten.alive.agb.2012.whit$stand == "M5" | 
                                                      overten.alive.agb.2012.whit$stand == "T20" | overten.alive.agb.2012.whit$stand == "T30"),]
###Calculate BA/ha for each transect, then average for the stand
skidstransect1234.agb.kg.ha.2012.whit <- skids.agb.2012.whit[which(skids.agb.2012.whit$transect == "L1" | skids.agb.2012.whit$transect == "L2" | 
                                                                     skids.agb.2012.whit$transect == "L3" | skids.agb.2012.whit$transect == "L4"),] %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*20)
skidstransect5.agb.kg.ha.2012.whit <- skids.agb.2012.whit[which(skids.agb.2012.whit$transect == "L5A" | skids.agb.2012.whit$transect == "L5B"),] %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = (sum(agb.kg)*40))
skidstransect.agb.kg.ha.2012.whit <- rbind(skidstransect1234.agb.kg.ha.2012.whit, skidstransect5.agb.kg.ha.2012.whit)

skidsstand.agb.kg.ha.2012.whit <- skidstransect.agb.kg.ha.2012.whit %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/6)

skidsstand.agb.kg.ha.2012.whit$standagb.Mgha <- skidsstand.agb.kg.ha.2012.whit$standagb.kgha/1000


###Subset smaller stands
smalls.agb.2012.whit <- overten.alive.agb.2012.whit[which(overten.alive.agb.2012.whit$stand == "H1"| overten.alive.agb.2012.whit$stand == "CC2"),]
###Calculate BA/ha for each transect, then average for the stand
smallstransect.agb.kg.ha.2012.whit <- smalls.agb.2012.whit %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*66.7)
smallsstand.agb.kg.ha.2012.whit <- smallstransect.agb.kg.ha.2012.whit %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/5)

smallsstand.agb.kg.ha.2012.whit$standagb.Mgha <- smallsstand.agb.kg.ha.2012.whit$standagb.kgha/1000

###Combine all stands 
allagb.2012.whit <- rbind(normiesstand.agb.kgha.2012.whit, skidsstand.agb.kg.ha.2012.whit, smallsstand.agb.kg.ha.2012.whit)

###Calculate SE
###Normies
normiesagb_se.2012.whit <- normiestransect.agb.kg.ha.2012.whit %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(5))
###Skids
skidsagb_se.2012.whit <- skidstransect.agb.kg.ha.2012.whit %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(6))
###Smaller stands
smallsagb_se.2012.whit <- smallstransect.agb.kg.ha.2012.whit %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(5))
###Combine all stands 
allagb_se.2012.whit <- rbind(normiesagb_se.2012.whit, skidsagb_se.2012.whit, smallsagb_se.2012.whit)
allagb_se.2012.whit$se.mgha <- allagb_se.2012.whit$se.kgha/1000
###Combine SE and AGB Mg/ha
all.agb.2012.whit <- left_join(allagb.2012.whit, allagb_se.2012.whit, by = c("year", "stand", "age"))

###Re-order stands
all.agb.2012.whit$stand <- factor(all.agb.2012.whit$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))


###2004
overten.alive.agb.2004.whit <- overten.alive.agb.whit[which(overten.alive.agb.whit$year == "2004"),]

###Subset "normal" stands
normies.agb.2004.whit <- overten.alive.agb.2004.whit[which(overten.alive.agb.2004.whit$stand == "H2"| 
                                                        overten.alive.agb.2004.whit$stand == "H3"| overten.alive.agb.2004.whit$stand == "H4"| 
                                                        overten.alive.agb.2004.whit$stand == "H5"| overten.alive.agb.2004.whit$stand == "H6"| 
                                                        overten.alive.agb.2004.whit$stand == "M3"| overten.alive.agb.2004.whit$stand == "M4"|
                                                        overten.alive.agb.2004.whit$stand == "M5" | overten.alive.agb.2004.whit$stand == "M6"| 
                                                        overten.alive.agb.2004.whit$stand == "HB101"| overten.alive.agb.2004.whit$stand == "T20" | overten.alive.agb.2004.whit$stand == "T30"),]
###Calculate Kg/ha for each transect, then average for the stand
normiestransect.agb.kg.ha.2004.whit <- normies.agb.2004.whit %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*20)
###Average for each stand
normiesstand.agb.kgha.2004.whit <- normiestransect.agb.kg.ha.2004.whit %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/5)

normiesstand.agb.kgha.2004.whit$standagb.Mgha <- normiesstand.agb.kgha.2004.whit$standagb.kgha/1000


###Subset smaller stands
smalls.agb.2004.whit <- overten.alive.agb.2004.whit[which(overten.alive.agb.2004.whit$stand == "H1"| overten.alive.agb.2004.whit$stand == "CC2"),]
###Calculate BA/ha for each transect, then average for the stand
smallstransect.agb.kg.ha.2004.whit <- smalls.agb.2004.whit %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*66.7)
smallsstand.agb.kg.ha.2004.whit <- smallstransect.agb.kg.ha.2004.whit %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/5)

smallsstand.agb.kg.ha.2004.whit$standagb.Mgha <- smallsstand.agb.kg.ha.2004.whit$standagb.kgha/1000

###Combine all stands 
allagb.2004.whit <- rbind(normiesstand.agb.kgha.2004.whit, smallsstand.agb.kg.ha.2004.whit)

###Calculate SE
###Normies
normiesagb_se.2004.whit <- normiestransect.agb.kg.ha.2004.whit %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(5))
###Smaller stands
smallsagb_se.2004.whit <- smallstransect.agb.kg.ha.2004.whit %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(5))
###Combine all stands 
allagb_se.2004.whit <- rbind(normiesagb_se.2004.whit, smallsagb_se.2004.whit)
allagb_se.2004.whit$se.mgha <- allagb_se.2004.whit$se.kgha/1000
###Combine SE and AGB Mg/ha
all.agb.2004.whit <- left_join(allagb.2004.whit, allagb_se.2004.whit, by = c("year", "stand", "age"))

###Re-order stands
all.agb.2004.whit$stand <- factor(all.agb.2004.whit$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))


###1994
overten.alive.agb.1994.whit <- overten.alive.agb.whit[which(overten.alive.agb.whit$year == "1994"),]

###Subset "normal" stands
normies.agb.1994.whit <- overten.alive.agb.1994.whit[which(overten.alive.agb.1994.whit$stand == "H2"| 
                                                        overten.alive.agb.1994.whit$stand == "H3"| overten.alive.agb.1994.whit$stand == "H4"| 
                                                        overten.alive.agb.1994.whit$stand == "H5"| overten.alive.agb.1994.whit$stand == "H6"| 
                                                        overten.alive.agb.1994.whit$stand == "M3"| overten.alive.agb.1994.whit$stand == "M4"|
                                                        overten.alive.agb.1994.whit$stand == "M5" | overten.alive.agb.1994.whit$stand == "M6"| 
                                                        overten.alive.agb.1994.whit$stand == "HB101"| overten.alive.agb.1994.whit$stand == "T20" | overten.alive.agb.1994.whit$stand == "T30"),]
###Calculate Kg/ha for each transect, then average for the stand
normiestransect.agb.kg.ha.1994.whit <- normies.agb.1994.whit %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*20)
###Average for each stand
normiesstand.agb.kgha.1994.whit <- normiestransect.agb.kg.ha.1994.whit %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/5)

normiesstand.agb.kgha.1994.whit$standagb.Mgha <- normiesstand.agb.kgha.1994.whit$standagb.kgha/1000


###Subset smaller stands
smalls.agb.1994.whit <- overten.alive.agb.1994.whit[which(overten.alive.agb.1994.whit$stand == "H1"),]
###Calculate BA/ha for each transect, then average for the stand
smallstransect.agb.kg.ha.1994.whit <- smalls.agb.1994.whit %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*66.7)
smallsstand.agb.kg.ha.1994.whit <- smallstransect.agb.kg.ha.1994.whit %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/5)

smallsstand.agb.kg.ha.1994.whit$standagb.Mgha <- smallsstand.agb.kg.ha.1994.whit$standagb.kgha/1000

###Combine all stands 
allagb.1994.whit <- rbind(normiesstand.agb.kgha.1994.whit, smallsstand.agb.kg.ha.1994.whit)

###Calculate SE
###Normies
normiesagb_se.1994.whit <- normiestransect.agb.kg.ha.1994.whit %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(5))
###Smaller stands
smallsagb_se.1994.whit <- smallstransect.agb.kg.ha.1994.whit %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(5))
###Combine all stands 
allagb_se.1994.whit <- rbind(normiesagb_se.1994.whit, smallsagb_se.1994.whit)
allagb_se.1994.whit$se.mgha <- allagb_se.1994.whit$se.kgha/1000
###Combine SE and AGB Mg/ha
all.agb.1994.whit <- left_join(allagb.1994.whit, allagb_se.1994.whit, by = c("year", "stand", "age"))

###Re-order stands
all.agb.1994.whit$stand <- factor(all.agb.1994.whit$stand, levels = c("H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))

###Combine all years
all.agb.whit <- rbind(all.agb.1994.whit, all.agb.2004.whit, all.agb.2012.whit, all.agb.2021.whit)

```

###Set colors for sampling years
```{r}
year.colors <- c("#999999", "#56B4E9", "#009E73", "#D55E00")
names(year.colors) <- c("1994", "2004", "2012", "2021")
```


```{r}
agb_2021 <- all.agb.whit %>% filter(year == "2021")
```




###Progression of Live Above Ground Biomass Whittaker Equations
```{r}
ggplot(data = all.agb.whit, aes(x = age, y = standagb.Mgha, group = stand, color = factor(year))) + 
  geom_point(size = 2) + 
  geom_errorbar(aes(ymin=standagb.Mgha-se.mgha, ymax=standagb.Mgha+se.mgha), size = 1.2, position = position_dodge()) + 
  geom_line(size = 1.2, color = "black") + 
  geom_label_repel(data = agb_2021, aes(label = stand), size = 8, color = "black", label.padding = .08, box.padding = 0.1) + 
  labs(x = "Stand Age", y = "Live aboveground biomass (Mg/ha)", color = "Sampling year") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,200)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 550)) + 
  scale_color_manual(values = year.colors) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 20, color = "black")) + 
  theme(axis.title.y = element_text(size = 20, color = "black")) + 
  theme(axis.text.x = element_text(size = 20, color = "black")) + 
  theme(axis.text.y = element_text(size = 20, color = "black")) + 
  theme(legend.text = element_text(size = 20, color = "black")) + 
  theme(legend.title = element_text(size = 20, color = "black")) + 
  theme(panel.border = element_rect(fill = NA)) + 
  annotate("text", x = 160, y = 0, label = "~", size = 5, angle = 90) +
  annotate("text", x = 170, y = 0, label = "~", size = 5, angle = 90) +
  annotation_custom(segmentsGrob(gp = gpar(col = "black", lwd = 1)), xmin = 180, xmax = 180, ymin = -5, ymax = 0) +
  annotation_custom(textGrob("Uncut", gp = gpar(col = "black", fontsize = 20)), xmin = 180, xmax = 180, ymin = -10, ymax = -10) +
  coord_cartesian(clip = "off")

```


###########         ##########
######                  ######
####                      ####
##        X       X         ##
#                            #  
##                          ##
###       ---------        ###
######                  ######
##########          ##########   

#####Snag visualizations
###2021
```{r}
###Subset Snag data
overten2021_snag <- overten2021[overten2021$status == "D",]


###Calculate Basal Area m2 (BA) for each tree
overten2021_snag$ba <- 0.00007854*(overten2021_snag$dbh^2) 

###Calculate Snag BA for each transect in each stand
### 1 ha = 10000 m2
###Area of a transect = 10 m * 50 m = 500 m2 for H2, H3, H4, H5, H6, M3, M6, HB101,     10000/500 = 20
###                   = 10 m * 25 m = 250 m2 for 5a and 5b transects in M4, M5, T20, and T30    10000/250 = 40
###                   = 5 m * 30 m = 150 m2 for H1 and CC2                                 10000/150 = 66.7
###                   = 10 m * 70.7 m  = 707 m2 in Bowl and Mt. Pond                        10000/707 = 14.1


transectba2021_snag <- overten2021_snag %>%
  group_by(stand, age, transect) %>%
  summarise(transectba = sum(ba))

###By species
transectbaspp2021_snag <- overten2021_snag %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectba = sum(ba))

###Subset OG stands
og2021_snag <- overten2021_snag[which(overten2021_snag$stand == "Bowl"| overten2021_snag$stand == "Pond"),]

ogtransectbaha2021_snag <- og2021_snag %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(ba)*14.1)
ogstandbaha2021_snag <- ogtransectbaha2021_snag %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/5)
###With species
ogtransectbahaspp2021_snag <- og2021_snag %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*14.1)
ogstandbahaspp2021_snag <- ogtransectbahaspp2021_snag %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/5)

###Subset "normal" stands
normies2021_snag <- overten2021_snag[which(overten2021_snag$stand == "H2"| overten2021_snag$stand == "H3"| 
                                             overten2021_snag$stand == "H4"| overten2021_snag$stand == "H5"| 
                                             overten2021_snag$stand == "H6"| overten2021_snag$stand == "M3"| 
                                             overten2021_snag$stand == "M6"| overten2021_snag$stand == "HB101"),]
###Calculate BA/ha for each transect, then average for the stand
normiestransectba2021_snag <- normies2021_snag %>%
  group_by(stand, age, transect) %>%
  summarise(transectba = sum(ba))
normiestransectbaha2021_snag <- normiestransectba2021_snag %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(transectba)*20)
###Sum for each stand
normiesstandbaha2021_snag <- normiestransectbaha2021_snag %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/5)

###With species
normiestransectbahaspp2021_snag <- normies2021_snag %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*20)
normiesstandbahaspp2021_snag <- normiestransectbahaspp2021_snag %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/5)


###Subset stands with 5A and 5B transects due to skid trails 
skids2021_snag <- overten2021_snag[which(overten2021_snag$stand == "M4"| overten2021_snag$stand == "M5" | 
                                           overten2021_snag$stand == "T20" | overten2021_snag$stand == "T30"),]
###Calculate BA/ha for each transect, then average for the stand
skidstransect1234baha2021_snag <- skids2021_snag[which(skids2021_snag$transect == "L1" | 
                                                         skids2021_snag$transect == "L2" | 
                                                         skids2021_snag$transect == "L3" | 
                                                         skids2021_snag$transect == "L4"),] %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(ba)*20)
skidstransect5baha2021_snag <- skids2021_snag[which(skids2021_snag$transect == "L5A" | skids2021_snag$transect == "L5B"),] %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = (sum(ba)*40))
skidstransectbaha2021_snag <- rbind(skidstransect1234baha2021_snag, skidstransect5baha2021_snag)

skidsstandbaha2021_snag <- skidstransectbaha2021_snag %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/6)

###With species
skidstransect1234bahaspp2021_snag <- skids2021_snag[which(skids2021_snag$transect == "L1" | 
                                                            skids2021_snag$transect == "L2" | 
                                                            skids2021_snag$transect == "L3" | 
                                                            skids2021_snag$transect == "L4"),] %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*20)
skidstransect5bahaspp2021_snag <- skids2021_snag[which(skids2021_snag$transect == "L5A" | skids2021_snag$transect == "L5B"),] %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = (sum(ba)*40))
skidstransectbahaspp2021_snag <- rbind(skidstransect1234bahaspp2021_snag, skidstransect5bahaspp2021_snag)

skidsstandbahaspp2021_snag <- skidstransectbahaspp2021_snag %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/6)


###Subset smaller stands
smalls2021_snag <- overten2021_snag[which(overten2021_snag$stand == "H1"| overten2021_snag$stand == "CC2"),]
###Calculate BA/ha for each transect, then average for the stand
smallstransectbaha2021_snag <- smalls2021_snag %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(ba)*66.7)
smallsstandbaha2021_snag <- smallstransectbaha2021_snag %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/5)

###With species
smallstransectbahaspp2021_snag <- smalls2021_snag %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*66.7)
smallsstandbahaspp2021_snag <- smallstransectbahaspp2021_snag %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/5)


###Combine all stands 
allba2021_snag <- rbind(normiesstandbaha2021_snag, skidsstandbaha2021_snag, smallsstandbaha2021_snag, ogstandbaha2021_snag)
allba2021_snag$year <- 2021
allba2021_snag$stand <- factor(allba2021_snag$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))
###With species
allbaspp2021_snag <- rbind(normiesstandbahaspp2021_snag, skidsstandbahaspp2021_snag, smallsstandbahaspp2021_snag)
allbaspp2021_snag$year <- 2021
###Beech only
allba_beech2021_snag <- allbaspp2021_snag[allbaspp2021_snag$spp == "BE", ]
allba_beech2021_snag$year <- 2021
```


###########         ##########
######                  ######
####                      ####
##        X       X         ##
#                            #  
##                          ##
###       ---------        ###
######                  ######
##########          ##########   

###2012
```{r}
###Subset Snag data
overten2012_snag <- overten2012[overten2012$status == "D",]


###Calculate Basal Area m2 (BA) for each tree
overten2012_snag$ba <- 0.00007854*(overten2012_snag$dbh^2) 

###Calculate LIVE BA for each transect in each stand
### 1 ha = 10000 m2
###Area of a transect = 10 m * 50 m = 500 m2 for H2, H3, H4, H5, H6, M3, M6, HB101,     10000/500 = 20
###                   = 10 m * 25 m = 250 m2 for 5a and 5b transects in M4, M5, T20, and T30    10000/250 = 40
###                   = 5 m * 30 m = 150 m2 for H1 and CC2                                 10000/150 = 66.7


library(tidyr)
library(tidyverse)
transectba2012_snag <- overten2012_snag %>%
  group_by(stand, age, transect) %>%
  summarise(transectba = sum(ba))

###By species
transectbaspp2012_snag <- overten2012_snag %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectba = sum(ba))


###Subset "normal" stands
normies2012_snag <- overten2012_snag[which(overten2012_snag$stand == "H2"| overten2012_snag$stand == "H3"| 
                                             overten2012_snag$stand == "H4"| overten2012_snag$stand == "H5"| 
                                             overten2012_snag$stand == "H6"| overten2012_snag$stand == "M3"| 
                                             overten2012_snag$stand == "M6"| overten2012_snag$stand == "HB101"),]
###Calculate BA/ha for each transect, then average for the stand
normiestransectba2012_snag <- normies2012_snag %>%
  group_by(stand, age, transect) %>%
  summarise(transectba = sum(ba))
normiestransectbaha2012_snag <- normiestransectba2012_snag %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(transectba)*20)
###Sum for each stand
normiesstandbaha2012_snag <- normiestransectbaha2012_snag %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/5)

###With species
normiestransectbahaspp2012_snag <- normies2012_snag %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*20)
normiesstandbahaspp2012_snag <- normiestransectbahaspp2012_snag %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/5)


###Subset stands with 5A and 5B transects due to skid trails 
skids2012_snag <- overten2012_snag[which(overten2012_snag$stand == "M4"| overten2012_snag$stand == "M5" | 
                                           overten2012_snag$stand == "T20" | overten2012_snag$stand == "T30"),]
###Calculate BA/ha for each transect, then average for the stand
skidstransect1234baha2012_snag <- skids2012_snag[which(skids2012_snag$transect == "L1" | 
                                                         skids2012_snag$transect == "L2" | 
                                                         skids2012_snag$transect == "L3" | 
                                                         skids2012_snag$transect == "L4"),] %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(ba)*20)
skidstransect5baha2012_snag <- skids2012_snag[which(skids2012_snag$transect == "L5A" | skids2012_snag$transect == "L5B"),] %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = (sum(ba)*40))
skidstransectbaha2012_snag <- rbind(skidstransect1234baha2012_snag, skidstransect5baha2012_snag)

skidsstandbaha2012_snag <- skidstransectbaha2012_snag %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/6)

###With species
skidstransect1234bahaspp2012_snag <- skids2012_snag[which(skids2012_snag$transect == "L1" | 
                                                            skids2012_snag$transect == "L2" | 
                                                            skids2012_snag$transect == "L3" | 
                                                            skids2012_snag$transect == "L4"),] %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*20)
skidstransect5bahaspp2012_snag <- skids2012_snag[which(skids2012_snag$transect == "L5A" | skids2012_snag$transect == "L5B"),] %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = (sum(ba)*40))
skidstransectbahaspp2012_snag <- rbind(skidstransect1234bahaspp2012_snag, skidstransect5bahaspp2012_snag)

skidsstandbahaspp2012_snag <- skidstransectbahaspp2012_snag %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/6)


###Subset smaller stands
smalls2012_snag <- overten2012_snag[which(overten2012_snag$stand == "H1"| overten2012_snag$stand == "CC2"),]
###Calculate BA/ha for each transect, then average for the stand
smallstransectbaha2012_snag <- smalls2012_snag %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(ba)*66.7)
smallsstandbaha2012_snag <- smallstransectbaha2012_snag %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/5)

###With species
smallstransectbahaspp2012_snag <- smalls2012_snag %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*66.7)
smallsstandbahaspp2012_snag <- smallstransectbahaspp2012_snag %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/5)


###Combine all stands 
allba2012_snag <- rbind(normiesstandbaha2012_snag, skidsstandbaha2012_snag, smallsstandbaha2012_snag)
allba2012_snag$year <- 2012
allba2012_snag$stand <- factor(allba2012_snag$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3"))
###With species
allbaspp2012_snag <- rbind(normiesstandbahaspp2012_snag, skidsstandbahaspp2012_snag, smallsstandbahaspp2012_snag)
allbaspp2012_snag$year <- 2012
###Beech only
allba_beech2012_snag <- allbaspp2012_snag[allbaspp2012_snag$spp == "BE", ]
allba_beech2012_snag$year <- 2012

```

###########         ##########
######                  ######
####                      ####
##        X       X         ##
#                            #  
##                          ##
###       ---------        ###
######                  ######
##########          ##########   


###2004  
```{r}
###Subset Snag data
overten2004_snag <- overten2004[overten2004$status == "D",]


###Calculate Basal Area m2 (BA) for each tree
overten2004_snag$ba <- 0.00007854*(overten2004_snag$dbh^2) 


###Calculate Dead BA for each transect in each stand
### 1 ha = 10000 m2
###Area of a transect = 10 m * 50 m = 500 m2 for H2, H3, H4, H5, H6, M3, M4, M6, HB101, M5, T20, and T30    10000/500 = 20
###                   = 5 m * 30 m = 150 m2 for H1 and CC2                                 10000/150 = 66.7

library(tidyr)
library(tidyverse)
transectba2004_snag <- overten2004_snag %>%
  group_by(stand, age, transect) %>%
  summarise(transectba = sum(ba))

###By species
transectbaspp2004_snag <- overten2004_snag %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectba = sum(ba))


###Subset "normal" stands
normies2004_snag <- overten2004_snag[which(overten2004_snag$stand == "H2"| overten2004_snag$stand == "H3"| overten2004_snag$stand == "H4"| 
                                             overten2004_snag$stand == "H5"| overten2004_snag$stand == "H6"| overten2004_snag$stand == "M3"| 
                                             overten2004_snag$stand == "M4"| overten2004_snag$stand == "M6"| overten2004_snag$stand == "HB101"|
                                             overten2004_snag$stand == "M5" | overten2004_snag$stand == "T20" | overten2004_snag$stand == "T30"),]
###Calculate BA/ha for each transect, then average for the stand
normiestransectba2004_snag <- normies2004_snag %>%
  group_by(stand, age, transect) %>%
  summarise(transectba = sum(ba))
normiestransectbaha2004_snag <- normiestransectba2004_snag %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(transectba)*20)
###Sum for each stand
normiesstandbaha2004_snag <- normiestransectbaha2004_snag %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/5)

###With species
normiestransectbahaspp2004_snag <- normies2004_snag %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*20)
normiesstandbahaspp2004_snag <- normiestransectbahaspp2004_snag %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/5)

###Subset smaller stands
smalls2004_snag <- overten2004_snag[which(overten2004_snag$stand == "H1"| overten2004_snag$stand == "CC2"),]
###Calculate BA/ha for each transect, then average for the stand
smallstransectbaha2004_snag <- smalls2004_snag %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(ba)*66.7)
smallsstandbaha2004_snag <- smallstransectbaha2004_snag %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/5)

###With species
smallstransectbahaspp2004_snag <- smalls2004_snag %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*66.7)
smallsstandbahaspp2004_snag <- smallstransectbahaspp2004_snag %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/5)


###Combine all stands 
allba2004_snag <- rbind(normiesstandbaha2004_snag, smallsstandbaha2004_snag)
allba2004_snag$year <- 2004
allba2004_snag$stand <- factor(allba2004_snag$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3"))
###With species
allbaspp2004_snag <- rbind(normiesstandbahaspp2004_snag,smallsstandbahaspp2004_snag)
allbaspp2004_snag$year <- 2004
###Beech only
allba_beech2004_snag <- allbaspp2004_snag[allbaspp2004_snag$spp == "BE", ]
allba_beech2004_snag$year <- 2004
```

###########         ##########
######                  ######
####                      ####
##        X       X         ##
#                            #  
##                          ##
###       ---------        ###
######                  ######
##########          ##########   

###1994 
```{r}
###Subset Snag data
overten1994_snag <- overten1994[overten1994$status == "D",]
###Calculate Basal Area m2 (BA) for each tree
overten1994_snag$ba <- 0.00007854*(overten1994_snag$dbh^2) 


###Calculate dead BA for each transect in each stand
### 1 ha = 10000 m2
###Area of a transect = 10 m * 50 m = 500 m2 for H2, H3, H4, H5, H6, M3, M4, M6, HB101, M5, T20, and T30    10000/500 = 20
###                   = 5 m * 30 m = 150 m2 for H1                                 10000/150 = 66.7


transectba1994_snag <- overten1994_snag %>%
  group_by(stand, age, transect) %>%
  summarise(transectba = sum(ba))

###By species
transectbaspp1994_snag <- overten1994_snag %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectba = sum(ba))


###Subset "normal" stands
normies1994_snag <- overten1994_snag[which(overten1994_snag$stand == "H2"| overten1994_snag$stand == "H3"| overten1994_snag$stand == "H4"| 
                                             overten1994_snag$stand == "H5"| overten1994_snag$stand == "H6"| overten1994_snag$stand == "M3"| 
                                             overten1994_snag$stand == "M4"| overten1994_snag$stand == "M6"| overten1994_snag$stand == "HB101"|
                                             overten1994_snag$stand == "M5" | overten1994_snag$stand == "T20" | overten1994_snag$stand == "T30"),]
###Calculate BA/ha for each transect, then average for the stand
normiestransectba1994_snag <- normies1994_snag %>%
  group_by(stand, age, transect) %>%
  summarise(transectba = sum(ba))
normiestransectbaha1994_snag <- normiestransectba1994_snag %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(transectba)*20)
###Sum for each stand
normiesstandbaha1994_snag <- normiestransectbaha1994_snag %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/5)

###With species
normiestransectbahaspp1994_snag <- normies1994_snag %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*20)
normiesstandbahaspp1994_snag <- normiestransectbahaspp1994_snag %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/5)



###Subset smaller stands
smalls1994_snag <- overten1994_snag[which(overten1994_snag$stand == "H1"),]
###Calculate BA/ha for each transect, then average for the stand
smallstransectbaha1994_snag <- smalls1994_snag %>%
  group_by(stand, age, transect) %>%
  summarise(transectbaha = sum(ba)*66.7)
smallsstandbaha1994_snag <- smallstransectbaha1994_snag %>%
  group_by(stand, age) %>%
  summarise(standbaha = sum(transectbaha)/5)

###With species
smallstransectbahaspp1994_snag <- smalls1994_snag %>%
  group_by(stand, age, transect, spp) %>%
  summarise(transectbaha = sum(ba)*66.7)
smallsstandbahaspp1994_snag <- smallstransectbahaspp1994_snag %>%
  group_by(stand, age, spp) %>%
  summarise(standbaha = sum(transectbaha)/5)


###Combine all stands 
allba1994_snag <- rbind(normiesstandbaha1994_snag, smallsstandbaha1994_snag)
allba1994_snag$year <- 1994
allba1994_snag$stand <- factor(allba1994_snag$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3"))
###With species
allbaspp1994_snag <- rbind(normiesstandbahaspp1994_snag, smallsstandbahaspp1994_snag)
allbaspp1994_snag$year <- 1994
###Beech only
allba_beech1994_snag <- allbaspp1994_snag[allbaspp1994_snag$spp == "BE", ]
allba_beech1994_snag$year <- 1994



###Combine all years
allba_snag <- rbind(allba1994_snag, allba2004_snag, allba2012_snag, allba2021_snag)
allba_snag$stand <- factor(allba_snag$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))
###With species
allbaspp_snag <- rbind(allbaspp1994_snag, allbaspp2004_snag, allbaspp2012_snag, allbaspp2021_snag)
###Beech only
allba_beech_snag <- rbind(allba_beech1994_snag, allba_beech2004_snag, allba_beech2012_snag, allba_beech2021_snag)

###Calculate BA SE for each stand
###2021
###OG
og_se_2021_snag <- ogtransectbaha2021_snag %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Normies
normies_se_2021_snag <- normiestransectbaha2021_snag %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Skids
skids_se_2021_snag <- skidstransectbaha2021_snag %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(6))
###Smaller stands
smalls_se_2021_snag <- smallstransectbaha2021_snag %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Combine all stands 
allba_se_2021_snag <- rbind(og_se_2021_snag, normies_se_2021_snag, skids_se_2021_snag, smalls_se_2021_snag)
allba_se_2021_snag$year <- 2021

###2012
###Normies
normies_se_2012_snag <- normiestransectbaha2012_snag %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Skids
skids_se_2012_snag <- skidstransectbaha2012_snag %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(6))
###Smaller stands
smalls_se_2012_snag <- smallstransectbaha2012_snag %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Combine all stands
allba_se_2012_snag <- rbind(normies_se_2012_snag, skids_se_2012_snag, smalls_se_2012_snag)
allba_se_2012_snag$year <- 2012

###2004
###Normies
normies_se_2004_snag <- normiestransectbaha2004_snag %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Smaller stands
smalls_se_2004_snag <- smallstransectbaha2004_snag %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Combine all stands
allba_se_2004_snag <- rbind(normies_se_2004_snag, smalls_se_2004_snag)
allba_se_2004_snag$year <- 2004

###1994
###Normies
normies_se_1994_snag <- normiestransectbaha1994_snag %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Smaller stands
smalls_se_1994_snag <- smallstransectbaha1994_snag %>%
  group_by(stand, age) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Combine all stands
allba_se_1994_snag <- rbind(normies_se_1994_snag, smalls_se_1994_snag)
allba_se_1994_snag$year <- 1994

```

###Combine all years
```{r}
allba_se_snag <- rbind(allba_se_1994_snag, allba_se_2004_snag, allba_se_2012_snag, allba_se_2021_snag)
###Combine BA (m2/ha) and SE for all stands - OG
allbaha_se_snag <- left_join(allba_snag, allba_se_snag, by = c("stand", "age", "year"))
```


###With species
```{r}
###2021
###Old Growth
ogspp_se_2021_snag <- ogtransectbahaspp2021_snag %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Normies
normiesspp_se_2021_snag <- normiestransectbahaspp2021_snag %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Skids
skidsspp_se_2021_snag <- skidstransectbahaspp2021_snag %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(6))
###Smaller stands
smallsspp_se_2021_snag <- smallstransectbahaspp2021_snag %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Combine all stands
allbaspp_se_2021_snag <- rbind(ogspp_se_2021_snag, normiesspp_se_2021_snag, skidsspp_se_2021_snag, smallsspp_se_2021_snag)
allbaspp_se_2021_snag$year <- 2021

###2012
###Normies
normiesspp_se_2012_snag <- normiestransectbahaspp2012_snag %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Skids
skidsspp_se_2012_snag <- skidstransectbahaspp2012_snag %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(6))
###Smaller stands
smallsspp_se_2012_snag <- smallstransectbahaspp2012_snag %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Combine all stands
allbaspp_se_2012_snag <- rbind(normiesspp_se_2012_snag, skidsspp_se_2012_snag, smallsspp_se_2012_snag)
allbaspp_se_2012_snag$year <- 2012

###2004
###Normies
normiesspp_se_2004_snag <- normiestransectbahaspp2004_snag %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Smaller stands
smallsspp_se_2004_snag <- smallstransectbahaspp2004_snag %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Combine all stands
allbaspp_se_2004_snag <- rbind(normiesspp_se_2004_snag, smallsspp_se_2004_snag)
allbaspp_se_2004_snag$year <- 2004

###1994
###Normies
normiesspp_se_1994_snag <- normiestransectbahaspp1994_snag %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Smaller stands
smallsspp_se_1994_snag <- smallstransectbahaspp1994_snag %>%
  group_by(stand, age, spp) %>%
  summarise(se = sd(transectbaha)/sqrt(5))
###Combine all stands
allbaspp_se_1994_snag <- rbind(normiesspp_se_1994_snag, smallsspp_se_1994_snag)
allbaspp_se_1994_snag$year <- 1994

```

###Combine all years
```{r}
allbaspp_se_snag <- rbind(allbaspp_se_1994_snag, allbaspp_se_2004_snag, allbaspp_se_2012_snag, allbaspp_se_2021_snag)
###Combine BA (m2/ha) and SE
allbahaspp_se_snag <- left_join(allbaspp_snag, allbaspp_se_snag, by = c("stand", "age", "spp", "year"))
###Replace NA's with 0
allbahaspp_se_snag$se[is.na(allbahaspp_se_snag$se)] <- 0
```

###Figure showing progression of snag BA (m2/ha) for each stand from 1994 to 2020
```{r}
allbaha_se_snag$stand <- factor(allbaha_se_snag$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))
###Change age to 180 for Bowl and Pond so they fit on the graph
allbaha_se_snag$age[allbaha_se_snag$stand == "Bowl"|allbaha_se_snag$stand == "Pond"] <- 180
###Calculate harvest year based on age
allbaha_se_snag$harvyr <- abs(allbaha_se_snag$age - 2020)

ggplot(data = allbaha_se_snag, aes(x = age, y = standbaha, group = stand, color = stand)) + 
  geom_point(size = 2) + 
  geom_errorbar(aes(ymin=pmax(standbaha-se,0), ymax=standbaha+se), position = position_dodge()) +
  geom_line(size = 1) + 
  labs(x = "stand Age", y = (expression(Standing~dead~basal~area~(m^2/ha))), color = "stand") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,200)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 14)) + 
  scale_color_manual(values = standcolors) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA)) + 
  annotation_custom(textGrob("Pond", gp = gpar(col = "black", fontsize = 15)), xmin = 170, xmax = 170, ymin = 7.3, ymax = 7.3) + 
  annotation_custom(textGrob("Bowl", gp = gpar(col = "black", fontsize = 15)), xmin = 170, xmax = 170, ymin = 4, ymax = 4) + 
  annotate("text", x = 160, y = 0, label = "~", size = 5, angle = 90) +
  annotate("text", x = 170, y = 0, label = "~", size = 5, angle = 90) +
  annotation_custom(segmentsGrob(gp = gpar(col = "black", lwd = 1)), xmin = 180, xmax = 180, ymin = 0, ymax = -.08) +
  annotation_custom(textGrob("Uncut", gp = gpar(col = "black", fontsize = 15)), xmin = 180, xmax = 180, ymin = -0.3, ymax = -0.3 ) + 
  coord_cartesian(clip = "off")

```

#
##
###
###Using allometry to calculate biomass of standing dead trees  log10(biomass (g)) = a + b log10(X), X = dbh (cm)
###
##
#
```{r}
overten1994_snag$year <- 1994
overten2004_snag$year <- 2004
overten2012_snag$year <- 2012
overten2021_snag$year <- 2021

####Get list of species found in inventory (1994-2021)
overten.snag <- rbind(overten1994_snag, overten2004_snag, overten2012_snag[c(1:3, 6:8, 12:13)], overten2021_snag[c(1:3, 6:8, 12,14)])
###Change "None" to "NONE" to match all entries 
overten.snag$spp[overten.snag$spp == "None"] <- "NONE"

table(overten.snag$spp)
###Full Species List: ASH, ASP, BA, BE, FIR, HEM, PC, QA, RM, RS, SM, STM, WB, YB

#####Whittaker et al. 1974 species  log10(biomass (g)) = a + b log10(X), X = dbh (cm)
#A. saccharum   a = 2.2151   b = 2.4209
#A. spicatum    a = 2.3096   b = 2.2524
#B. lutea or alleghaniensis  a = 2.2264   b = 2.4150
#F. grandifolia  a = 2.2916  b = 2.3916
#P. rubens      a = 2.3151   b = 2.1830
#low-elevation  a = 2.2380   b = 2.4223

###SM
overten.snag.SM.whit <- overten.snag[overten.snag$spp == "SM", ]
overten.snag.SM.whit$agb = 2.2151 + 2.4209*log10(overten.snag.SM.whit$dbh)
###STM
overten.snag.STM.whit <- overten.snag[overten.snag$spp == "STM", ]
overten.snag.STM.whit$agb = 2.3096 + 2.2524*log10(overten.snag.STM.whit$dbh)
###YB
overten.snag.YB.whit <- overten.snag[overten.snag$spp == "YB", ]
overten.snag.YB.whit$agb = 2.2264 + 2.4150*log10(overten.snag.YB.whit$dbh)
###BE
overten.snag.BE.whit <- overten.snag[overten.snag$spp == "BE", ]
overten.snag.BE.whit$agb = 2.2916 + 2.3916*log10(overten.snag.BE.whit$dbh)
###RS
overten.snag.RS.whit <- overten.snag[overten.snag$spp == "RS", ]
overten.snag.RS.whit$agb = 2.3151 + 2.1830*log10(overten.snag.RS.whit$dbh)

###All other species
overten.snag.leftovers.whit <- overten.snag[-which(overten.snag$spp == "SM" |overten.snag$spp == "STM" | 
                                                       overten.snag$spp == "YB" |overten.snag$spp == "BE" | 
                                                       overten.snag$spp == "RS"), ]
overten.snag.leftovers.whit$agb = 2.2380 + 2.4223*log10(overten.snag.leftovers.whit$dbh)

###Combine all species
overten.snag.agb.whit <- rbind(overten.snag.SM.whit,
                                overten.snag.STM.whit,overten.snag.YB.whit,overten.snag.BE.whit,overten.snag.RS.whit,overten.snag.leftovers.whit)

###AGB g
overten.snag.agb.whit$agb.g <-  10^(overten.snag.agb.whit$agb)
###Agb kg
overten.snag.agb.whit$agb.kg <- overten.snag.agb.whit$agb.g/1000



###Calculate AGB (kg/ha) using Whittaker equations
###2021
overten.snag.agb.2021.whit <- overten.snag.agb.whit[which(overten.snag.agb.whit$year == "2021"),]
###Subset OG stands
og.agb.2021.whit.snag <- overten.snag.agb.2021.whit[which(overten.snag.agb.2021.whit$stand == "Bowl"| overten.snag.agb.2021.whit$stand == "Pond"),]
ogtransect.agb.kgha.2021.whit.snag <- og.agb.2021.whit.snag %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*14.1)
ogstandagb.kgha.2021.whit.snag <- ogtransect.agb.kgha.2021.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/5)

ogstandagb.kgha.2021.whit.snag$standagb.Mgha <- ogstandagb.kgha.2021.whit.snag$standagb.kgha/1000

###With species
ogtransect.agb.kgha.spp.2021.whit.snag <- og.agb.2021.whit.snag %>%
  group_by(year, stand, age, transect, spp) %>%
  summarise(transectagb.kgha = sum(agb.kg)*14.1)
ogstandagb.kgha.spp.2021.whit.snag <- ogtransect.agb.kgha.spp.2021.whit.snag %>%
  group_by(year, stand, age, spp) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/5)

###Subset "normal" stands
normies.agb.2021.whit.snag <- overten.snag.agb.2021.whit[which(overten.snag.agb.2021.whit$stand == "H2"| 
                                                             overten.snag.agb.2021.whit$stand == "H3"| overten.snag.agb.2021.whit$stand == "H4"| 
                                                             overten.snag.agb.2021.whit$stand == "H5"| overten.snag.agb.2021.whit$stand == "H6"| 
                                                             overten.snag.agb.2021.whit$stand == "M3"| overten.snag.agb.2021.whit$stand == "M6"| overten.snag.agb.2021.whit$stand == "HB101"),]
###Calculate Kg/ha for each transect, then average for the stand
normiestransect.agb.kg.ha.2021.whit.snag <- normies.agb.2021.whit.snag %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*20)
###Average for each stand
normiesstand.agb.kgha.2021.whit.snag <- normiestransect.agb.kg.ha.2021.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/5)

normiesstand.agb.kgha.2021.whit.snag$standagb.Mgha <- normiesstand.agb.kgha.2021.whit.snag$standagb.kgha/1000




###Subset stands with 5A and 5B transects due to skid trails 
skids.agb.2021.whit.snag <- overten.snag.agb.2021.whit[which(overten.snag.agb.2021.whit$stand == "M4"| overten.snag.agb.2021.whit$stand == "M5" | 
                                                           overten.snag.agb.2021.whit$stand == "T20" | overten.snag.agb.2021.whit$stand == "T30"),]
###Calculate BA/ha for each transect, then average for the stand
skidstransect1234.agb.kg.ha.2021.whit.snag <- skids.agb.2021.whit.snag[which(skids.agb.2021.whit.snag$transect == "L1" | skids.agb.2021.whit.snag$transect == "L2" | 
                                                                     skids.agb.2021.whit.snag$transect == "L3" | skids.agb.2021.whit.snag$transect == "L4"),] %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*20)
skidstransect5.agb.kg.ha.2021.whit.snag <- skids.agb.2021.whit.snag[which(skids.agb.2021.whit.snag$transect == "L5A" | skids.agb.2021.whit.snag$transect == "L5B"),] %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = (sum(agb.kg)*40))
skidstransect.agb.kg.ha.2021.whit.snag <- rbind(skidstransect1234.agb.kg.ha.2021.whit.snag, skidstransect5.agb.kg.ha.2021.whit.snag)

skidsstand.agb.kg.ha.2021.whit.snag <- skidstransect.agb.kg.ha.2021.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/6)

skidsstand.agb.kg.ha.2021.whit.snag$standagb.Mgha <- skidsstand.agb.kg.ha.2021.whit.snag$standagb.kgha/1000


###Subset smaller stands
smalls.agb.2021.whit.snag <- overten.snag.agb.2021.whit[which(overten.snag.agb.2021.whit$stand == "H1"| overten.snag.agb.2021.whit$stand == "CC2"),]
###Calculate BA/ha for each transect, then average for the stand
smallstransect.agb.kg.ha.2021.whit.snag <- smalls.agb.2021.whit.snag %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*66.7)
smallsstand.agb.kg.ha.2021.whit.snag <- smallstransect.agb.kg.ha.2021.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/5)

smallsstand.agb.kg.ha.2021.whit.snag$standagb.Mgha <- smallsstand.agb.kg.ha.2021.whit.snag$standagb.kgha/1000

###Combine all stands 
allagb.2021.whit.snag <- rbind(normiesstand.agb.kgha.2021.whit.snag, skidsstand.agb.kg.ha.2021.whit.snag, smallsstand.agb.kg.ha.2021.whit.snag, ogstandagb.kgha.2021.whit.snag)

###Calculate SE
###OG
ogagb_se.2021.whit.snag <- ogtransect.agb.kgha.2021.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(5))
###Normies
normiesagb_se.2021.whit.snag <- normiestransect.agb.kg.ha.2021.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(5))
###Skids
skidsagb_se.2021.whit.snag <- skidstransect.agb.kg.ha.2021.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(6))
###Smaller stands
smallsagb_se.2021.whit.snag <- smallstransect.agb.kg.ha.2021.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(5))
###Combine all stands 
allagb_se.2021.whit.snag <- rbind(ogagb_se.2021.whit.snag, normiesagb_se.2021.whit.snag, skidsagb_se.2021.whit.snag, smallsagb_se.2021.whit.snag)
allagb_se.2021.whit.snag$se.mgha <- allagb_se.2021.whit.snag$se.kgha/1000
###Combine SE and AGB Mg/ha
all.agb.2021.whit.snag <- left_join(allagb.2021.whit.snag, allagb_se.2021.whit.snag, by = c("year", "stand", "age"))

###Re-order stands
all.agb.2021.whit.snag$stand <- factor(all.agb.2021.whit.snag$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))
###Change age of Bowl and Pond to 180
all.agb.2021.whit.snag$age[all.agb.2021.whit.snag$stand == "Bowl" | all.agb.2021.whit.snag$stand == "Pond"] <- 180


###2012
overten.snag.agb.2012.whit <- overten.snag.agb.whit[which(overten.snag.agb.whit$year == "2012"),]
###Subset "normal" stands
normies.agb.2012.whit.snag <- overten.snag.agb.2012.whit[which(overten.snag.agb.2012.whit$stand == "H2"| 
                                                             overten.snag.agb.2012.whit$stand == "H3"| overten.snag.agb.2012.whit$stand == "H4"| 
                                                             overten.snag.agb.2012.whit$stand == "H5"| overten.snag.agb.2012.whit$stand == "H6"| 
                                                             overten.snag.agb.2012.whit$stand == "M3"| overten.snag.agb.2012.whit$stand == "M6"| overten.snag.agb.2012.whit$stand == "HB101"),]
###Calculate Kg/ha for each transect, then average for the stand
normiestransect.agb.kg.ha.2012.whit.snag <- normies.agb.2012.whit.snag %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*20)
###Average for each stand
normiesstand.agb.kgha.2012.whit.snag <- normiestransect.agb.kg.ha.2012.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/5)

normiesstand.agb.kgha.2012.whit.snag$standagb.Mgha <- normiesstand.agb.kgha.2012.whit.snag$standagb.kgha/1000




###Subset stands with 5A and 5B transects due to skid trails 
skids.agb.2012.whit.snag <- overten.snag.agb.2012.whit[which(overten.snag.agb.2012.whit$stand == "M4"| overten.snag.agb.2012.whit$stand == "M5" | 
                                                           overten.snag.agb.2012.whit$stand == "T20" | overten.snag.agb.2012.whit$stand == "T30"),]
###Calculate BA/ha for each transect, then average for the stand
skidstransect1234.agb.kg.ha.2012.whit.snag <- skids.agb.2012.whit.snag[which(skids.agb.2012.whit.snag$transect == "L1" | skids.agb.2012.whit.snag$transect == "L2" | 
                                                                     skids.agb.2012.whit.snag$transect == "L3" | skids.agb.2012.whit.snag$transect == "L4"),] %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*20)
skidstransect5.agb.kg.ha.2012.whit.snag <- skids.agb.2012.whit.snag[which(skids.agb.2012.whit.snag$transect == "L5A" | skids.agb.2012.whit.snag$transect == "L5B"),] %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = (sum(agb.kg)*40))
skidstransect.agb.kg.ha.2012.whit.snag <- rbind(skidstransect1234.agb.kg.ha.2012.whit.snag, skidstransect5.agb.kg.ha.2012.whit.snag)

skidsstand.agb.kg.ha.2012.whit.snag <- skidstransect.agb.kg.ha.2012.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/6)

skidsstand.agb.kg.ha.2012.whit.snag$standagb.Mgha <- skidsstand.agb.kg.ha.2012.whit.snag$standagb.kgha/1000


###Subset smaller stands
smalls.agb.2012.whit.snag <- overten.snag.agb.2012.whit[which(overten.snag.agb.2012.whit$stand == "H1"| overten.snag.agb.2012.whit$stand == "CC2"),]
###Calculate BA/ha for each transect, then average for the stand
smallstransect.agb.kg.ha.2012.whit.snag <- smalls.agb.2012.whit.snag %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*66.7)
smallsstand.agb.kg.ha.2012.whit.snag <- smallstransect.agb.kg.ha.2012.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/5)

smallsstand.agb.kg.ha.2012.whit.snag$standagb.Mgha <- smallsstand.agb.kg.ha.2012.whit.snag$standagb.kgha/1000

###Combine all stands 
allagb.2012.whit.snag <- rbind(normiesstand.agb.kgha.2012.whit.snag, skidsstand.agb.kg.ha.2012.whit.snag, smallsstand.agb.kg.ha.2012.whit.snag)

###Calculate SE
###Normies
normiesagb_se.2012.whit.snag <- normiestransect.agb.kg.ha.2012.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(5))
###Skids
skidsagb_se.2012.whit.snag <- skidstransect.agb.kg.ha.2012.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(6))
###Smaller stands
smallsagb_se.2012.whit.snag <- smallstransect.agb.kg.ha.2012.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(5))
###Combine all stands 
allagb_se.2012.whit.snag <- rbind(normiesagb_se.2012.whit.snag, skidsagb_se.2012.whit.snag, smallsagb_se.2012.whit.snag)
allagb_se.2012.whit.snag$se.mgha <- allagb_se.2012.whit.snag$se.kgha/1000
###Combine SE and AGB Mg/ha
all.agb.2012.whit.snag <- left_join(allagb.2012.whit.snag, allagb_se.2012.whit.snag, by = c("year", "stand", "age"))

###Re-order stands
all.agb.2012.whit.snag$stand <- factor(all.agb.2012.whit.snag$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))


###2004
overten.snag.agb.2004.whit <- overten.snag.agb.whit[which(overten.snag.agb.whit$year == "2004"),]

###Subset "normal" stands
normies.agb.2004.whit.snag <- overten.snag.agb.2004.whit[which(overten.snag.agb.2004.whit$stand == "H2"| 
                                                             overten.snag.agb.2004.whit$stand == "H3"| overten.snag.agb.2004.whit$stand == "H4"| 
                                                             overten.snag.agb.2004.whit$stand == "H5"| overten.snag.agb.2004.whit$stand == "H6"| 
                                                             overten.snag.agb.2004.whit$stand == "M3"| overten.snag.agb.2004.whit$stand == "M4"|
                                                             overten.snag.agb.2004.whit$stand == "M5" | overten.snag.agb.2004.whit$stand == "M6"| 
                                                             overten.snag.agb.2004.whit$stand == "HB101"| overten.snag.agb.2004.whit$stand == "T20" | overten.snag.agb.2004.whit$stand == "T30"),]
###Calculate Kg/ha for each transect, then average for the stand
normiestransect.agb.kg.ha.2004.whit.snag <- normies.agb.2004.whit.snag %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*20)
###Average for each stand
normiesstand.agb.kgha.2004.whit.snag <- normiestransect.agb.kg.ha.2004.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/5)

normiesstand.agb.kgha.2004.whit.snag$standagb.Mgha <- normiesstand.agb.kgha.2004.whit.snag$standagb.kgha/1000


###Subset smaller stands
smalls.agb.2004.whit.snag <- overten.snag.agb.2004.whit[which(overten.snag.agb.2004.whit$stand == "H1"| overten.snag.agb.2004.whit$stand == "CC2"),]
###Calculate BA/ha for each transect, then average for the stand
smallstransect.agb.kg.ha.2004.whit.snag <- smalls.agb.2004.whit.snag %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*66.7)
smallsstand.agb.kg.ha.2004.whit.snag <- smallstransect.agb.kg.ha.2004.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/5)

smallsstand.agb.kg.ha.2004.whit.snag$standagb.Mgha <- smallsstand.agb.kg.ha.2004.whit.snag$standagb.kgha/1000

###Combine all stands 
allagb.2004.whit.snag <- rbind(normiesstand.agb.kgha.2004.whit.snag, smallsstand.agb.kg.ha.2004.whit.snag)

###Calculate SE
###Normies
normiesagb_se.2004.whit.snag <- normiestransect.agb.kg.ha.2004.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(5))
###Smaller stands
smallsagb_se.2004.whit.snag <- smallstransect.agb.kg.ha.2004.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(5))
###Combine all stands 
allagb_se.2004.whit.snag <- rbind(normiesagb_se.2004.whit.snag, smallsagb_se.2004.whit.snag)
allagb_se.2004.whit.snag$se.mgha <- allagb_se.2004.whit.snag$se.kgha/1000
###Combine SE and AGB Mg/ha
all.agb.2004.whit.snag <- left_join(allagb.2004.whit.snag, allagb_se.2004.whit.snag, by = c("year", "stand", "age"))

###Re-order stands
all.agb.2004.whit.snag$stand <- factor(all.agb.2004.whit.snag$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))


###1994
overten.snag.agb.1994.whit <- overten.snag.agb.whit[which(overten.snag.agb.whit$year == "1994"),]

###Subset "normal" stands
normies.agb.1994.whit.snag <- overten.snag.agb.1994.whit[which(overten.snag.agb.1994.whit$stand == "H2"| 
                                                             overten.snag.agb.1994.whit$stand == "H3"| overten.snag.agb.1994.whit$stand == "H4"| 
                                                             overten.snag.agb.1994.whit$stand == "H5"| overten.snag.agb.1994.whit$stand == "H6"| 
                                                             overten.snag.agb.1994.whit$stand == "M3"| overten.snag.agb.1994.whit$stand == "M4"|
                                                             overten.snag.agb.1994.whit$stand == "M5" | overten.snag.agb.1994.whit$stand == "M6"| 
                                                             overten.snag.agb.1994.whit$stand == "HB101"| overten.snag.agb.1994.whit$stand == "T20" | overten.snag.agb.1994.whit$stand == "T30"),]
###Calculate Kg/ha for each transect, then average for the stand
normiestransect.agb.kg.ha.1994.whit.snag <- normies.agb.1994.whit.snag %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*20)
###Average for each stand
normiesstand.agb.kgha.1994.whit.snag <- normiestransect.agb.kg.ha.1994.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/5)

normiesstand.agb.kgha.1994.whit.snag$standagb.Mgha <- normiesstand.agb.kgha.1994.whit.snag$standagb.kgha/1000


###Subset smaller stands
smalls.agb.1994.whit.snag <- overten.snag.agb.1994.whit[which(overten.snag.agb.1994.whit$stand == "H1"),]
###Calculate BA/ha for each transect, then average for the stand
smallstransect.agb.kg.ha.1994.whit.snag <- smalls.agb.1994.whit.snag %>%
  group_by(year, stand, age, transect) %>%
  summarise(transectagb.kgha = sum(agb.kg)*66.7)
smallsstand.agb.kg.ha.1994.whit.snag <- smallstransect.agb.kg.ha.1994.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(standagb.kgha = sum(transectagb.kgha)/5)

smallsstand.agb.kg.ha.1994.whit.snag$standagb.Mgha <- smallsstand.agb.kg.ha.1994.whit.snag$standagb.kgha/1000

###Combine all stands 
allagb.1994.whit.snag <- rbind(normiesstand.agb.kgha.1994.whit.snag, smallsstand.agb.kg.ha.1994.whit.snag)

###Calculate SE
###Normies
normiesagb_se.1994.whit.snag <- normiestransect.agb.kg.ha.1994.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(5))
###Smaller stands
smallsagb_se.1994.whit.snag <- smallstransect.agb.kg.ha.1994.whit.snag %>%
  group_by(year, stand, age) %>%
  summarise(se.kgha = sd(transectagb.kgha)/sqrt(5))
###Combine all stands 
allagb_se.1994.whit.snag <- rbind(normiesagb_se.1994.whit.snag, smallsagb_se.1994.whit.snag)
allagb_se.1994.whit.snag$se.mgha <- allagb_se.1994.whit.snag$se.kgha/1000
###Combine SE and AGB Mg/ha
all.agb.1994.whit.snag <- left_join(allagb.1994.whit.snag, allagb_se.1994.whit.snag, by = c("year", "stand", "age"))

###Re-order stands
all.agb.1994.whit.snag$stand <- factor(all.agb.1994.whit.snag$stand, levels = c("H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))

###Combine all years
all.agb.whit.snag <- rbind(all.agb.1994.whit.snag, all.agb.2004.whit.snag, all.agb.2012.whit.snag, all.agb.2021.whit.snag)
all.agb.whit.snag$stand <- factor(all.agb.whit.snag$stand, levels = c("CC2", "H6", "M6", "M5", "HB101", "H5", "T20", "M4", "T30", "H1", "H4", "M3", "H2", "H3", "Bowl", "Pond"))
###Change age of Bowl and Pond to 180
all.agb.whit.snag$age[all.agb.whit.snag$stand == "Bowl" | all.agb.whit.snag$stand == "Pond"] <- 180

```


```{r}
snag_agb_2021 <- all.agb.whit.snag %>% filter(year == "2021")
```



###Progression of standing dead Above Ground Biomass Whittaker
```{r}
ggplot(data = all.agb.whit.snag, aes(x = age, y = standagb.Mgha, group = stand, color = factor(year), label = stand)) + 
  geom_point(size = 2) + 
  geom_errorbar(aes(ymin=ifelse(standagb.Mgha-se.mgha< 0, 0,standagb.Mgha-se.mgha), ymax=standagb.Mgha+se.mgha), size = 1.2, position = position_dodge()) + 
  geom_line(size = 1.2, color = "black") + 
 geom_label_repel(data = snag_agb_2021, aes(label = stand), size = 8, color = "black", label.padding = .08, box.padding = 0.1) + 
  labs(x = "Stand Age", y = "Standind dead aboveground biomass (Mg/ha)", color = "Sampling year") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,200)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 150)) + 
  scale_color_manual(values = year.colors) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 20, color = "black")) + 
  theme(axis.title.y = element_text(size = 20, color = "black")) + 
  theme(axis.text.x = element_text(size = 20, color = "black")) + 
  theme(axis.text.y = element_text(size = 20, color = "black")) + 
  theme(legend.text = element_text(size = 20, color = "black")) + 
  theme(legend.title = element_text(size = 20, color = "black")) + 
  theme(panel.border = element_rect(fill = NA)) + 
  annotate("text", x = 160, y = 0, label = "~", size = 5, angle = 90) +
  annotate("text", x = 170, y = 0, label = "~", size = 5, angle = 90) +
  annotation_custom(segmentsGrob(gp = gpar(col = "black", lwd = 1)), xmin = 180, xmax = 180, ymin = 0, ymax = -1) +
  annotation_custom(textGrob("Uncut", gp = gpar(col = "black", fontsize = 20)), xmin = 180, xmax = 180, ymin = -3, ymax = -3) + 
  coord_cartesian(clip = "off")

```

###########         ##########      
######                  ######      
####                      ####    
##        O      O          ##     
#                            #    
##                          ##   
###       ---------        ###  
######                  ###### 
##########          ##########
######                  ######      
####                      ####      
##        X       X         ##     
#                            #     
##                          ##  
###       ---------        ###  
######                  ###### 
##########          ##########
###Ratio of Live to Dead Biomass
###Combine 
```{r}
View(all.agb.whit.snag[which(all.agb.whit.snag$year == "2004"| all.agb.whit.snag$year == "2020"),])

View(total.biomass)

left_join(all.agb.whit.snag, total.biomass, by = c("year", "stand", "age"))

```

###Join live and dead data and calculate ratio of dead to live biomass
```{r}
total.agb<- left_join(all.agb.whit, all.agb.whit.snag, by = c("year", "stand", "age"))
total.agb$total.standagb.Mgha <- total.agb$standagb.Mgha.x + total.agb$standagb.Mgha.y
total.agb$dead.total.ratio <- total.agb$standagb.Mgha.y/total.agb$standagb.Mgha.x
total.agb$standage <- paste(total.agb$stand, total.agb$age)
```

###Plot ratio of dead to live biomass
```{r}
ggplot(data = total.agb, aes(x = age, y = dead.total.ratio, group = stand, color = stand)) + 
  geom_point(size = 2) + 
  geom_line(size = 1.2) + 
  labs(x = "stand Age", y = "Ratio of Standing Dead to Total Standing Biomass (Mg/ha)", color = "stand") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,200)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.5)) + 
  scale_color_manual(values = standcolors) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 15)) + 
  theme(axis.title.y = element_text(size = 15)) + 
  theme(axis.text.x = element_text(size = 15)) + 
  theme(axis.text.y = element_text(size = 15)) + 
  theme(legend.text = element_text(size = 15)) + 
  theme(legend.title = element_text(size = 15)) + 
  theme(panel.border = element_rect(fill = NA)) + 
  annotate("text", x = 160, y = 0, label = "~", size = 5, angle = 90) +
  annotate("text", x = 170, y = 0, label = "~", size = 5, angle = 90) +
  annotation_custom(segmentsGrob(gp = gpar(col = "black", lwd = 1)), xmin = 180, xmax = 180, ymin = 0, ymax = -0.002) +
  annotation_custom(textGrob("Uncut", gp = gpar(col = "black", fontsize = 15)), xmin = 180, xmax = 180, ymin = -0.02, ymax = -0.02) + 
  coord_cartesian(clip = "off")

agb.for.ratio <- all.agb.whit[-which(all.agb.whit$year == "1994"|all.agb.whit$year == "2012" ),]
agb.for.ratio$year[agb.for.ratio$year == 2021] <- 2020
agb.for.ratio.2004 <- agb.for.ratio[agb.for.ratio$year == "2004",]
agb.for.ratio.2004$age[agb.for.ratio.2004$stand == "H4"] <- 70
agb.for.ratio.2020 <- agb.for.ratio[agb.for.ratio$year == "2020",]
colnames(agb.for.ratio.2020) <- c("year", "stand", "age.2021", "standagb.kgha", "standagb.Mgha", "se.kgha", "se.mgha")
agb.for.ratio.2020$age <- agb.for.ratio.2020$age.2021 -1
agb.for.ratio.2020$age[agb.for.ratio.2020$stand == "H4"] <- 86
agb.for.ratio.2020$age[agb.for.ratio.2020$stand == "Bowl"] <- 180
agb.for.ratio.2020$age[agb.for.ratio.2020$stand == "Pond"] <- 180

agb.for.ratio.ready <- rbind(agb.for.ratio.2004,agb.for.ratio.2020 )

downed.to.alive<- left_join(agb.for.ratio.ready, total.biomass, by = c("year", "stand", "age"))
downed.to.alive$ratio <-downed.to.alive$total/downed.to.alive$standagb.Mgha

ggplot(data = downed.to.alive, aes(x = age, y = ratio, group = stand, color = factor(year))) + 
  geom_point(size = 3) + 
  geom_line(size = 1.2, color = "black") + 
  labs(x = "Stand Age", y = "Ratio of downed wood to total standing biomass (Mg/ha)", color = "Sampling year") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,200)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.18)) + 
  scale_color_manual(values = dwd.year.colors) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(panel.background = element_blank()) + 
  theme(axis.line = element_line(colour = "black")) + 
  theme(panel.spacing.x = unit(0, "lines")) + 
  theme(legend.key = element_blank()) + 
  theme(axis.title.x = element_text(size = 20, color = "black")) + 
  theme(axis.title.y = element_text(size = 20, color = "black")) + 
  theme(axis.text.x = element_text(size = 20, color = "black")) + 
  theme(axis.text.y = element_text(size = 20, color = "black")) + 
  theme(legend.text = element_text(size = 20, color = "black")) + 
  theme(legend.title = element_text(size = 20, color = "black")) + 
  theme(panel.border = element_rect(fill = NA)) + 
  annotate("text", x = 160, y = 0, label = "~", size = 5, angle = 90) +
  annotate("text", x = 170, y = 0, label = "~", size = 5, angle = 90) +
  annotation_custom(segmentsGrob(gp = gpar(col = "black", lwd = 1)), xmin = 180, xmax = 180, ymin = 0, ymax = -0.002) +
  annotation_custom(textGrob("Uncut", gp = gpar(col = "black", fontsize = 20)), xmin = 180, xmax = 180, ymin = -0.005, ymax = -0.005) + 
  coord_cartesian(clip = "off")

```






